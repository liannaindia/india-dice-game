<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Panel</title>
  <script type="module" src="./supabase-config-admin.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root{
      --primary:#007bff;
      --bg1:#f8f9fa;
      --bg2:#e3f2fd;
      --card:#ffffff;
      --text:#222;
      --muted:#666;
      --sidebar:#0f172a;
      --sidebar-text:#e2e8f0;
      --sidebar-active:#1d4ed8;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:'Poppins',sans-serif;background:linear-gradient(to right,var(--bg1),var(--bg2));color:var(--text)}
    h2,h3{margin:0 0 12px}
    .login-wrap{max-width:420px;margin:48px auto;padding:24px;border-radius:12px;background:var(--card);box-shadow:0 4px 10px rgba(0,0,0,.08)}
    input,button,textarea,select{
      width:100%;padding:12px;margin-top:10px;font-size:16px;border-radius:8px;border:1px solid #d1d5db;background:#fff
    }
    button{background:var(--primary);color:#fff;font-weight:600;cursor:pointer;border:none}
    button:hover{filter:brightness(.95)}
    .hidden{display:none}

    .layout{display:flex;min-height:100vh}
    .sidebar{
      width:240px;background:var(--sidebar);color:var(--sidebar-text);
      padding:16px 12px;height:auto;
    }
    .brand{display:flex;gap:10px;align-items:center;color:#fff;font-weight:700;margin:8px 8px 16px}
    .menu{display:flex;flex-direction:column;gap:6px;margin-top:8px}
    .menu button{
      width:100%;text-align:left;background:transparent;border:1px solid transparent;color:var(--sidebar-text);
      padding:10px 12px;border-radius:10px
    }
    .menu button:hover{background:rgba(255,255,255,.06)}
    .menu button.active{background:var(--sidebar-active);color:#fff}

    .content{flex:1;padding:20px;min-width:0}
    .card{background:var(--card);padding:18px;border-radius:12px;box-shadow:0 4px 10px rgba(0,0,0,.08);margin-bottom:16px;}
    .request-box{background:#f1f8e9;padding:12px;border-radius:8px;margin-top:10px}
    .btn-group{display:flex;gap:10px;margin-top:10px}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{padding:8px 6px;border-bottom:1px solid #eee;text-align:left;font-size:14px}
    th{color:#333}
    .row{display:flex;gap:10px}
    .row > *{flex:1}
    .toolbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-top:6px}
    .muted{color:var(--muted);font-size:12px}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
  </style>
</head>
<body>

  <!-- ç™»å½• -->
  <div id="login-section" class="login-wrap">
    <h2>ğŸ” Admin Login</h2>
    <input type="email" id="email" placeholder="Admin Email" />
    <input type="password" id="password" placeholder="Password" />
    <button id="login-btn">Login</button>
  </div>

  <!-- ä¸»ç•Œé¢ -->
  <div id="admin-layout" class="layout hidden">
    <aside class="sidebar">
      <div class="brand">ğŸ› ï¸ Admin Panel</div>
      <div class="menu">
        <button data-tab="bank" class="active">ğŸ¦ Bank Info</button>
        <button data-tab="recharge">ğŸ’³ Recharge Requests</button>
        <button data-tab="withdraw">ğŸ’¸ Withdraw Requests</button>
        <button data-tab="bets">ğŸ“œ Todayâ€™s Bets (IST)</button>
        <button data-tab="manual">ğŸ¯ Manual Result</button>
        <!-- æ–°å¢ Users -->
        <button data-tab="users">ğŸ‘¥ Users</button>
      </div>
    </aside>

    <main class="content">
      <!-- Bank -->
      <section id="tab-bank" class="tab">
        <div class="card">
          <h3>ğŸ¦ Bank Info</h3>
          <div class="row">
            <input id="name"  placeholder="Name"/>
            <input id="ac"    placeholder="Account Number"/>
          </div>
          <div class="row">
            <input id="ifsc"  placeholder="IFSC Code"/>
            <input id="upi"   placeholder="UPI ID"/>
          </div>
          <input id="crypto" placeholder="Crypto Address"/>
          <button id="save-bank-btn">Save</button>
        </div>
      </section>

      <!-- Recharge -->
      <section id="tab-recharge" class="tab hidden">
        <div class="card">
          <h3>ğŸ’³ Recharge Requests</h3>
          <div id="recharge-requests">Loading...</div>
        </div>
      </section>

      <!-- Withdraw -->
      <section id="tab-withdraw" class="tab hidden">
        <div class="card">
          <h3>ğŸ’¸ Withdraw Requests</h3>
          <div id="withdraw-requests">Loading...</div>
        </div>
      </section>

      <!-- Bets Today -->
      <section id="tab-bets" class="tab hidden">
        <div class="card">
          <h3>ğŸ“œ Todayâ€™s Bets (IST)</h3>
          <div class="toolbar">
            <input id="bet-email-filter" placeholder="Filter by email (optional)" style="max-width:320px"/>
            <button id="bets-reload" style="width:auto">Reload</button>
          </div>
          <div id="today-bets" style="margin-top:8px">Loading...</div>
        </div>
      </section>

      <!-- Manual Result -->
      <section id="tab-manual" class="tab hidden">
        <div class="card">
          <h3>ğŸ¯ Manual Result Setter</h3>
          <div class="row">
            <input id="manual-round" class="mono" placeholder="Round Number (e.g. 202508081430)" />
            <input id="manual-result" type="number" min="1" max="6" placeholder="Result (1-6)" />
          </div>
          <button id="set-result-btn">Set Result</button>
          <p class="muted" style="margin-top:8px">
            è‹¥è¯¥æœŸå·²å­˜åœ¨ï¼Œå°†ç›´æ¥ <b>æ›´æ–°</b> ç»“æœå¹¶æ ‡è®°ä¸º <code>is_manual=true</code>ï¼Œè‡ªåŠ¨å¼€å¥–ä¸ä¼šè¦†ç›–ã€‚
          </p>
        </div>
      </section>

      <!-- Users -->
      <section id="tab-users" class="tab hidden">
        <div class="card">
          <h3>ğŸ‘¥ Users</h3>
          <div class="toolbar">
            <input id="users-email-filter" placeholder="Filter by email (optional)" style="max-width:320px"/>
            <button id="users-reload" style="width:auto">Reload</button>
          </div>
          <div id="users-table" style="margin-top:8px">Loading...</div>
        </div>
      </section>
    </main>
  </div>

  <script type="module">
    import { supabase } from './supabase-config-admin.js';

    // ---------- ç™»å½• ----------
    const loginSection = document.getElementById('login-section');
    const adminLayout  = document.getElementById('admin-layout');

    document.getElementById('login-btn').onclick = async () => {
      const email = (document.getElementById('email').value || '').trim();
      const password = document.getElementById('password').value;
      const { data, error } = await supabase.auth.signInWithPassword({ email, password });
      if (error) return alert('Login failed: ' + error.message);
      if (data.user.email !== 'admin@gmail.com') {
        alert('Not authorized');
        return;
      }
      loginSection.classList.add('hidden');
      adminLayout.classList.remove('hidden');
      initTabs();
      loadAll();
    };

    // ---------- Tab åˆ‡æ¢ ----------
    function initTabs(){
      const buttons = document.querySelectorAll('.menu button');
      buttons.forEach(btn=>{
        btn.onclick = ()=>{
          buttons.forEach(b=>b.classList.remove('active'));
          btn.classList.add('active');
          const tab = btn.getAttribute('data-tab');
          document.querySelectorAll('.tab').forEach(sec=>sec.classList.add('hidden'));
          document.getElementById('tab-' + tab).classList.remove('hidden');
          if (tab==='recharge') loadRechargeRequests();
          if (tab==='withdraw') loadWithdrawRequests();
          if (tab==='bets')     loadTodayBets();
          if (tab==='users')    loadUsers(); // æ–°å¢
        };
      });
    }

    // ---------- åˆå§‹åŒ–æ•°æ® ----------
    async function loadAll() {
      const { data } = await supabase.from('bank_info').select('*').eq('id', 1).single();
      if (data) {
        document.getElementById('name').value   = data.name || '';
        document.getElementById('ac').value     = data.ac || '';
        document.getElementById('ifsc').value   = data.ifsc || '';
        document.getElementById('upi').value    = data.upi || '';
        document.getElementById('crypto').value = data.crypto_address || '';
      }
      loadRechargeRequests();
      loadWithdrawRequests();
      loadTodayBets();
      // Users åœ¨è¿›å…¥æ ‡ç­¾æ—¶åŠ è½½
    }

    document.getElementById('save-bank-btn').onclick = async () => {
      const update = {
        id: 1,
        name:   document.getElementById('name').value,
        ac:     document.getElementById('ac').value,
        ifsc:   document.getElementById('ifsc').value,
        upi:    document.getElementById('upi').value,
        crypto_address: document.getElementById('crypto').value
      };
      const { error } = await supabase.from('bank_info').upsert(update);
      if (error) alert(error.message); else alert('Saved!');
    };

    // ---------- Recharge ----------
    async function loadRechargeRequests() {
      const container = document.getElementById('recharge-requests');
      const { data, error } = await supabase.from('recharge_requests').select('*').order('created_at', { ascending: false });
      if (error) { container.textContent = 'Failed to load'; return; }
      container.innerHTML = '';
      for (const item of data) {
        const el = document.createElement('div');
        el.className = 'request-box';
        el.innerHTML = `
          <b>${item.email || item.user_id}</b><br/>
          UTR: ${item.utr}<br/>
          Amount: â‚¹${item.amount}<br/>
          Status: ${item.status || 'pending'}
          ${
            item.status === 'pending'
              ? `<div class="btn-group">
                   <button onclick="handleApproveRecharge('${item.id}', '${item.user_id}', ${item.amount})">âœ… Allow</button>
                   <button onclick="handleRejectRecharge('${item.id}')">âŒ Reject</button>
                 </div>`
              : ''
          }
        `;
        container.appendChild(el);
      }
    }

    // ---------- Withdraw ----------
    async function loadWithdrawRequests() {
      const container = document.getElementById('withdraw-requests');
      const { data, error } = await supabase
        .from('withdraw_requests')
        .select('*')
        .order('created_at', { ascending: false });

      if (error) { container.textContent = 'Failed to load'; return; }
      container.innerHTML = '';

      if (!data || data.length === 0) {
        container.textContent = 'No withdraw requests.';
        return;
      }

      const userIds = [...new Set(data.map(r => r.user_id).filter(Boolean))];
      let userMap = {};
      if (userIds.length) {
        const { data: users } = await supabase
          .from('users')
          .select('id, email, name, ac, ifsc, upi')
          .in('id', userIds);
        (users || []).forEach(u => { userMap[u.id] = u; });
      }

      for (const item of data) {
        const u = userMap[item.user_id] || {};
        const el = document.createElement('div');
        el.className = 'request-box';
        el.innerHTML = `
          <div><b>${u.email || item.email || item.user_id}</b></div>
          <div>Amount: â‚¹${item.amount}</div>
          <div>Status: ${item.status || 'pending'}</div>
          <div class="muted" style="margin-top:6px">Saved Withdraw Info:</div>
          <div class="mono" style="font-size:13px">
            Name: ${u.name || '-'}<br/>
            AC: ${u.ac || '-'}<br/>
            IFSC: ${u.ifsc || '-'}<br/>
            UPI: ${u.upi || '-'}
          </div>
          ${
            item.status === 'pending'
              ? `<div class="btn-group">
                   <button onclick="handleApproveWithdraw('${item.id}', '${item.user_id}', ${item.amount})">âœ… Allow</button>
                   <button onclick="handleRejectWithdraw('${item.id}')">âŒ Reject</button>
                 </div>`
              : ''
          }
        `;
        container.appendChild(el);
      }
    }

    // ---------- Approve/Reject handlers ----------
    window.handleApproveRecharge = async (id, user_id, amount) => {
      try {
        await supabase.from('recharge_requests').update({ status: 'approved' }).eq('id', id);
        const { data: userDataArray, error: userError } = await supabase.from('users').select('balance').eq('id', user_id).limit(1);
        if (userError) throw userError;
        const userData = userDataArray?.[0];
        if (!userData) throw new Error('User not found');

        const newBalance = (userData.balance || 0) + amount;
        await supabase.from('users').update({ balance: newBalance }).eq('id', user_id);

        alert('Recharge approved and balance updated!');
        loadRechargeRequests();
      } catch (err) {
        alert('Failed: ' + err.message);
      }
    };
    window.handleRejectRecharge = async (id) => {
      await supabase.from('recharge_requests').update({ status: 'rejected' }).eq('id', id);
      alert('Recharge rejected.');
      loadRechargeRequests();
    };

    window.handleApproveWithdraw = async (id, user_id, amount) => {
      try {
        await supabase.from('withdraw_requests').update({ status: 'approved' }).eq('id', id);
        const { data: userDataArray, error: userError } = await supabase.from('users').select('balance').eq('id', user_id).limit(1);
        if (userError) throw userError;
        const userData = userDataArray?.[0];
        if (!userData) throw new Error('User not found');

        const currentBalance = userData.balance || 0;
        if (currentBalance < amount) throw new Error('Insufficient balance');

        const newBalance = currentBalance - amount;
        await supabase.from('users').update({ balance: newBalance }).eq('id', user_id);

        alert('Withdrawal approved and balance deducted!');
        loadWithdrawRequests();
      } catch (err) {
        alert('Failed: ' + err.message);
      }
    };
    window.handleRejectWithdraw = async (id) => {
      await supabase.from('withdraw_requests').update({ status: 'rejected' }).eq('id', id);
      alert('Withdraw rejected.');
      loadWithdrawRequests();
    };

    // ---------- Todayâ€™s Bets (IST) ----------
    function getISTDayRangeUTCISO() {
      const nowUtcMs = Date.now();
      const IST_OFFSET = 5.5 * 60 * 60 * 1000;
      const istNowMs = nowUtcMs + IST_OFFSET;
      const DAY = 24 * 60 * 60 * 1000;
      const startIstMs = istNowMs - (istNowMs % DAY);
      const endIstMs   = startIstMs + DAY;
      return {
        startUtcIso: new Date(startIstMs - IST_OFFSET).toISOString(),
        endUtcIso:   new Date(endIstMs   - IST_OFFSET).toISOString()
      };
    }
    async function loadTodayBets() {
      const container = document.getElementById('today-bets');
      const emailFilter = (document.getElementById('bet-email-filter').value || '').trim();

      const { startUtcIso, endUtcIso } = getISTDayRangeUTCISO();
      let q = supabase.from('bets')
        .select('created_at, email, user_id, round_number, bet_type, choice, amount, odds, status, payout')
        .gte('created_at', startUtcIso)
        .lt('created_at', endUtcIso)
        .order('created_at', { ascending: false })
        .limit(500);
      if (emailFilter) q = q.ilike('email', `%${emailFilter}%`);

      const { data, error } = await q;
      if (error) { container.textContent = 'Failed to load bets: ' + error.message; return; }
      if (!data || data.length === 0) { container.textContent = 'No bets today.'; return; }

      const rows = data.map(b=>{
        const humanBet =
          b.bet_type === 'number' ? `Number ${b.choice ?? '-'}` :
          b.bet_type === 'big' ? 'Big (4-6)' : 'Small (1-3)';
        const ts = new Date(b.created_at).toLocaleString();
        return `
          <tr>
            <td>${b.email || b.user_id}</td>
            <td>${b.round_number}</td>
            <td>${humanBet}</td>
            <td>â‚¹${Number(b.amount||0).toFixed(2)}</td>
            <td>Ã—${Number(b.odds||0).toFixed(2)}</td>
            <td>${b.status}</td>
            <td>â‚¹${Number(b.payout||0).toFixed(2)}</td>
            <td>${ts}</td>
          </tr>
        `;
      }).join('');

      container.innerHTML = `
        <div style="overflow:auto;">
          <table>
            <thead>
              <tr>
                <th>User</th><th>Round</th><th>Bet</th><th>Amount</th>
                <th>Odds</th><th>Status</th><th>Payout</th><th>Time</th>
              </tr>
            </thead>
            <tbody>${rows}</tbody>
          </table>
        </div>
      `;
    }
    document.getElementById('bets-reload').onclick = loadTodayBets;

    // ---------- æ‰‹åŠ¨ç»“æœ ----------
    document.getElementById('set-result-btn').onclick = async () => {
      const round = document.getElementById('manual-round').value.trim();
      const result = parseInt(document.getElementById('manual-result').value);
      if (!round || isNaN(result) || result < 1 || result > 6) return alert('Invalid input');

      const { data: existing, error: fetchError } = await supabase
        .from('game_rounds').select('round_number').eq('round_number', round).maybeSingle();
      if (fetchError) return alert('Query failed: ' + fetchError.message);

      if (existing) {
        const { error: updateError } = await supabase
          .from('game_rounds').update({ result, is_manual: true }).eq('round_number', round);
        if (updateError) alert('Update failed: ' + updateError.message);
        else alert(`âœ… Updated result for ${round} = ${result}`);
      } else {
        const { error: insertError } = await supabase
          .from('game_rounds').insert([{ round_number: round, result, is_manual: true, created_at: new Date().toISOString() }]);
        if (insertError) alert('Insert failed: ' + insertError.message);
        else alert(`âœ… Inserted result for ${round} = ${result}`);
      }
    };

    // ---------- Users åˆ—è¡¨ + ä½™é¢/æ‰“ç é‡è°ƒæ•´ ----------
    async function loadUsers(){
      const container = document.getElementById('users-table');
      const emailFilter = (document.getElementById('users-email-filter').value || '').trim();

      let q = supabase.from('users')
        .select('id, email, balance, turnover_remaining, name, ac, ifsc, upi')
        .order('email', { ascending: true })
        .limit(1000);

      if (emailFilter) q = q.ilike('email', `%${emailFilter}%`);

      const { data, error } = await q;
      if (error) { container.textContent = 'Failed to load users: ' + error.message; return; }
      if (!data || data.length === 0) { container.textContent = 'No users.'; return; }

      const rows = data.map(u => `
        <tr>
          <td class="mono" style="font-size:12px">${u.id}</td>
          <td>${u.email || '-'}</td>
          <td>â‚¹${Number(u.balance||0).toFixed(2)}</td>
          <td>â‚¹${Number(u.turnover_remaining||0).toFixed(2)}</td>
          <td>${u.name || '-'}</td>
          <td>${u.ac || '-'}</td>
          <td>${u.ifsc || '-'}</td>
          <td>${u.upi || '-'}</td>
          <td>
            <div class="btn-group" style="display:flex;gap:6px;flex-wrap:wrap">
              <button style="width:auto" onclick="adjustBalance('${u.id}', 'add')">â• Add</button>
              <button style="width:auto;background:#ef4444" onclick="adjustBalance('${u.id}', 'sub')">â– Deduct</button>
            </div>
          </td>
        </tr>
      `).join('');

      container.innerHTML = `
        <div style="overflow:auto;">
          <table>
            <thead>
              <tr>
                <th>ID</th><th>Email</th><th>Balance</th><th>Turnover</th>
                <th>Name</th><th>AC</th><th>IFSC</th><th>UPI</th><th>Actions</th>
              </tr>
            </thead>
            <tbody>${rows}</tbody>
          </table>
        </div>
      `;
    }

    document.getElementById('users-reload').onclick = loadUsers;

    // ä½™é¢è°ƒæ•´ï¼ˆå¯é€‰æ‹©æ˜¯å¦åŒæ­¥è°ƒæ•´æ‰“ç é‡ï¼‰
    window.adjustBalance = async (user_id, action) => {
      let val = prompt(action === 'add' ? 'Enter amount to ADD:' : 'Enter amount to DEDUCT:');
      if (val === null) return;
      const amt = Number(val);
      if (!amt || amt <= 0) return alert('Invalid amount');

      const adjustRollover = confirm('Also adjust turnover requirement?');

      // è¯»å–å½“å‰ä½™é¢ä¸æ‰“ç é‡
      const { data: urow, error: rerr } = await supabase
        .from('users')
        .select('balance, turnover_remaining')
        .eq('id', user_id)
        .single();
      if (rerr) return alert('Load user failed: ' + rerr.message);

      let newBalance = Number(urow?.balance || 0);
      let newTurn    = Number(urow?.turnover_remaining || 0);

      if (action === 'add') {
        newBalance += amt;
        if (adjustRollover) newTurn += amt;
      } else {
        if (newBalance < amt) return alert('Balance would go negative');
        newBalance -= amt;
        if (adjustRollover) newTurn = Math.max(newTurn - amt, 0);
      }

      const { error: uperr } = await supabase
        .from('users')
        .update({ balance: newBalance, turnover_remaining: newTurn })
        .eq('id', user_id);
      if (uperr) return alert('Update failed: ' + uperr.message);

      alert('Updated.');
      loadUsers();
    };
  </script>
</body>
</html>
