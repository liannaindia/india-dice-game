<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Panel</title>
  <script type="module" src="./supabase-config-admin.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      margin: 0;
      background: linear-gradient(to right, #f8f9fa, #e3f2fd);
      padding: 20px;
    }
    .container { max-width: 900px; margin: auto; }
    h2 { text-align: center; color: #007bff; }
    .card {
      background: #fff; padding: 20px; border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1); margin-bottom: 20px;
    }
    input, button, textarea {
      width: 100%; padding: 12px; font-size: 16px; margin-top: 10px;
      border-radius: 8px; border: 1px solid #ccc;
    }
    button { background: #007bff; color: white; font-weight: bold; cursor: pointer; }
    button:hover { background: #0056b3; }
    .hidden { display: none; }
    .request-box {
      background: #f1f8e9; padding: 12px; margin-top: 12px; border-radius: 8px;
    }
    .btn-group { display: flex; gap: 10px; margin-top: 10px; }
    table { width: 100%; border-collapse: collapse; margin-top: 12px; }
    th, td { text-align: left; padding: 8px 6px; border-bottom: 1px solid #eee; font-size: 14px; }
    th { font-weight: 600; color: #333; }
    .row-actions { display:flex; gap:8px; }
    .flex { display:flex; gap:10px; align-items: center; }
    .w-40 { width: 40%; }
    .w-auto { width: auto; }
  </style>
</head>
<body>
  <div class="container">
    <h2>üîê admin Login</h2>

    <div class="card" id="login-section">
      <input type="email" id="email" placeholder="Admin Email" />
      <input type="password" id="password" placeholder="Password" />
      <button id="login-btn">Login</button>
    </div>

    <div id="admin-panel" class="hidden">
      <!-- Bank -->
      <div class="card">
        <h3>üè¶ Bank Info</h3>
        <input id="name" placeholder="Name" />
        <input id="ac" placeholder="Account Number" />
        <input id="ifsc" placeholder="IFSC Code" />
        <input id="upi" placeholder="UPI ID" />
        <input id="crypto" placeholder="Crypto Address" />
        <button id="save-bank-btn">Save</button>
      </div>

      <!-- Recharge -->
      <div class="card">
        <h3>üí≥ Recharge Requests</h3>
        <div id="recharge-requests">Loading...</div>
      </div>

      <!-- Withdraw -->
      <div class="card">
        <h3>üí∏ Withdraw Requests</h3>
        <div id="withdraw-requests">Loading...</div>
      </div>

      <!-- Today's Bets (IST) -->
      <div class="card">
        <h3>üìú Today‚Äôs Bets (IST)</h3>
        <div class="flex">
          <input id="bet-email-filter" class="w-40" placeholder="Filter by email (optional)" />
          <button id="bets-reload" class="w-auto">Reload</button>
        </div>
        <div id="today-bets">Loading...</div>
      </div>
    </div>
  </div>

  <script type="module">
    import { supabase } from './supabase-config-admin.js';

    const loginSection = document.getElementById('login-section');
    const adminPanel = document.getElementById('admin-panel');

    document.getElementById('login-btn').onclick = async () => {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      const { data, error } = await supabase.auth.signInWithPassword({ email, password });
      if (error) return alert('Login failed: ' + error.message);
      if (data.user.email !== 'admin@gmail.com') {
        alert('Not authorized');
        return;
      }
      loginSection.classList.add('hidden');
      adminPanel.classList.remove('hidden');
      loadAll();
    };

    async function loadAll() {
      // bank
      const { data } = await supabase.from('bank_info').select('*').eq('id', 1).single();
      if (data) {
        document.getElementById('name').value = data.name || '';
        document.getElementById('ac').value = data.ac || '';
        document.getElementById('ifsc').value = data.ifsc || '';
        document.getElementById('upi').value = data.upi || '';
        document.getElementById('crypto').value = data.crypto_address || '';
      }
      // lists
      loadRechargeRequests();
      loadWithdrawRequests();
      loadTodayBets();
    }

    document.getElementById('save-bank-btn').onclick = async () => {
      const update = {
        id: 1,
        name: document.getElementById('name').value,
        ac: document.getElementById('ac').value,
        ifsc: document.getElementById('ifsc').value,
        upi: document.getElementById('upi').value,
        crypto_address: document.getElementById('crypto').value
      };
      const { error } = await supabase.from('bank_info').upsert(update);
      if (error) alert(error.message); else alert('Saved!');
    };

    // ---------- Recharge ----------
    async function loadRechargeRequests() {
      const container = document.getElementById('recharge-requests');
      const { data, error } = await supabase.from('recharge_requests').select('*').order('created_at', { ascending: false });
      if (error) {
        container.textContent = 'Failed to load';
        return;
      }
      container.innerHTML = '';
      for (const item of data) {
        const el = document.createElement('div');
        el.className = 'request-box';
        el.innerHTML = `
          User: ${item.email || item.user_id}<br/>
          UTR: ${item.utr}<br/>
          Amount: ‚Çπ${item.amount}<br/>
          Status: ${item.status || 'pending'}
          ${
            item.status === 'pending'
              ? `<div class="btn-group">
                   <button onclick="handleApproveRecharge('${item.id}', '${item.user_id}', ${item.amount})">‚úÖ Allow</button>
                   <button onclick="handleRejectRecharge('${item.id}')">‚ùå Reject</button>
                 </div>`
              : ''
          }
        `;
        container.appendChild(el);
      }
    }

    // ---------- Withdraw ----------
    async function loadWithdrawRequests() {
      const container = document.getElementById('withdraw-requests');
      const { data, error } = await supabase.from('withdraw_requests').select('*').order('created_at', { ascending: false });
      if (error) {
        container.textContent = 'Failed to load';
        return;
      }
      container.innerHTML = '';
      for (const item of data) {
        const el = document.createElement('div');
        el.className = 'request-box';
        el.innerHTML = `
          User: ${item.email || item.user_id}<br/>
          Amount: ‚Çπ${item.amount}<br/>
          Status: ${item.status || 'pending'}
          ${
            item.status === 'pending'
              ? `<div class="btn-group">
                   <button onclick="handleApproveWithdraw('${item.id}', '${item.user_id}', ${item.amount})">‚úÖ Allow</button>
                   <button onclick="handleRejectWithdraw('${item.id}')">‚ùå Reject</button>
                 </div>`
              : ''
          }
        `;
        container.appendChild(el);
      }
    }

    // ---------- Approve/Reject handlers ----------
    window.handleApproveRecharge = async (id, user_id, amount) => {
      try {
        await supabase.from('recharge_requests').update({ status: 'approved' }).eq('id', id);
        const { data: userDataArray, error: userError } = await supabase
          .from('users')
          .select('balance')
          .eq('id', user_id)
          .limit(1);
        if (userError) throw userError;
        const userData = userDataArray?.[0];
        if (!userData) throw new Error('User not found');

        const newBalance = (userData.balance || 0) + amount;
        await supabase.from('users').update({ balance: newBalance }).eq('id', user_id);

        alert('Recharge approved and balance updated!');
        loadRechargeRequests();
      } catch (err) {
        alert('Failed: ' + err.message);
      }
    };

    window.handleRejectRecharge = async (id) => {
      await supabase.from('recharge_requests').update({ status: 'rejected' }).eq('id', id);
      alert('Recharge rejected.');
      loadRechargeRequests();
    };

    window.handleApproveWithdraw = async (id, user_id, amount) => {
      try {
        await supabase.from('withdraw_requests').update({ status: 'approved' }).eq('id', id);
        const { data: userDataArray, error: userError } = await supabase
          .from('users')
          .select('balance')
          .eq('id', user_id)
          .limit(1);
        if (userError) throw userError;
        const userData = userDataArray?.[0];
        if (!userData) throw new Error('User not found');

        const currentBalance = userData.balance || 0;
        if (currentBalance < amount) throw new Error('Insufficient balance');

        const newBalance = currentBalance - amount;
        await supabase.from('users').update({ balance: newBalance }).eq('id', user_id);

        alert('Withdrawal approved and balance deducted!');
        loadWithdrawRequests();
      } catch (err) {
        alert('Failed: ' + err.message);
      }
    };

    window.handleRejectWithdraw = async (id) => {
      await supabase.from('withdraw_requests').update({ status: 'rejected' }).eq('id', id);
      alert('Withdraw rejected.');
      loadWithdrawRequests();
    };

    // ---------- Today Bets (IST) ----------
    // ËÆ°ÁÆó‚ÄúÂΩìÂ§© IST‚ÄùÁöÑ UTC ISO Ëµ∑Ê≠¢Êó∂Èó¥ÔºåÈÅøÂÖçÊµèËßàÂô®Êú¨Âú∞Êó∂Âå∫Âπ≤Êâ∞
    function getISTDayRangeUTCISO() {
      const nowUtcMs = Date.now();
      const IST_OFFSET = 5.5 * 60 * 60 * 1000; // +5:30
      const istNowMs = nowUtcMs + IST_OFFSET;
      const DAY = 24 * 60 * 60 * 1000;
      const startIstMs = istNowMs - (istNowMs % DAY);     // ÂΩìÂ§© IST 00:00
      const endIstMs = startIstMs + DAY;                  // Ê¨°Êó• IST 00:00
      const startUtcIso = new Date(startIstMs - IST_OFFSET).toISOString();
      const endUtcIso   = new Date(endIstMs   - IST_OFFSET).toISOString();
      return { startUtcIso, endUtcIso };
    }

    async function loadTodayBets() {
      const container = document.getElementById('today-bets');
      const emailFilter = (document.getElementById('bet-email-filter').value || '').trim();

      const { startUtcIso, endUtcIso } = getISTDayRangeUTCISO();

      let q = supabase
        .from('bets')
        .select('created_at, email, user_id, round_number, bet_type, choice, amount, odds, status, payout')
        .gte('created_at', startUtcIso)
        .lt('created_at', endUtcIso)
        .order('created_at', { ascending: false })
        .limit(200);

      if (emailFilter) {
        // ÂåÖÂê´ÂåπÈÖçÔºà‰∏çÂå∫ÂàÜÂ§ßÂ∞èÂÜôÔºâ
        q = q.ilike('email', `%${emailFilter}%`);
      }

      const { data, error } = await q;
      if (error) {
        container.textContent = 'Failed to load bets: ' + error.message;
        return;
      }
      if (!data || data.length === 0) {
        container.textContent = 'No bets today.';
        return;
      }

      const rows = data.map(b => {
        const humanBet =
          b.bet_type === 'number' ? `Number ${b.choice ?? '-'}` :
          b.bet_type === 'big' ? 'Big (4-6)' : 'Small (1-3)';
        const payout = Number(b.payout || 0).toFixed(2);
        const amount = Number(b.amount || 0).toFixed(2);
        const odds = Number(b.odds || 0).toFixed(2);
        const ts = new Date(b.created_at).toLocaleString(); // ÊµèËßàÂô®Êú¨Âú∞ÊòæÁ§∫
        return `
          <tr>
            <td>${b.email || b.user_id}</td>
            <td>${b.round_number}</td>
            <td>${humanBet}</td>
            <td>‚Çπ${amount}</td>
            <td>√ó${odds}</td>
            <td>${b.status}</td>
            <td>‚Çπ${payout}</td>
            <td>${ts}</td>
          </tr>
        `;
      }).join('');

      container.innerHTML = `
        <div style="overflow:auto;">
          <table>
            <thead>
              <tr>
                <th>User</th>
                <th>Round</th>
                <th>Bet</th>
                <th>Amount</th>
                <th>Odds</th>
                <th>Status</th>
                <th>Payout</th>
                <th>Time</th>
              </tr>
            </thead>
            <tbody>${rows}</tbody>
          </table>
        </div>
      `;
    }

    document.getElementById('bets-reload').onclick = loadTodayBets;

  </script>
</body>
</html>
