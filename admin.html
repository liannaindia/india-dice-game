<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Panel</title>
  <script type="module" src="./supabase-config-admin.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      margin: 0;
      background: linear-gradient(to right, #f8f9fa, #e3f2fd);
      padding: 20px;
    }
    .container {
      max-width: 600px;
      margin: auto;
    }
    h2 {
      text-align: center;
      color: #007bff;
    }
    .card {
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    input, button, textarea {
      width: 100%;
      padding: 12px;
      font-size: 16px;
      margin-top: 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
    }
    button {
      background: #007bff;
      color: white;
      font-weight: bold;
      cursor: pointer;
    }
    button:hover {
      background: #0056b3;
    }
    .hidden { display: none; }
    .request-box {
      background: #f1f8e9;
      padding: 12px;
      margin-top: 12px;
      border-radius: 8px;
    }
    .btn-group {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>üîê admin Login</h2>
    <div class="card" id="login-section">
      <input type="email" id="email" placeholder="Admin Email" />
      <input type="password" id="password" placeholder="Password" />
      <button id="login-btn">Login</button>
    </div>

    <div id="admin-panel" class="hidden">
      <div class="card">
        <h3>üè¶ Bank Info</h3>
        <input id="name" placeholder="Name" />
        <input id="ac" placeholder="Account Number" />
        <input id="ifsc" placeholder="IFSC Code" />
        <input id="upi" placeholder="UPI ID" />
        <input id="crypto" placeholder="Crypto Address" />
        <button id="save-bank-btn">Save</button>
      </div>

      <div class="card">
        <h3>üí≥ Recharge Requests</h3>
        <div id="recharge-requests">Loading...</div>
      </div>

      <div class="card">
        <h3>üí∏ Withdraw Requests</h3>
        <div id="withdraw-requests">Loading...</div>
      </div>
    </div>
  </div>

  <script type="module">
    import { supabase } from './supabase-config-admin.js';

    const loginSection = document.getElementById('login-section')
    const adminPanel = document.getElementById('admin-panel')

    document.getElementById('login-btn').onclick = async () => {
      const email = document.getElementById('email').value
      const password = document.getElementById('password').value
      const { data, error } = await supabase.auth.signInWithPassword({ email, password })
      if (error) return alert('Login failed: ' + error.message)
      if (data.user.email !== 'admin@gmail.com') {
        alert('Not authorized')
        return
      }
      loginSection.classList.add('hidden')
      adminPanel.classList.remove('hidden')
      loadAll()
    }

    async function loadAll() {
      const { data } = await supabase.from('bank_info').select('*').eq('id', 1).single()
      if (data) {
        document.getElementById('name').value = data.name || ''
        document.getElementById('ac').value = data.ac || ''
        document.getElementById('ifsc').value = data.ifsc || ''
        document.getElementById('upi').value = data.upi || ''
        document.getElementById('crypto').value = data.crypto_address || ''
      }
      loadRechargeRequests()
      loadWithdrawRequests()
    }

    document.getElementById('save-bank-btn').onclick = async () => {
      const update = {
        id: 1,
        name: document.getElementById('name').value,
        ac: document.getElementById('ac').value,
        ifsc: document.getElementById('ifsc').value,
        upi: document.getElementById('upi').value,
        crypto_address: document.getElementById('crypto').value
      }
      await supabase.from('bank_info').upsert(update)
      alert('Saved!')
    }

    async function loadRechargeRequests() {
      const container = document.getElementById('recharge-requests')
      const { data } = await supabase.from('recharge_requests').select('*').order('created_at', { ascending: false })
      container.innerHTML = ''
      for (const item of data) {
        const el = document.createElement('div')
        el.className = 'request-box'
        el.innerHTML = `
          User: ${item.email || item.user_id}<br/>
          UTR: ${item.utr}<br/>
          Amount: ‚Çπ${item.amount}<br/>
          Status: ${item.status || 'pending'}
          <div class="btn-group">
            <button onclick="handleApproveRecharge('${item.id}', '${item.user_id}', ${item.amount})">‚úÖ Allow</button>
            <button onclick="handleRejectRecharge('${item.id}')">‚ùå Reject</button>
          </div>
        `;
        container.appendChild(el)
      }
    }

    async function loadWithdrawRequests() {
      const container = document.getElementById('withdraw-requests')
      const { data } = await supabase.from('withdraw_requests').select('*').order('created_at', { ascending: false })
      container.innerHTML = ''
      for (const item of data) {
        const el = document.createElement('div')
        el.className = 'request-box'
        el.innerHTML = `
        User: ${item.email || item.user_id}<br/>
          Amount: ‚Çπ${item.amount}<br/>
          Status: ${item.status || 'pending'}
          <div class="btn-group">
            <button onclick="handleApproveWithdraw('${item.id}', '${item.user_id}', ${item.amount})">‚úÖ Allow</button>
            <button onclick="handleRejectWithdraw('${item.id}')">‚ùå Reject</button>
          </div>
        `;
        container.appendChild(el)
      }
    }

    // Recharge functions
    window.handleApproveRecharge = async (id, email, amount) => {
      try {
        await supabase.from('recharge_requests').update({ status: 'approved' }).eq('id', id)

        const { data: userDataArray, error: userError } = await supabase
          .from('users')
          .select('balance')
          .eq('email', email)
          .limit(1)

        if (userError) throw userError
        const userData = userDataArray?.[0]
        if (!userData) throw new Error('User not found')

        const currentBalance = userData.balance || 0
        const newBalance = currentBalance + amount

        await supabase.from('users').update({ balance: newBalance }).eq('email', email)

        alert('Recharge approved and balance updated!')
        loadRechargeRequests()
      } catch (err) {
        alert('Failed: ' + err.message)
      }
    }

    window.handleRejectRecharge = async (id) => {
      await supabase.from('recharge_requests').update({ status: 'rejected' }).eq('id', id)
      alert('Recharge rejected.')
      loadRechargeRequests()
    }

    // Withdraw functions
    window.handleApproveWithdraw = async (id, email, amount) => {
      try {
        await supabase.from('withdraw_requests').update({ status: 'approved' }).eq('id', id)

        const { data: userDataArray, error: userError } = await supabase
          .from('users')
          .select('balance')
          .eq('email', email)
          .limit(1)

        if (userError) throw userError
        const userData = userDataArray?.[0]
        if (!userData) throw new Error('User not found')

        const currentBalance = userData.balance || 0
        if (currentBalance < amount) throw new Error('Insufficient balance')

        const newBalance = currentBalance - amount
        await supabase.from('users').update({ balance: newBalance }).eq('email', email)

        alert('Withdrawal approved and balance deducted!')
        loadWithdrawRequests()
      } catch (err) {
        alert('Failed: ' + err.message)
      }
    }

    window.handleRejectWithdraw = async (id) => {
      await supabase.from('withdraw_requests').update({ status: 'rejected' }).eq('id', id)
      alert('Withdraw rejected.')
      loadWithdrawRequests()
    }
  </script>
</body>
</html>
