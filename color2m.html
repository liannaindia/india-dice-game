<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Ganeshcasino · Wingo (Color2M)</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&display=swap" rel="stylesheet">
  <script type="module" src="./supabase-config.js"></script>
  <style>
    :root{
      /* Light theme tuned for Ganeshcasino */
      --peacock:#0d6efd;      /* brand blue */
      --saffron:#ff8c1a;      /* saffron orange */
      --lotus:#7c3aed;        /* violet */
      --emerald:#16a34a;      /* green */
      --ruby:#ef4444;         /* red */
      --bg:#eef4ff;           /* page background */
      --ink:#0b1f49;          /* main text */
      --card:#ffffff;         /* card surface */
      --card2:#f7faff;        /* soft surface */
      --muted:#526a95;        /* muted text */
      --line:#dce7ff;         /* lines */
      --gold:#f7c948;         /* accents */
      --shadow:0 12px 28px rgba(15,60,160,.14);
      --radius:18px;
    }
    *{box-sizing:border-box}
    html,body{margin:0;height:100%}
    body{font-family:'Poppins',sans-serif;background:linear-gradient(180deg,#f7faff, var(--bg)); color:var(--ink); display:flex; justify-content:center}
    .wrap{width:100%; max-width:520px; padding:16px 12px 120px}

    /* header */
    .brand{display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap; margin-bottom:12px}
    .logo{display:flex; align-items:center; gap:10px; font-weight:800; letter-spacing:.3px}
    .logo .mark{width:28px; height:28px; border-radius:8px; background:conic-gradient(from 220deg, var(--saffron), var(--gold), var(--peacock)); box-shadow:0 0 0 2px rgba(0,0,0,.04)}
    .brand-right{display:flex; align-items:center; gap:8px; flex-wrap:wrap}
    .balance{background:rgba(247,201,72,.18); color:#5c4500; padding:6px 10px; border:1px solid rgba(247,201,72,.5); border-radius:999px; font-weight:700}
    .btn-xs{padding:6px 10px; border:1px solid var(--line); background:#fff; border-radius:10px; color:#23457a; cursor:pointer}
    .btn-link{padding:6px 10px; border:1px solid var(--line); background:#fff; border-radius:10px; color:#23457a; text-decoration:none; display:inline-block}

    @media (max-width:520px){
      .brand-right{width:100%; justify-content:space-between}
    }

    /* top card */
    .topcard{background:linear-gradient(180deg,#ffffff,#f2f7ff); border:1px solid var(--line); border-radius:22px; box-shadow:var(--shadow); padding:12px}
    .split{display:grid; grid-template-columns:1fr auto; gap:12px}
    .badge{border:1px dashed rgba(13,110,253,.6); color:#23457a; padding:5px 10px; border-radius:999px; font-size:12px; font-weight:700; display:inline-flex; align-items:center; gap:8px; background:#fff}
    .nums{display:flex; gap:8px; margin-top:10px}
    .ball{width:30px; height:30px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:800; color:#fff; box-shadow:inset 0 0 0 3px rgba(255,255,255,.45), 0 6px 16px rgba(0,0,0,.12)}
    .ball.green{background:linear-gradient(180deg,#34d399,#16a34a)}
    .ball.red{background:linear-gradient(180deg,#ff6b6b,#ef4444)}
    .ball.violet{background:linear-gradient(180deg,#b692ff,#7c3aed)}

    .right{background:linear-gradient(180deg,#0d6efd,#1e55f4); color:#fff; border-radius:16px; padding:12px 14px; min-width:170px; display:flex; flex-direction:column; justify-content:center; gap:4px; box-shadow:0 8px 18px rgba(13,110,253,.22)}
    .right .title{opacity:.95; font-size:12px; font-weight:700}
    .timer{display:flex; align-items:center; gap:6px}
    .digit{width:26px; height:32px; border-radius:8px; background:rgba(255,255,255,.95); color:#0a2a6b; font-weight:800; display:flex; align-items:center; justify-content:center; box-shadow:inset 0 -2px 0 rgba(0,0,0,.12)}
    .colon{padding:0 2px; font-weight:800}
    .period{font-size:12px; opacity:.98; letter-spacing:.2px}

    /* board */
    .board{margin-top:14px; background:var(--card); border:1px solid var(--line); border-radius:22px; box-shadow:var(--shadow); padding:12px}
    .row{display:flex; gap:8px}
    .pill{flex:1; text-align:center; padding:10px 8px; border-radius:12px; font-weight:800; border:1.5px solid transparent; cursor:pointer; user-select:none}
    .pill.green{background:linear-gradient(180deg, #eafff3, #e4fff0); color:#0b7a3a; border-color:#b8f2cd}
    .pill.violet{background:linear-gradient(180deg, #f1e9ff, #efe6ff); color:#5b33c8; border-color:#d9c7ff}
    .pill.red{background:linear-gradient(180deg, #ffe9e9, #ffe3e3); color:#9a1a1a; border-color:#ffc1c1}
    .pill .sub{font-weight:700; font-size:12px; opacity:.9}
    .pill.active{outline:2px solid var(--peacock); box-shadow:0 0 0 4px rgba(13,110,253,.16)}

    .grid{display:grid; grid-template-columns:repeat(5,1fr); gap:10px; margin:12px 2px 8px}
    .chip{position:relative; background:#fff; border:1.5px solid #e5edff; border-radius:14px; height:58px; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:2px; box-shadow:0 8px 18px rgba(17,69,180,.08)}
    .chip .n{font-weight:800; font-size:18px}
    .chip .x{font-size:10px; color:#6b84b1; font-weight:700}
    .chip.green .n{color:#22c55e}
    .chip.red .n{color:#ef4444}
    .chip.violet .n{color:#7c3aed}

    .tools{display:flex; gap:8px; flex-wrap:wrap; margin:10px 0 6px}
    .btn{padding:8px 12px; border:1px solid var(--line); border-radius:10px; background:#fff; color:#23457a; font-weight:700; font-size:12px; cursor:pointer}
    .btn.primary{background:linear-gradient(180deg,#0d6efd,#1e55f4); border-color:#1e55f4; color:#fff}
    .btn.gold{background:linear-gradient(180deg,#ffe089,#f7c948); color:#3a2a00; border-color:#f7c948}

    .bigsmall{display:flex; gap:10px; margin-top:8px}
    .bigsmall .btn{flex:1; text-align:center; padding:12px 0; border-radius:12px; font-weight:800}

    /* bet slip */
    .betslip{margin-top:12px; background:var(--card2); border:1px solid var(--line); border-radius:16px; padding:12px}
    .betslip h4{margin:0 0 8px; font-size:14px; color:#1e3b72}
    .row2{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .amount{flex:1; background:#fff; border:1px solid var(--line); border-radius:10px; padding:10px; color:#1b356a; font-weight:700}
    .chipamt{padding:8px 10px; border:1px solid var(--line); border-radius:10px; cursor:pointer; background:#fff; color:#23457a}

    .submit{display:flex; gap:10px; margin-top:10px}
    .submit .btn{flex:1; padding:12px 16px; font-size:14px; border-radius:12px}
    .note{font-size:12px; color:var(--muted); margin-top:6px}

    /* tabs + table */
    .tabs{display:flex; gap:8px; margin-top:12px}
    .tab{flex:1; text-align:center; background:#eef5ff; border:1px solid var(--line); border-radius:12px; padding:10px 0; font-weight:800; color:#345d9b; cursor:pointer}
    .tab.active{background:linear-gradient(180deg,#0d6efd,#1e55f4); color:#fff; border-color:#1e55f4}

    .table{margin-top:10px; background:#fff; border:1px solid var(--line); border-radius:16px; overflow:hidden}
    .thead,.trow{display:grid; grid-template-columns:1.2fr .8fr .8fr .9fr; align-items:center}
    .thead{background:#0d6efd; color:#fff; font-weight:800; padding:10px 12px}
    .trow{padding:10px 12px; border-top:1px solid var(--line)}
    .dot{width:8px; height:8px; border-radius:50%; display:inline-block; margin-right:6px}
    .dot.green{background:var(--emerald)}
    .dot.red{background:var(--ruby)}
    .dot.violet{background:var(--lotus)}

    .empty{padding:14px; text-align:center; color:#5a79ad}

    /* toast */
    .toast{position:fixed; left:50%; bottom:18px; transform:translateX(-50%); background:#ffffff; border:1px solid var(--line); color:#113066; padding:10px 14px; border-radius:10px; font-weight:700; box-shadow:var(--shadow); display:none; z-index:50}
    .toast.show{display:block}

    @media (max-width:360px){ .thead,.trow{grid-template-columns:1fr .8fr .8fr .8fr} .wrap{padding-bottom:160px} }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="brand">
      <div class="logo"><div class="mark"></div> Ganeshcasino · <span style="color:var(--peacock)">Wingo</span></div>
      <div class="brand-right">
        <a href="/" id="btnLobby" class="btn-link">← Lobby</a>
        <span id="userEmail">Guest</span>
        <span class="balance" id="balance">₹0.00</span>
        <button class="btn-xs" id="btnSign">Sign in</button>
      </div>
    </div>

    <!-- Header card -->
    <div class="topcard">
      <div class="split">
        <div>
          <div class="badge">WinGo 2 minutes</div>
          <div class="nums" id="recentBalls"></div>
        </div>
        <div class="right">
          <div class="title">Time remaining</div>
          <div class="timer" id="timer">
            <span class="digit">0</span><span class="digit">0</span>
            <span class="colon">:</span>
            <span class="digit">0</span><span class="digit">0</span>
          </div>
          <div class="period" id="period">000000000000</div>
        </div>
      </div>
    </div>

    <!-- Betting board -->
    <div class="board">
      <div class="row">
        <div class="pill green" data-type="color" data-val="green">Green <span class="sub">2X</span></div>
        <div class="pill violet" data-type="color" data-val="violet">Violet <span class="sub">4.5X</span></div>
        <div class="pill red" data-type="color" data-val="red">Red <span class="sub">2X</span></div>
      </div>

      <div class="grid" id="numGrid"></div>

      <div class="tools">
        <button class="btn" id="btnRandom">Random</button>
        <button class="btn primary mult" data-m="1">X1</button>
        <button class="btn mult" data-m="5">X5</button>
        <button class="btn mult" data-m="10">X10</button>
        <button class="btn mult" data-m="20">X20</button>
        <button class="btn mult" data-m="50">X50</button>
        <button class="btn mult" data-m="100">X100</button>
      </div>

      <div class="bigsmall">
        <button class="btn primary" data-type="size" data-val="big" id="btnBig">Big 2X</button>
        <button class="btn" data-type="size" data-val="small" id="btnSmall">Small 2X</button>
      </div>

      <div class="betslip">
        <h4>Bet slip</h4>
        <div class="row2">
          <input class="amount" id="amount" type="number" min="1" step="1" placeholder="Enter amount (₹)" />
          <button class="chipamt" data-amt="10">+10</button>
          <button class="chipamt" data-amt="50">+50</button>
          <button class="chipamt" data-amt="100">+100</button>
          <button class="chipamt" data-amt="500">+500</button>
        </div>
        <div class="submit">
          <button class="btn" id="btnClear">Clear</button>
          <button class="btn gold" id="btnPlace">Place Bet</button>
        </div>
        <div class="note" id="note">Bets close 30s before draw. Current round only.</div>
      </div>

      <div class="tabs">
        <div class="tab active" data-tab="game">Game</div>
        <div class="tab" data-tab="mine">My history</div>
      </div>

      <div class="table" id="tableGame">
        <div class="thead"><div>Period</div><div>Number</div><div>Big Small</div><div>Color</div></div>
        <div id="tbodyGame"><div class="empty" id="emptyGame" style="display:none">No records yet.</div></div>
      </div>

      <div class="table" id="tableMine" style="display:none">
        <div class="thead"><div>Period</div><div>Pick</div><div>Amount</div><div>Status</div></div>
        <div id="tbodyMine"><div class="empty" id="emptyMine" style="display:none">No bets yet.</div></div>
      </div>

    </div>
  </div>

  <div class="toast" id="toast">Saved</div>

  <script type="module">
    import { supabase } from './supabase-config.js';

    /* ===================== CONFIG ===================== */
    const PERIOD_SEC = 120;       // 2-minute rounds
    const CLOSE_SEC  = 30;        // close 30s before next round
    const ODDS = { color:{green:2, red:2, violet:4.5}, number:9, size:{big:2, small:2} };

    /* ===================== STATE ===================== */
    let currentUser = null;        // supabase auth user
    let userBalance = 0;           // balance from users table
    let selection = null;          // { kind:'color'|'number'|'size', value:string|number }
    let betMultiplier = 1;         // X1..X100 (display only)

    /* ===================== UTIL (IST time & round) ===================== */
    const toIST = (d=new Date()) => new Date(d.getTime() + (5.5*3600*1000));
    const bucketStartIST = (d=new Date()) => {
      const t = toIST(d);
      const secondsToday = t.getHours()*3600 + t.getMinutes()*60 + t.getSeconds();
      const bucket = Math.floor(secondsToday / PERIOD_SEC);
      const start = new Date(t);
      const targetSec = bucket * PERIOD_SEC;
      const hh = Math.floor(targetSec/3600);
      const mm = Math.floor((targetSec%3600)/60);
      const ss = targetSec%60;
      start.setHours(hh, mm, ss, 0);
      return start;
    };
    const nextBucketIST = () => { const s = bucketStartIST(); const n = new Date(s); n.setSeconds(n.getSeconds()+PERIOD_SEC); return n; };
    const secsToNextBucket = () => Math.max(0, Math.floor((nextBucketIST() - toIST())/1000));
    const roundKey = (d) => { const t = d; const y=t.getFullYear(); const m=String(t.getMonth()+1).padStart(2,'0'); const dd=String(t.getDate()).padStart(2,'0'); const h=String(t.getHours()).padStart(2,'0'); const mi=String(t.getMinutes()).padStart(2,'0'); return `${y}${m}${dd}${h}${mi}`; };
    const displayRoundNumber = () => roundKey(nextBucketIST()); // 显示“下一桶”的期号

    /* ===================== COLOR / SIZE RULES ===================== */
    const colorOf = (n) => (n===0||n===5? 'violet' : (n%2? 'red' : 'green'));
    const bigSmall = (n) => (n>=5? 'Big' : 'Small');

    /* ===================== UI HELPERS ===================== */
    const qs = (s)=>document.querySelector(s); const qsa=(s)=>document.querySelectorAll(s);
    const toast = (msg)=>{ const t=qs('#toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 1600); };

    /* ===================== AUTH & BALANCE ===================== */
    async function loadUser(){
      const { data: { user } } = await supabase.auth.getUser();
      currentUser = user || null;
      const emailEl = qs('#userEmail');
      const btn = qs('#btnSign');
      if(currentUser){
        emailEl.textContent = currentUser.email;
        btn.textContent = 'Sign out';
        await refreshBalance();
      } else {
        emailEl.textContent = 'Guest';
        btn.textContent = 'Sign in';
        qs('#balance').textContent = '₹0.00';
      }
    }
    async function refreshBalance(){
      if(!currentUser) return;
      const { data, error } = await supabase.from('users').select('balance').eq('id', currentUser.id).maybeSingle();
      if(error){ console.error(error); return; }
      userBalance = Number(data?.balance||0);
      qs('#balance').textContent = `₹${userBalance.toFixed(2)}`;
    }
    qs('#btnSign').addEventListener('click', async ()=>{
      if(currentUser){ await supabase.auth.signOut(); location.reload(); } else { location.href = './index.html'; }
    });

    /* ===================== BUILD NUMBER GRID ===================== */
    const numGrid = qs('#numGrid');
    for(let n=0;n<=9;n++){
      const d=document.createElement('div');
      d.className = `chip ${colorOf(n)}`;
      d.innerHTML = `<div class="n">${n}</div><div class="x">9X</div>`;
      d.dataset.type = 'number'; d.dataset.val = String(n);
      d.addEventListener('click', ()=>selectPick('number', n));
      numGrid.appendChild(d);
    }

    /* ===================== PICK HANDLERS ===================== */
    qsa('.pill').forEach(p=>p.addEventListener('click',()=>selectPick(p.dataset.type, p.dataset.val)));
    qs('#btnBig').addEventListener('click',()=>selectPick('size','big'));
    qs('#btnSmall').addEventListener('click',()=>selectPick('size','small'));

    function selectPick(kind,value){
      selection = { kind, value };
      qsa('.pill').forEach(p=>p.classList.remove('active'));
      qsa('.pill').forEach(p=>{ if(p.dataset.type===kind && p.dataset.val===String(value)) p.classList.add('active'); });
      qsa('.chip').forEach(c=>c.style.outline='none');
      qsa('.chip').forEach(c=>{ if(c.dataset.type==='number' && c.dataset.val===String(value)) c.style.outline='2px solid var(--peacock)'; });
      updateNote();
    }

    qsa('.mult').forEach(b=>b.addEventListener('click',()=>{ betMultiplier = Number(b.dataset.m); qsa('.mult').forEach(x=>x.classList.remove('primary')); b.classList.add('primary'); }));
    qsa('.chipamt').forEach(b=>b.addEventListener('click',()=>{ const i=qs('#amount'); i.value = String((Number(i.value||0) + Number(b.dataset.amt))*betMultiplier); }));
    qs('#btnClear').addEventListener('click',()=>{ qs('#amount').value=''; selection=null; qsa('.pill').forEach(p=>p.classList.remove('active')); qsa('.chip').forEach(c=>c.style.outline='none'); });

    /* ===================== TIMER ===================== */
    const periodEl = qs('#period'); const timerEl = qs('#timer');
    function renderTimer(){
      periodEl.textContent = displayRoundNumber();
      const s = secsToNextBucket(); const m=String(Math.floor(s/60)).padStart(2,'0'); const ss=String(s%60).padStart(2,'0');
      const ds = timerEl.querySelectorAll('.digit'); const digits=[...m+ss]; ds[0].textContent=digits[0]; ds[1].textContent=digits[1]; ds[2].textContent=digits[2]; ds[3].textContent=digits[3];
      updateNote();
    }
    function updateNote(){
      const s = secsToNextBucket(); const closed = s <= CLOSE_SEC; const note = qs('#note');
      if(closed) note.textContent = `Betting closed. Wait for next draw.`; else note.textContent = `Bets close ${CLOSE_SEC}s before draw. Current round only.`;
      qs('#btnPlace').disabled = closed;
    }

    setInterval(renderTimer, 250); renderTimer();

    /* ===================== DATA: HISTORY & REALTIME ===================== */
    const recentWrap = qs('#recentBalls');
    const addBall = (n)=>{ const b=document.createElement('div'); b.className=`ball ${colorOf(n)}`; b.textContent=n; recentWrap.appendChild(b); while(recentWrap.children.length>5) recentWrap.removeChild(recentWrap.firstElementChild); };

    const tbodyGame = qs('#tbodyGame'); const emptyGame = qs('#emptyGame');
    const pushGameRow = (round,n)=>{ const tr=document.createElement('div'); tr.className='trow'; tr.innerHTML=`<div>${round}</div><div><strong>${n}</strong></div><div>${bigSmall(n)}</div><div><span class="dot ${colorOf(n)}"></span></div>`; tbodyGame.prepend(tr); while(tbodyGame.children.length>51) tbodyGame.removeChild(tbodyGame.lastElementChild); };

    function renderEmptyState(has){ emptyGame.style.display = has? 'none':'block'; }

    async function fetchGameHistory(){
      const { data, error } = await supabase.from('color2m_rounds').select('round_number,result_number').order('round_number',{ascending:false}).limit(30);
      if(error){ console.error(error); return; }
      renderEmptyState(data.length>0);
      recentWrap.innerHTML=''; data.slice(0,5).reverse().forEach(r=>addBall(r.result_number));
      tbodyGame.innerHTML=''; data.reverse().forEach(r=>pushGameRow(r.round_number, r.result_number));
    }

    try{
      const ch = supabase.channel('color2m_rounds_changes');
      ch.on('postgres_changes', {event:'INSERT', schema:'public', table:'color2m_rounds'}, payload => {
        const r = payload.new; addBall(r.result_number); pushGameRow(r.round_number, r.result_number); refreshBalance();
      }).subscribe();
    }catch(e){ console.warn('Realtime not enabled', e); }

    setInterval(fetchGameHistory, 5000); fetchGameHistory();

    /* ===================== TABS ===================== */
    const tabs = qsa('.tab');
    tabs.forEach(t=>t.addEventListener('click',()=>{
      tabs.forEach(x=>x.classList.remove('active')); t.classList.add('active');
      qs('#tableGame').style.display = (t.dataset.tab==='game')?'block':'none';
      qs('#tableMine').style.display = (t.dataset.tab==='mine')?'block':'none';
      if(t.dataset.tab==='mine') fetchMyBets();
    }));

    const tbodyMine = qs('#tbodyMine'); const emptyMine = qs('#emptyMine');
    async function fetchMyBets(){
      if(!currentUser){ tbodyMine.innerHTML = ''; emptyMine.style.display='block'; return; }
      const { data, error } = await supabase.from('color2m_bets').select('round_number, bet_type, choice, amount, status').eq('user_id', currentUser.id).order('created_at',{ascending:false}).limit(30);
      if(error){ console.error(error); return; }
      emptyMine.style.display = data.length? 'none':'block';
      tbodyMine.innerHTML='';
      data.forEach(r=>{
        const pick = r.bet_type==='number' ? r.choice : r.choice.toUpperCase();
        const tr=document.createElement('div'); tr.className='trow';
        tr.innerHTML = `<div>${r.round_number}</div><div>${pick}</div><div>₹${Number(r.amount).toFixed(2)}</div><div>${r.status}</div>`;
        tbodyMine.appendChild(tr);
      });
    }

    /* ===================== PLACE BET (RPC) ===================== */
    function computeOdds(sel){
      if(!sel) return null;
      if(sel.kind==='color') return ODDS.color[sel.value];
      if(sel.kind==='number') return ODDS.number;
      if(sel.kind==='size') return ODDS.size[sel.value];
      return null;
    }

    qs('#btnPlace').addEventListener('click', async ()=>{
      if(!currentUser){ toast('Please sign in first'); return; }
      const s = secsToNextBucket(); if(s <= CLOSE_SEC){ toast('Betting closed for this round'); return; }
      if(!selection){ toast('Select a color / number / size'); return; }
      const amt = Number(qs('#amount').value || 0); if(!(amt>0)){ toast('Enter a valid amount'); return; }
      const odds = computeOdds(selection); if(!odds){ toast('Odds error'); return; }

      const payload = {
        _user_id: currentUser.id,
        _email: currentUser.email,
        _bet_type: selection.kind,
        _choice: String(selection.value),
        _amount: amt,
        _odds: odds
      };
      const { data, error } = await supabase.rpc('color2m_place_bet_ist', payload);
      if(error){ console.error(error); toast(error.message || 'Bet failed'); return; }
      toast('Bet placed');
      qs('#amount').value='';
      await refreshBalance();
      await fetchMyBets();
    });

    /* ===================== INIT ===================== */
    await loadUser();
  </script>
</body>
</html>
