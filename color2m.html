<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Wingo 2-Min</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0d6efd">
  <script type="module" src="./supabase-config.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{--card:#fff;--bg1:#fff7ec;--bg2:#e6f2ff;--text:#1f2937;--muted:#667085;--line:#e5e7eb;--radius:16px;--shadow:0 8px 22px rgba(0,0,0,.10);
      --primary:#0d6efd;--ok:#16a34a;--danger:#dc2626;--red:#ef4444;--green:#16a34a;--violet:#7c3aed}
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;font-family:'Poppins',sans-serif;background:linear-gradient(180deg,var(--bg1),var(--bg2));color:var(--text);-webkit-tap-highlight-color:transparent;touch-action:manipulation}
    .wrap{max-width:1100px;margin:0 auto;padding:16px;padding-bottom:170px}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:12px}
    .back{display:inline-flex;align-items:center;gap:8px;background:#eef2ff;color:#1d4ed8;text-decoration:none;padding:10px 14px;border-radius:999px;font-weight:800;box-shadow:var(--shadow)}
    .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px}
    .row{display:grid;grid-template-columns:1.35fr 1fr;gap:16px;margin-bottom:16px}
    @media (max-width:768px){.row{grid-template-columns:1fr}}
    .pill{padding:6px 10px;border-radius:999px;background:#f1f5f9;color:#111;font-weight:700}
    .section-title{font-weight:800;margin:8px 0 12px 0;font-size:16px}

    /* countdown */
    .cd{display:grid;gap:6px;background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:12px 16px;min-width:270px}
    .cd-top{display:flex;justify-content:space-between;align-items:center;gap:10px}
    .cd-time{font-size:28px;font-weight:800;letter-spacing:1px;font-variant-numeric:tabular-nums}
    .badge{padding:4px 8px;border-radius:8px;font-size:12px;font-weight:800;color:#fff;background:var(--ok)}
    .badge.closed{background:var(--danger)}
    .bar{height:10px;background:#eef2ff;border-radius:999px;overflow:hidden}
    .bar>i{display:block;height:100%;width:0%;background:linear-gradient(90deg,var(--primary),#60a5fa);transition:width .25s linear}

    /* tabs & grids */
    .tabs{display:flex;gap:8px;margin-bottom:8px;flex-wrap:wrap}
    .tab{padding:8px 12px;border:1px solid var(--line);border-radius:999px;background:#f8fafc;font-weight:800;cursor:pointer}
    .tab.active{background:#111;color:#fff;border-color:#111}
    .grid3{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    .grid5{display:grid;grid-template-columns:repeat(5,1fr);gap:8px}
    .choice{border-radius:14px;padding:14px 8px;text-align:center;color:#fff;font-weight:900;cursor:pointer;user-select:none}
    .choice.red{background:linear-gradient(135deg,#ef4444,#b91c1c)}
    .choice.green{background:linear-gradient(135deg,#22c55e,#15803d)}
    .choice.violet{background:linear-gradient(135deg,#8b5cf6,#6d28d9)}
    .chipn{padding:12px 0;border-radius:12px;border:1px solid var(--line);background:#fff;text-align:center;font-weight:900;cursor:pointer}
    .chipn.sel{box-shadow:0 0 0 3px #111 inset}
    .siz{padding:12px 0;border-radius:12px;border:1px solid var(--line);background:#fff;text-align:center;font-weight:900;cursor:pointer}
    .siz.sel{box-shadow:0 0 0 3px #111 inset}
    .amount-box{display:flex;gap:10px;align-items:center;margin-top:12px;flex-wrap:wrap}
    .amt{border:1px solid var(--line);border-radius:12px;padding:12px 14px;min-width:150px;outline:none;font-size:16px}
    .chip{background:#f1f5f9;border:1px solid var(--line);padding:10px 14px;border-radius:999px;cursor:pointer;font-weight:800}
    .btn{padding:12px 16px;border:none;border-radius:12px;background:var(--primary);color:#fff;font-weight:800;cursor:pointer;box-shadow:0 6px 16px rgba(13,110,253,.3)}
    .btn[disabled]{opacity:.6;cursor:not-allowed}

    /* result area */
    .result-list{display:grid;grid-template-columns:repeat(10,1fr);gap:8px}
    @media (max-width:900px){.result-list{grid-template-columns:repeat(8,1fr)}}@media (max-width:600px){.result-list{grid-template-columns:repeat(6,1fr)}}
    .bubble{ text-align:center; padding:10px 0; border-radius:12px; font-size:14px; font-weight:900; border:1px solid var(--line); background:#fff }
    .bubble.red{background:#fee2e2;color:#b91c1c}
    .bubble.green{background:#dcfce7;color:#166534}
    .bubble.violet{background:#ede9fe;color:#5b21b6}

    /* reel (digit roll) */
    .reel{height:60px;overflow:hidden;border-radius:12px;border:1px solid var(--line);background:#fff;display:grid;place-items:center;font-weight:900;font-size:36px}
    .roll{position:relative;height:60px}
    .roll .d{height:60px;display:grid;place-items:center;width:100%}

    /* table */
    .table{width:100%;border-collapse:collapse;font-size:14px}
    .table th,.table td{padding:10px;border-bottom:1px solid var(--line);text-align:left}
    .ok{color:var(--ok);font-weight:800}.err{color:var(--danger);font-weight:800}

    /* mobile dock */
    .dock{position:fixed;left:0;right:0;bottom:0;padding:12px env(safe-area-inset-right) calc(12px + env(safe-area-inset-bottom)) env(safe-area-inset-left);
      background:linear-gradient(180deg,rgba(255,255,255,0),rgba(255,255,255,.95) 20%,rgba(255,255,255,.98) 100%);backdrop-filter:blur(6px);box-shadow:0 -8px 22px rgba(0,0,0,.12);display:none;z-index:998}
    @media (max-width:768px){.dock{display:block}.wrap{padding-bottom:180px}}
    .dock-inner{max-width:1100px;margin:0 auto;display:grid;grid-template-columns:2fr 1fr;gap:8px;align-items:center}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <a class="back" href="./index.html">← Back to Lobby</a>
      <div class="cd">
        <div class="cd-top">
          <div style="font-weight:800;">Period: <span id="period" class="pill">---</span></div>
          <div class="cd-time" id="timeLeft">--:--</div>
          <span id="betState" class="badge">Open</span>
        </div>
        <div class="bar"><i id="bar"></i></div>
      </div>
    </header>

    <div class="card" style="margin-bottom:12px;">
      <div id="userStat" class="pill">Not signed in</div>
    </div>

    <!-- Reel -->
    <div class="card" style="margin-bottom:12px;">
      <div class="section-title">Result Reel</div>
      <div class="reel"><div class="roll" id="roll"></div></div>
      <div style="margin-top:8px;color:var(--muted);font-size:13px;">Reel reveals when the round ends; winner = the rolled digit.</div>
    </div>

    <div class="row">
      <div class="card">
        <div class="section-title">Place your bet</div>

        <div class="tabs">
          <button class="tab active" data-tab="color">Color</button>
          <button class="tab" data-tab="number">Number</button>
          <button class="tab" data-tab="size">Big / Small</button>
        </div>

        <!-- Color -->
        <div id="panel-color">
          <div class="grid3">
            <div class="choice red"    data-color="red">RED ×2.0</div>
            <div class="choice green"  data-color="green">GREEN ×2.0</div>
            <div class="choice violet" data-color="violet">VIOLET ×4.5</div>
          </div>
        </div>

        <!-- Number -->
        <div id="panel-number" style="display:none;">
          <div class="grid5" id="numGrid"></div>
          <div style="margin-top:6px;color:var(--muted);font-size:13px;">Payout ×9.0</div>
        </div>

        <!-- Size -->
        <div id="panel-size" style="display:none;">
          <div class="grid3">
            <div class="siz" data-size="small">SMALL (0–4) ×2.0</div>
            <div class="siz" data-size="big">BIG (6–9) ×2.0</div>
            <div class="siz" data-size="none" title="5 is violet only">Number 5 → no size</div>
          </div>
        </div>

        <div class="amount-box">
          <input type="number" id="amount" class="amt" placeholder="Enter amount" min="1" step="1">
          <div class="chip" data-add="10">+10</div>
          <div class="chip" data-add="50">+50</div>
          <div class="chip" data-add="100">+100</div>
          <div class="chip" data-add="500">+500</div>
          <button class="btn" id="btnBet">Place Bet</button>
        </div>
        <div id="betMsg" style="margin-top:10px;"></div>
      </div>

      <div class="card">
        <div class="section-title">Last 10 Results</div>
        <div class="result-list" id="resultList"></div>
      </div>
    </div>

    <div class="card">
      <div class="section-title">My Recent Bets</div>
      <table class="table" id="betsTable">
        <thead><tr><th>Time</th><th>Period</th><th>Type</th><th>Pick</th><th>Amount</th><th>Odds</th><th>Status</th><th>Payout</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- mobile dock -->
  <div class="dock">
    <div class="dock-inner">
      <input type="number" id="m_amount" class="amt" placeholder="Amount" min="1" step="1">
      <button class="btn" id="m_bet">Bet</button>
    </div>
  </div>

  <div class="toast" id="toast" style="display:none"></div>

  <script type="module">
    import { supabase } from './supabase-config.js';
    const $=(s)=>document.querySelector(s), $$=(s)=>document.querySelectorAll(s);
    const fmt=(n)=>Number(n||0).toLocaleString('en-IN',{minimumFractionDigits:2,maximumFractionDigits:2});
    const sleep=(ms)=>new Promise(r=>setTimeout(r,ms));
    const toast=(m,ok=true)=>{const t=$('#toast');t.textContent=m;t.style.background=ok?'#111':'#b91c1c';t.style.display='block';setTimeout(()=>t.style.display='none',1800)};

    // server clock
    let skew=0;
    async function syncClock(){ try{ const {data}=await supabase.rpc('get_server_time_ms'); if(typeof data==='number') skew=data-Date.now(); }catch{} }
    await syncClock(); setInterval(syncClock,60000);
    const nowIST=()=>new Date(Date.now()+skew+5.5*3600000);
    function calcSlot(ist){
      const m=ist.getMinutes(); const start=new Date(ist); start.setSeconds(0,0); start.setMinutes(m-(m%2));
      const end=new Date(start.getTime()+120000); const sec=Math.floor((ist-start)/1000); const remain=Math.max(0,120-sec);
      const closed=sec>=90; const pad=n=>String(n).padStart(2,'0'); const per=`${end.getFullYear()}${pad(end.getMonth()+1)}${pad(end.getDate())}${pad(end.getHours())}${pad(end.getMinutes())}`;
      return {remain,closed,per,prog:sec/120}
    }

    // globals
    let user=null, serverPeriod=null;
    let sel = { kind:'color', color:'red', number:null, size:null };

    // UI init
    boot();
    async function boot(){
      const {data:{user:U}}=await supabase.auth.getUser(); user=U||null;
      if(user) await refreshUser(); else $('#userStat').textContent='Please login first';

      // build number grid
      const numGrid=$('#numGrid');
      for(let i=0;i<=9;i++){ const b=document.createElement('div'); b.className='chipn'; b.textContent=i; b.dataset.n=i; numGrid.appendChild(b); }

      // tabs
      $$('.tab').forEach(t=>t.addEventListener('click',()=>{
        $$('.tab').forEach(x=>x.classList.remove('active')); t.classList.add('active');
        ['color','number','size'].forEach(name=> $('#panel-'+name).style.display = (t.dataset.tab===name)?'block':'none');
        sel.kind = t.dataset.tab; if(sel.kind==='color'){sel.color=sel.color||'red'} if(sel.kind==='number'){sel.number ??= 0} if(sel.kind==='size'){sel.size ??= 'small'}
      }));

      // color picks
      $$('#panel-color .choice').forEach(c=>c.addEventListener('click',()=>{ sel={kind:'color', color:c.dataset.color}; toast('Selected '+sel.color.toUpperCase()); }));

      // number picks
      $$('#panel-number .chipn').forEach(n=>n.addEventListener('click',()=>{
        $$('#panel-number .chipn').forEach(x=>x.classList.remove('sel'));
        n.classList.add('sel'); sel={kind:'number', number: Number(n.dataset.n)};
      }));

      // size picks
      $$('#panel-size .siz').forEach(s=>s.addEventListener('click',()=>{
        $$('#panel-size .siz').forEach(x=>x.classList.remove('sel'));
        s.classList.add('sel'); const v=s.dataset.size; sel={kind:'size', size: v==='none'? null : v};
      }));

      // chips
      $$('.chip').forEach(ch=> ch.addEventListener('click',()=>{ const cur=Number($('#amount').value||0); $('#amount').value=cur+Number(ch.dataset.add); }));

      // bet buttons
      $('#btnBet').addEventListener('click', placeBet);
      $('#m_bet').addEventListener('click', async ()=>{ const v=Number($('#m_amount').value||0); if(v>0){ $('#amount').value=v; await placeBet(); } });

      // timers + data
      tick(); setInterval(tick,250);
      await refreshResults();
      await refreshMyBets();

      // realtime
      try{
        supabase.channel('rt:color2m_rounds')
          .on('postgres_changes',{event:'*',schema:'public',table:'color2m_rounds'},()=>{refreshResults(); refreshMyBets();})
          .subscribe();
      }catch{}
    }

    async function refreshUser(){
      const {data}=await supabase.from('users').select('email,balance').eq('id',user.id).single();
      $('#userStat').innerHTML=`<b>Email:</b> ${data.email||user.email} &nbsp;|&nbsp; <b>Balance:</b> ₹${fmt(data.balance||0)}`;
    }

    async function getPeriod(){
      // 兼容两种函数名，存在其一即可
      let p=null;
      try{ const {data}=await supabase.rpc('current_color2m_period_ist'); if(data) p=data; }catch{}
      if(!p){ try{ const {data}=await supabase.rpc('current_wingo2m_period_ist'); if(data) p=data; }catch{} }
      serverPeriod=p;
    }

    async function placeBet(){
      if(!user) return toast('Please login first',false);
      const s=calcSlot(nowIST()); if(s.closed) return toast('Betting closed for this round',false);
      const amt=Number($('#amount').value||0); if(!amt || amt<=0) return toast('Enter a valid amount',false);

      let kind=sel.kind, value=null;
      if(kind==='color'){ value=sel.color||'red'; }
      else if(kind==='number'){ value=String(sel.number ?? 0); }
      else { if(!sel.size) return toast('Pick BIG or SMALL',false); value=sel.size; }

      const {data,error}=await supabase.rpc('wingo2m_place_bet_ist',{ _user_id:user.id, _email:user.email, _kind:kind, _value:value, _amount:amt });
      if(error){ const m=(error.message||'').toUpperCase(); if(m.includes('BET_CLOSED')) toast('Betting closed',false); else if(m.includes('INSUFFICIENT_FUNDS')) toast('Insufficient balance',false); else toast(error.message,false); return; }
      toast('Bet placed');
      $('#amount').value=''; $('#m_amount').value='';
      await refreshUser(); await refreshMyBets();
    }

    // countdown + reel trigger
    async function tick(){
      const ist=nowIST(); const s=calcSlot(ist);
      $('#timeLeft').textContent = `${String(Math.floor(s.remain/60)).padStart(2,'0')}:${String(s.remain%60).padStart(2,'0')}`;
      $('#bar').style.width = (s.prog*100)+'%';
      $('#betState').textContent = s.closed?'Closed':'Open';
      $('#betState').className = 'badge'+(s.closed?' closed':'');
      if(!serverPeriod) await getPeriod();
      $('#period').textContent = serverPeriod || s.per;

      if(s.remain===0){ await playReelFor(s.per); await refreshResults(); await refreshMyBets(); await getPeriod(); }
    }

    // reel: 0-9 快速滚动后停在本期结果
    async function playReelFor(period){
      // 取开奖结果（最多等 2s）
      let digit=null;
      for(let i=0;i<8;i++){
        const {data}=await supabase.from('color2m_rounds').select('result_number').eq('period',period).maybeSingle();
        if(data?.result_number !== null){ digit=data.result_number; break; }
        await sleep(250);
      }
      if(digit===null) return;

      const roll=$('#roll'); roll.innerHTML='';
      // 先铺 20 个数字块做滚动，再追加目标
      for(let i=0;i<20;i++){
        const d=document.createElement('div'); d.className='d'; d.textContent= (i%10);
        roll.appendChild(d);
      }
      const target=document.createElement('div'); target.className='d'; target.textContent=digit; roll.appendChild(target);
      roll.style.transition='none'; roll.style.transform='translateY(0)';
      await sleep(16);
      const h=60; const total = (roll.children.length-1)*h;
      roll.style.transition='transform 1.2s cubic-bezier(.25,.9,.35,1)';
      roll.style.transform=`translateY(-${total}px)`;
    }

    async function refreshResults(){
      const {data}=await supabase
        .from('color2m_rounds')
        .select('period,result_number,result,result_size,draw_time')
        .order('draw_time',{ascending:false})
        .limit(10);
      const box=$('#resultList'); box.innerHTML='';
      (data||[]).forEach(r=>{
        const b=document.createElement('div');
        const col = r.result || 'violet';
        b.className = 'bubble '+(col==='red'?'red':col==='green'?'green':'violet');
        b.textContent = r.result_number ?? '-';
        b.title = `${r.period}  ${col.toUpperCase()}  ${r.result_size? r.result_size.toUpperCase() : '—'}`;
        box.appendChild(b);
      });
    }

    async function refreshMyBets(){
      if(!user) return;
      const {data}=await supabase
        .from('color2m_bets')
        .select('created_at,period,kind,choice,choice_number,choice_size,amount,odds,status,payout')
        .eq('user_id',user.id)
        .order('created_at',{ascending:false})
        .limit(30);
      const tb=$('#betsTable tbody'); tb.innerHTML='';
      (data||[]).forEach(b=>{
        const tr=document.createElement('tr'); const dt=new Date(b.created_at);
        const kind=b.kind.toUpperCase();
        const pick=b.kind==='color' ? (b.choice||'').toUpperCase()
                : b.kind==='number' ? String(b.choice_number)
                : (b.choice_size||'').toUpperCase();
        tr.innerHTML = `
          <td>${dt.toLocaleString('en-GB')}</td>
          <td>${b.period}</td>
          <td>${kind}</td>
          <td>${pick}</td>
          <td>₹${fmt(b.amount)}</td>
          <td>x${b.odds}</td>
          <td>${b.status==='win'?'<span class="ok">WIN</span>':b.status==='lose'?'<span class="err">LOSE</span>':'PENDING'}</td>
          <td>${b.payout?'₹'+fmt(b.payout):'-'}</td>`;
        tb.appendChild(tr);
      });
    }
  </script>
</body>
</html>
