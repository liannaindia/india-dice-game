<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Lucky Dice Game</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <script type="module" src="./supabase-config.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg1:#fff7ec; --bg2:#e6f2ff; --card:#fff; --text:#222;
      --muted:#666; --primary:#0d6efd; --primary-pressed:#0b5ed7;
      --success:#2e7d32; --danger:#d32f2f; --surface:#f6f8fb;
      --radius:14px; --shadow:0 6px 18px rgba(0,0,0,.08);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:'Poppins',sans-serif; color:var(--text);
      background:linear-gradient(180deg,var(--bg1),var(--bg2));
      padding-bottom:94px; /* ç»™åº•éƒ¨ä¸‹æ³¨æ ç•™ç©ºé—´ */
    }
    .container{max-width:720px;margin:0 auto;padding:16px 16px calc(16px + env(safe-area-inset-bottom))}
    h2{margin:6px 0 14px;text-align:center;color:#ff6f00}

    .card{
      background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow);
      padding:14px 14px; margin-bottom:14px;
    }
    .row{display:flex; gap:10px}
    .row>*{flex:1}
    .muted{color:var(--muted); font-size:12px}

    /* é¡¶éƒ¨ç”¨æˆ·å¡ */
    .userbar{display:flex; align-items:center; justify-content:space-between; gap:10px}
    .balance{font-weight:700; color:var(--success)}
    .btn{
      display:inline-flex; align-items:center; justify-content:center;
      padding:12px 14px; border-radius:12px; border:0; cursor:pointer;
      background:var(--primary); color:#fff; font-weight:700; min-height:46px;
    }
    .btn:active{background:var(--primary-pressed)}
    .btn.secondary{background:#eef4ff; color:#1e3a8a}
    .btn.ghost{background:#fff; color:#111; border:1px solid #e6eaf2}

    /* é€‰é¡¹å¡ */
    .seg{display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-top:6px}
    .seg .chip{
      padding:10px 12px; text-align:center; border-radius:12px;
      background:#f2f5fa; border:1px solid #e6eaf2; font-weight:600; cursor:pointer;
    }
    .seg .chip.active{background:#eaf2ff; border-color:#cfe0ff; color:#0b5ed7}

    /* æ•°å­—æ ¼ */
    .grid6{display:grid; grid-template-columns:repeat(6,1fr); gap:8px; margin-top:8px}
    .num{padding:12px 0; text-align:center; border-radius:12px; background:#f7f9fc; border:1px solid #e6eaf2; font-weight:700; cursor:pointer}
    .num.active{background:#fff0e6; border-color:#ffc999}

    /* å¿«æ·é‡‘é¢ */
    .quick{display:flex; gap:8px; flex-wrap:wrap}
    .qchip{padding:8px 10px; border-radius:10px; background:#f2f5fa; border:1px solid #e6eaf2; cursor:pointer}
    .qchip:active{transform:scale(.98)}

    /* ç»“æœä¸å€’è®¡æ—¶ */
    .result-box{display:flex; justify-content:space-between; align-items:center; gap:10px}
    .result-big{font-size:28px; font-weight:800}
    .countdown{font-weight:700}

    /* æœ€è¿‘10æ¡ - ç§»åŠ¨ç«¯å¡ç‰‡ï¼›æ¡Œé¢ç«¯è¡¨æ ¼ */
    #my-bets{display:grid; gap:10px}
    .betcard{
      border:1px solid #eef1f6; border-radius:12px; padding:10px 12px; background:#fbfdff;
      display:grid; grid-template-columns:1fr auto; gap:6px; align-items:center;
    }
    .betcard .line{font-size:13px}
    .betcard .payout.win{color:var(--success); font-weight:700}
    .betcard .payout.lose{color:var(--danger); font-weight:700}
    .hidden{display:none}

    /* æ¡Œé¢ç«¯æ˜¾ç¤ºè¡¨æ ¼ç‰ˆæœ¬ */
    @media(min-width:800px){
      #my-bets.table{display:block}
      .tablewrap{overflow:auto}
      table{width:100%; border-collapse:collapse}
      th,td{padding:8px 6px; border-bottom:1px solid #eee; font-size:14px; text-align:left}
      th{font-weight:700}
      .cardsver{display:none}
    }

    /* åº•éƒ¨å›ºå®šä¸‹æ³¨æ  */
    .betbar{
      position:fixed; left:0; right:0; bottom:0;
      padding:10px 12px calc(10px + env(safe-area-inset-bottom));
      background:rgba(255,255,255,.85); backdrop-filter: blur(10px);
      border-top:1px solid #e8edf6; display:flex; gap:10px; align-items:center;
    }
    .betbar input{
      flex:1; height:46px; border-radius:12px; border:1px solid #e1e6f0; padding:0 12px; font-size:16px; background:#fff
    }
    .betbar .btn{min-width:140px}

    /* è¾“å…¥ç»Ÿä¸€æ ·å¼ */
    input,select{
      width:100%; height:46px; border-radius:12px; border:1px solid #e1e6f0; padding:0 12px; font-size:16px; background:#fff
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>ğŸ² Lucky Dice</h2>

    <!-- ç”¨æˆ·å¡ -->
    <div class="card">
      <div class="userbar">
        <div>
          <div class="muted">Logged in as</div>
          <div id="user-email" style="font-weight:700">â€”</div>
        </div>
        <div class="balance">â‚¹<span id="balance">0</span></div>
            <button id="lobby-btn" class="btn ghost">Lobby</button>
        <button id="logout-btn" class="btn secondary">Logout</button>
      </div>
      <div class="muted" style="margin-top:8px">* Bets close in the last 3 seconds of each minute.</div>
    </div>

    <!-- ç©æ³•é€‰æ‹© -->
    <div class="card">
      <h3 style="margin:0 0 6px">ğŸ¯ Select Bet</h3>
      <div class="seg" id="mode-seg">
        <div class="chip active" data-mode="big">Big (4â€“6) Ã—<span id="odds-big">2.00</span></div>
        <div class="chip" data-mode="small">Small (1â€“3) Ã—<span id="odds-small">2.00</span></div>
      </div>

      <div class="muted" style="margin-top:8px">Or choose exact number:</div>
      <div class="grid6" id="num-grid">
        <div class="num" data-n="1">1 Ã—<span class="o">6.00</span></div>
        <div class="num" data-n="2">2 Ã—<span class="o">6.00</span></div>
        <div class="num" data-n="3">3 Ã—<span class="o">6.00</span></div>
        <div class="num" data-n="4">4 Ã—<span class="o">6.00</span></div>
        <div class="num" data-n="5">5 Ã—<span class="o">6.00</span></div>
        <div class="num" data-n="6">6 Ã—<span class="o">6.00</span></div>
      </div>

      <div style="margin-top:10px" class="quick" id="quick-amt">
        <div class="qchip" data-v="100">â‚¹100</div>
        <div class="qchip" data-v="200">â‚¹200</div>
        <div class="qchip" data-v="500">â‚¹500</div>
        <div class="qchip" data-v="1000">â‚¹1000</div>
      </div>
    </div>

    <!-- ç»“æœ -->
    <div class="card">
      <div class="result-box">
        <div>
          <div class="muted">Round</div>
          <div id="round-number" style="font-weight:700">â€”</div>
        </div>
        <div style="text-align:center">
          <div class="muted">Result</div>
          <div id="dice-result" class="result-big">â€”</div>
        </div>
        <div style="text-align:right">
          <div class="muted">Time Left</div>
          <div id="countdown" class="countdown">â€”</div>
        </div>
      </div>
    </div>

    <!-- æœ€è¿‘10æ¡ -->
    <div class="card">
      <h3 style="margin:0 0 6px">ğŸ§¾ My Last 10 Bets</h3>
      <!-- ç§»åŠ¨ç«¯å¡ç‰‡ç‰ˆ -->
      <div id="my-bets" class="cardsver">Loadingâ€¦</div>
      <!-- æ¡Œé¢ç«¯è¡¨æ ¼ç‰ˆ -->
      <div id="my-bets-table" class="tablewrap hidden">
        <table>
          <thead>
            <tr><th>Round</th><th>Bet</th><th>Amount</th><th>Result</th><th>Status</th><th>Payout</th></tr>
          </thead>
          <tbody id="my-bets-tbody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- åº•éƒ¨ä¸‹æ³¨æ  -->
  <div class="betbar">
    <input type="number" id="bet-amount" placeholder="Amount â‚¹" inputmode="decimal" />
    <button id="bet-btn" class="btn">Submit Bet</button>
  </div>

  <script type="module">
    import { supabase } from './supabase-config.js';

    /* ====== èµ”ç‡ï¼ˆä¿®æ”¹è¿™é‡Œå³å¯ï¼‰ ====== */
    const BIG_ODDS   = 2.00;
    const SMALL_ODDS = 2.00;
    const NUMBER_ODDS= 6.00;
    const CLOSE_BUFFER = 3; // å°ç›˜ç§’æ•°

    /* ====== refs ====== */
    let currentUser = null;
    const emailEl = document.getElementById('user-email');
    const balanceEl = document.getElementById('balance');
    const diceResult = document.getElementById('dice-result');
    const roundNumber = document.getElementById('round-number');
    const logoutBtn = document.getElementById('logout-btn');
    const betBtn = document.getElementById('bet-btn');
    const betAmountEl = document.getElementById('bet-amount');
    const countEl = document.getElementById('countdown');
    const myBetsCards = document.getElementById('my-bets');
    const myBetsTableWrap = document.getElementById('my-bets-table');
    const myBetsTbody = document.getElementById('my-bets-tbody');

    // æ›´æ–°èµ”ç‡å±•ç¤º
    document.getElementById('odds-big').textContent = BIG_ODDS.toFixed(2);
    document.getElementById('odds-small').textContent = SMALL_ODDS.toFixed(2);
    document.querySelectorAll('#num-grid .o').forEach(el=>el.textContent = NUMBER_ODDS.toFixed(2));

    /* ====== æ—¶é—´å·¥å…·ï¼ˆISTï¼‰ ====== */
    function getIST(){
      const now = new Date();
      const utc = now.getTime() + now.getTimezoneOffset()*60000;
      return new Date(utc + 5.5*60*60*1000);
    }
    function currentRoundNo(){
      const now = getIST();
      const y=now.getFullYear(), m=String(now.getMonth()+1).padStart(2,'0'),
            d=String(now.getDate()).padStart(2,'0'), h=String(now.getHours()).padStart(2,'0'),
            min=String(now.getMinutes()).padStart(2,'0');
      return `${y}${m}${d}${h}${min}`;
    }

    /* ====== ç™»å½• ====== */
    logoutBtn.onclick = async () => {
      await supabase.auth.signOut();
      location.href = './index.html';
    };

    supabase.auth.getUser().then(async ({ data }) => {
      if (!data?.user) {
        alert('Please login first.'); location.href = './index.html';
      } else {
        currentUser = data.user;
        emailEl.textContent = currentUser.email;
        await supabase.from('users').upsert([{ id: currentUser.id, email: currentUser.email }]);
        await loadBalance();
        await loadLatestResult();
        await loadMyLastBets();
        startTicker();
      }
    });

    async function loadBalance(){
      const { data } = await supabase.from('users').select('balance').eq('id', currentUser.id).single();
      balanceEl.textContent = data?.balance || 0;
    }

    /* ====== å¼€å¥– ====== */
    async function loadLatestResult(){
      const round = currentRoundNo();
      roundNumber.textContent = round;
      const { data } = await supabase.from('game_rounds').select('result').eq('round_number', round).maybeSingle();
      diceResult.textContent = (data && data.result) ? data.result : 'â€”';
    }

    function startTicker(){
      setInterval(async ()=>{
        const now = getIST();
        const sec = now.getSeconds();
        const remaining = 60 - sec;
        countEl.textContent = `${remaining}s`;

        if (remaining <= CLOSE_BUFFER) {
          betBtn.disabled = true; betBtn.textContent = 'Bet Closed';
        } else {
          betBtn.disabled = false; betBtn.textContent = 'Submit Bet';
        }

        if (sec === 0) {
          await loadLatestResult();
          await loadMyLastBets();
          await loadBalance();
        }
        roundNumber.textContent = currentRoundNo();
      }, 500);
    }

    /* ====== æˆ‘çš„æœ€è¿‘10æ¡ ====== */
    async function loadMyLastBets(){
      if (!currentUser) return;

      const { data: bets } = await supabase
        .from('bets')
        .select('round_number, bet_type, choice, amount, status, payout, created_at')
        .eq('user_id', currentUser.id)
        .order('created_at', { ascending: false })
        .limit(10);

      // æ‰¹é‡ç»“æœ
      const rounds = [...new Set((bets||[]).map(b=>b.round_number))];
      let resultMap = {};
      if (rounds.length) {
        const { data: rs } = await supabase
          .from('game_rounds')
          .select('round_number, result')
          .in('round_number', rounds);
        (rs||[]).forEach(r => resultMap[r.round_number]=r.result);
      }

      const items = (bets||[]).map(b=>{
        const human = b.bet_type==='number' ? `Number ${b.choice}` : (b.bet_type==='big' ? 'Big (4â€“6)' : 'Small (1â€“3)');
        const res = resultMap[b.round_number] ?? 'â€”';
        const payout = Number(b.payout||0);
        return {
          round: b.round_number, bet: human, amt: Number(b.amount).toFixed(2),
          res, status: b.status, payout: payout.toFixed(2)
        };
      });

      // ç§»åŠ¨ç«¯å¡ç‰‡
      myBetsCards.innerHTML = items.length ? items.map(it=>`
        <div class="betcard">
          <div>
            <div class="line"><b>Round:</b> ${it.round}</div>
            <div class="line"><b>Bet:</b> ${it.bet} Â· â‚¹${it.amt}</div>
            <div class="line"><b>Result:</b> ${it.res} Â· <b>Status:</b> ${it.status}</div>
          </div>
          <div class="payout ${it.status==='won' ? 'win' : 'lose'}">â‚¹${it.payout}</div>
        </div>
      `).join('') : `<div class="muted">No recent bets.</div>`;

      // æ¡Œé¢ç«¯è¡¨æ ¼
      myBetsTbody.innerHTML = items.map(it=>`
        <tr>
          <td>${it.round}</td><td>${it.bet}</td><td>â‚¹${it.amt}</td>
          <td>${it.res}</td><td>${it.status}</td><td>â‚¹${it.payout}</td>
        </tr>
      `).join('');

      // æ ¹æ®å±å®½åˆ‡æ¢è§†å›¾
      if (window.matchMedia('(min-width:800px)').matches){
        myBetsTableWrap.classList.remove('hidden');
      } else {
        myBetsTableWrap.classList.add('hidden');
      }
    }

    /* ====== ä¸‹æ³¨ï¼ˆåŸå­æ‰£æ¬¾RPCï¼‰====== */
    // äº¤äº’ï¼šæ¨¡å¼ä¸æ•°å­—é€‰æ‹©
    let currentBetType = 'big'; // 'big' | 'small' | 'number'
    let currentChoice = null;

    document.querySelectorAll('#mode-seg .chip').forEach(ch=>{
      ch.onclick = ()=>{
        document.querySelectorAll('#mode-seg .chip').forEach(x=>x.classList.remove('active'));
        ch.classList.add('active');
        currentBetType = ch.dataset.mode;
        currentChoice = null;
        document.querySelectorAll('#num-grid .num').forEach(n=>n.classList.remove('active'));
      };
    });
    document.querySelectorAll('#num-grid .num').forEach(n=>{
      n.onclick = ()=>{
        document.querySelectorAll('#num-grid .num').forEach(x=>x.classList.remove('active'));
        n.classList.add('active');
        currentBetType = 'number';
        currentChoice = Number(n.dataset.n);
        document.querySelectorAll('#mode-seg .chip').forEach(x=>x.classList.remove('active'));
      };
    });
    // å¿«æ·é‡‘é¢
    document.getElementById('quick-amt').querySelectorAll('.qchip').forEach(q=>{
      q.onclick = ()=>{ betAmountEl.value = Number(q.dataset.v); };
    });

    betBtn.onclick = async ()=>{
      if (!currentUser) return alert('Please login first');
      const amount = Number(betAmountEl.value);
      if (!amount || amount<=0) return alert('Enter amount');

      const remaining = 60 - getIST().getSeconds();
      if (remaining <= CLOSE_BUFFER) return alert('Bet closed');

      const rn = currentRoundNo();
      let odds = BIG_ODDS;
      if (currentBetType==='small') odds = SMALL_ODDS;
      if (currentBetType==='number') odds = NUMBER_ODDS;

      const { error } = await supabase.rpc('place_bet', {
        _user_id: currentUser.id,
        _email: currentUser.email,
        _round: rn,
        _bet_type: currentBetType,
        _choice: currentChoice,
        _amount: amount,
        _odds: odds
      });
      if (error){
        if (String(error.message).includes('INSUFFICIENT_BALANCE')) alert('Insufficient balance');
        else alert('Bet failed: ' + error.message);
        return;
      }
      betAmountEl.value = '';
      alert('âœ… Bet placed!');
      await loadBalance();
      await loadMyLastBets();
    };

    // çª—å£æ”¹å˜æ—¶åˆ‡æ¢æˆ‘çš„æŠ•æ³¨è§†å›¾
    window.addEventListener('resize', ()=>loadMyLastBets());
  </script>
</body>
</html>
