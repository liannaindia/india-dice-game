<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Lucky Dice Game</title>
  <script type="module" src="./supabase-config.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(to right, #fff3e0, #e1f5fe);
      padding: 20px;
      color: #222;
    }
    .container { max-width: 520px; margin: auto; }
    h2 { text-align: center; color: #ff6f00; }
    .card {
      background: #fff; border-radius: 12px; padding: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin-bottom: 20px;
    }
    input, select, button {
      width: 100%; padding: 10px; margin-top: 10px; font-size: 16px;
      border-radius: 8px; border: 1px solid #ccc;
    }
    button { background: #007bff; color: #fff; font-weight: 600; cursor: pointer; }
    button[disabled] { opacity:.6; cursor:not-allowed; }
    button:hover { background: #0056b3; }
    .balance { font-weight: bold; font-size: 18px; color: #388e3c; }
    .result-box { background: #e3f2fd; padding: 10px; border-radius: 8px; text-align: center; }
    .muted { color:#666; font-size:12px; margin-top:6px; }
    table { width:100%; border-collapse: collapse; }
    th, td { padding: 6px 4px; text-align:left; border-bottom: 1px solid #eee; font-size: 14px; }
    th { font-weight: 600; }
  </style>
</head>
<body>
  <div class="container">
    <h2>üé≤ Lucky Dice</h2>

    <!-- Áî®Êà∑‰∏é‰ΩôÈ¢ù -->
    <div class="card">
      <p>üë§ Logged in as: <span id="user-email"></span></p>
      <p class="balance">üí∞ Balance: ‚Çπ<span id="balance">0</span></p>
      <button id="logout-btn">Logout</button>
      <div class="muted">* Bets close in the last 3 seconds of each minute.</div>
    </div>

    <!-- ‰∏ãÊ≥® -->
    <div class="card">
      <h3>üéØ Place Your Bet</h3>
      <select id="bet-type">
        <option value="big">Big (4-6)</option>
        <option value="small">Small (1-3)</option>
        <option value="1">Point 1</option>
        <option value="2">Point 2</option>
        <option value="3">Point 3</option>
        <option value="4">Point 4</option>
        <option value="5">Point 5</option>
        <option value="6">Point 6</option>
      </select>
      <input type="number" id="bet-amount" placeholder="Bet Amount ‚Çπ" />
      <button id="bet-btn">Submit Bet</button>
    </div>

    <!-- ÂºÄÂ•ñ‰∏éÂÄíËÆ°Êó∂ -->
    <div class="card result-box">
      <p>üé≤ Result: <span id="dice-result">Waiting...</span></p>
      <p>‚è±Ô∏è Round: <span id="round-number">...</span></p>
    </div>

    <!-- ÊúÄËøë10Êù°‰∏ãÊ≥® -->
    <div class="card">
      <h3>üßæ My Last 10 Bets</h3>
      <div id="my-bets">Loading‚Ä¶</div>
    </div>
  </div>

  <script type="module">
    import { supabase } from './supabase-config.js';

    // ====== refs ======
    let currentUser = null;
    const emailEl = document.getElementById('user-email');
    const balanceEl = document.getElementById('balance');
    const diceResult = document.getElementById('dice-result');
    const roundNumber = document.getElementById('round-number');
    const logoutBtn = document.getElementById('logout-btn');
    const betBtn = document.getElementById('bet-btn');
    const betTypeEl = document.getElementById('bet-type');
    const betAmountEl = document.getElementById('bet-amount');

    // ====== odds / close time ======
    const BIG_ODDS = 2.00;
    const SMALL_ODDS = 2.00;
    const NUMBER_ODDS = 6.00;
    const CLOSE_BUFFER = 3; // last 3 seconds closed

    // ====== time helpers ======
    function getIST() {
      const now = new Date();
      const utc = now.getTime() + now.getTimezoneOffset() * 60000;
      return new Date(utc + 5.5 * 60 * 60 * 1000); // IST
    }
    function currentRoundNo() {
      const now = getIST();
      const y = now.getFullYear();
      const m = String(now.getMonth() + 1).padStart(2, '0');
      const d = String(now.getDate()).padStart(2, '0');
      const h = String(now.getHours()).padStart(2, '0');
      const min = String(now.getMinutes()).padStart(2, '0');
      return `${y}${m}${d}${h}${min}`;
    }

    // ====== auth/init ======
    logoutBtn.onclick = async () => {
      await supabase.auth.signOut();
      location.href = './index.html';
    };

    supabase.auth.getUser().then(async ({ data }) => {
      if (!data?.user) {
        alert('Please login first.');
        location.href = './index.html';
      } else {
        currentUser = data.user;
        emailEl.textContent = currentUser.email;
        await supabase.from('users').upsert([{ id: currentUser.id, email: currentUser.email }]);
        await loadBalance();
        await loadLatestResult();
        await loadMyLastBets();
        startTicker();
      }
    });

    async function loadBalance() {
      const { data, error } = await supabase
        .from('users')
        .select('balance')
        .eq('id', currentUser.id)
        .single();
      if (!error) balanceEl.textContent = data?.balance || 0;
    }

    // ====== result polling ======
    async function loadLatestResult() {
      const round = currentRoundNo();
      roundNumber.textContent = round;

      const { data, error } = await supabase
        .from('game_rounds')
        .select('result')
        .eq('round_number', round)
        .maybeSingle();

      if (!error && data) {
        diceResult.textContent = data.result;
      } else {
        diceResult.textContent = 'Waiting...';
      }
    }

    function startTicker() {
      const countdown = document.createElement('p');
      countdown.style.fontWeight = 'bold';
      countdown.id = 'countdown';
      document.querySelector('.result-box').appendChild(countdown);

      setInterval(async () => {
        const now = getIST();
        const sec = now.getSeconds();
        const remaining = 60 - sec;
        countdown.textContent = `‚è≥ Time Left: ${remaining}s`;

        // close / open bet button
        if (remaining <= CLOSE_BUFFER) {
          betBtn.disabled = true;
          betBtn.textContent = 'Bet Closed';
        } else {
          betBtn.disabled = false;
          betBtn.textContent = 'Submit Bet';
        }

        // new minute: refresh result & my bets
        if (sec === 0) {
          await loadLatestResult();
          await loadMyLastBets();
          await loadBalance(); // ÂèØÈÄâÔºåÊ¥æÂΩ©ÂêéÈ°∫‰æøÂà∑Êñ∞‰ΩôÈ¢ù
        }

        roundNumber.textContent = currentRoundNo();
      }, 500);
    }

    // ====== my last 10 bets ======
    async function loadMyLastBets() {
      if (!currentUser) return;
      const container = document.getElementById('my-bets');

      const { data: bets, error } = await supabase
        .from('bets')
        .select('round_number, bet_type, choice, amount, status, payout, created_at')
        .eq('user_id', currentUser.id)
        .order('created_at', { ascending: false })
        .limit(10);

      if (error) {
        container.textContent = 'Failed to load.';
        return;
      }
      if (!bets || bets.length === 0) {
        container.textContent = 'No recent bets.';
        return;
      }

      // batch get results for these rounds
      const rounds = [...new Set(bets.map(b => b.round_number))];
      let resultMap = {};
      if (rounds.length) {
        const { data: roundsData } = await supabase
          .from('game_rounds')
          .select('round_number, result')
          .in('round_number', rounds);
        (roundsData || []).forEach(r => { resultMap[r.round_number] = r.result; });
      }

      const rows = bets.map(b => {
        const humanBet =
          b.bet_type === 'number' ? `Number ${b.choice}` :
          b.bet_type === 'big' ? 'Big (4-6)' : 'Small (1-3)';
        const res = resultMap[b.round_number] ?? '‚Äî';
        return `
          <tr>
            <td>${b.round_number}</td>
            <td>${humanBet}</td>
            <td>‚Çπ${Number(b.amount).toFixed(2)}</td>
            <td>${res}</td>
            <td>${b.status}</td>
            <td>‚Çπ${Number(b.payout || 0).toFixed(2)}</td>
          </tr>
        `;
      }).join('');

      container.innerHTML = `
        <div style="overflow:auto;">
          <table>
            <thead>
              <tr>
                <th>Round</th>
                <th>Bet</th>
                <th>Amount</th>
                <th>Result</th>
                <th>Status</th>
                <th>Payout</th>
              </tr>
            </thead>
            <tbody>${rows}</tbody>
          </table>
        </div>
      `;
    }

    // ====== place bet (atomic via RPC) ======
    betBtn.onclick = async () => {
      if (!currentUser) return alert('Please login first');
      const amount = Number(betAmountEl.value);
      if (!amount || amount <= 0) return alert('Enter amount');

      // close check
      const now = getIST();
      const remaining = 60 - now.getSeconds();
      if (remaining <= CLOSE_BUFFER) return alert('Bet closed');

      const rn = currentRoundNo();
      const typeVal = betTypeEl.value;

      let bet_type = 'big';
      let choice = null;
      let odds = BIG_ODDS;

      if (typeVal === 'big') {
        bet_type = 'big'; odds = BIG_ODDS;
      } else if (typeVal === 'small') {
        bet_type = 'small'; odds = SMALL_ODDS;
      } else {
        bet_type = 'number'; choice = Number(typeVal); odds = NUMBER_ODDS;
      }

      const { error } = await supabase.rpc('place_bet', {
        _user_id: currentUser.id,
        _email: currentUser.email,
        _round: rn,
        _bet_type: bet_type,
        _choice: choice,
        _amount: amount,
        _odds: odds
      });

      if (error) {
        if (String(error.message).includes('INSUFFICIENT_BALANCE')) {
          alert('Insufficient balance');
        } else {
          alert('Bet failed: ' + error.message);
        }
        return;
      }

      alert('‚úÖ Bet placed!');
      await loadBalance();
      await loadMyLastBets();
    };
  </script>
</body>
</html>
