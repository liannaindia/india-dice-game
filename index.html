<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>India Game Lobby</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <script type="module" src="./supabase-config.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0b1220;              /* Ê∑±Ëâ≤Â∫ïÊõ¥ËÉΩË°¨Êâò‰∫ÆËâ≤Âç°Áâá */
      --bg2:#0e152b;
      --card:rgba(255,255,255,.9);
      --text:#0f172a;
      --muted:#64748b;
      --line:rgba(15,23,42,.08);
      --primary:#ff6f00;
      --primary-press:#e65f00;
      --green:#16a34a;
      --blue:#2563eb;
      --radius:18px;
      --shadow:0 20px 60px rgba(0,0,0,.22);
      --glass:backdrop-filter:saturate(160%) blur(14px);
      --ring:0 0 0 3px rgba(255,111,0,.18), 0 10px 30px rgba(255,111,0,.28);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:'Poppins',system-ui,Segoe UI,Roboto,Arial; color:var(--text);
      background:
        radial-gradient(1200px 700px at 100% -10%, #1b2b59 0%, transparent 60%),
        radial-gradient(1200px 700px at -10% 0%, #2a3b1f 0%, transparent 55%),
        linear-gradient(180deg,var(--bg),var(--bg2));
    }

    /* È°∂ÈÉ®Êù°ÔºöÁéªÁíÉ+Ê∏êÂèòËæπÊ°Ü */
    .nav{
      position:sticky; top:0; z-index:50; border-bottom:1px solid rgba(255,255,255,.06);
      background:linear-gradient(180deg,rgba(255,255,255,.16),rgba(255,255,255,.06));
      --glass; -webkit-backdrop-filter:saturate(160%) blur(14px); backdrop-filter:saturate(160%) blur(14px);
    }
    .nav-inner{max-width:1180px; margin:0 auto; padding:12px 18px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;}
    .brand{display:flex; align-items:center; gap:12px; font-weight:800; color:#fff}
    .logo{
      width:40px;height:40px;border-radius:14px;display:grid;place-items:center;
      background:conic-gradient(from 180deg, #ffd5a1, #fff,#ffe6c1,#ffd5a1);
      border:1px solid rgba(255,255,255,.5); box-shadow:inset 0 1px 0 #fff, 0 6px 20px rgba(0,0,0,.25)
    }
    .actions{display:flex;gap:10px;flex-wrap:wrap}
    .btn{
      display:inline-flex;align-items:center;justify-content:center;gap:8px;height:42px;padding:0 16px;
      border-radius:14px;border:1px solid rgba(255,255,255,.2);background:rgba(255,255,255,.08);cursor:pointer;
      font-weight:700;color:#fff;letter-spacing:.2px; transition:all .18s ease;
    }
    .btn:hover{ transform:translateY(-1px); box-shadow:0 8px 24px rgba(0,0,0,.28) }
    .btn.primary{background:linear-gradient(180deg,#ff7f1a,#ff6f00); border:0; box-shadow:var(--ring)}
    .btn.primary:active{transform:translateY(0); filter:saturate(1.1)}
    .btn.ghost{background:rgba(255,255,255,.1)}
    a.btn{text-decoration:none;color:inherit}

    .hero{
      position:relative; overflow:hidden;
      max-width:1180px;margin:18px auto 0 auto;padding:18px;
    }
    .hero-inner{
      border-radius:22px; padding:26px 24px; display:grid; grid-template-columns:1.1fr .9fr; gap:18px;
      background:
        radial-gradient(800px 380px at 0% 10%, rgba(255,255,255,.94) 0%, rgba(255,255,255,.9) 60%, rgba(255,255,255,.86) 100%),
        url('https://images.unsplash.com/photo-1603297631959-9a4a8e2a3a4b?q=80&w=2400&auto=format&fit=crop') center/cover no-repeat;
      border:1px solid rgba(255,255,255,.5); box-shadow:var(--shadow)
    }
    .hero h1{margin:4px 0 6px 0; font-size:28px; letter-spacing:.2px}
    .hero p{margin:0; color:#475569}
    .hero .cta{display:flex;gap:10px;margin-top:14px;flex-wrap:wrap}

    .wrap{max-width:1180px;margin:18px auto;padding:0 18px}
    .card{
      background:rgba(255,255,255,.92); border:1px solid rgba(15,23,42,.06);
      border-radius:var(--radius); box-shadow:var(--shadow)
    }
    .inner{padding:16px}

    .user{display:grid;grid-template-columns:1fr auto;gap:12px;align-items:center}
    .hello{font-size:13px;color:#64748b}
    .balance{
      font-weight:800;color:#22c55e;font-size:24px;display:flex;align-items:center;gap:10px;
      text-shadow:0 1px 0 rgba(255,255,255,.8)
    }
    .balance .shine{
      position:relative; padding:6px 10px; border-radius:12px;
      background:linear-gradient(180deg,#ecffe8,#f6fff5);
      box-shadow:inset 0 1px 0 #fff, 0 6px 20px rgba(16,185,129,.18);
    }
    .quick{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}

    .games{display:grid;gap:16px;grid-template-columns:1fr}
    @media(min-width:760px){ .games{grid-template-columns:repeat(3,1fr)} }
    .game{
      display:flex;flex-direction:column;gap:12px;padding:16px;border-radius:16px;
      background:linear-gradient(180deg,#ffffff,#fffef9);border:1px solid var(--line);
      transition:transform .15s ease, box-shadow .15s ease, border-color .15s ease;
    }
    .game:hover{ transform:translateY(-3px); box-shadow:0 14px 28px rgba(0,0,0,.08); border-color:#ffe4c7 }
    .thumb{
      height:130px;border-radius:14px;background:
        radial-gradient(120px 80px at 30% 20%, #fff 0%, #ffe7c6 60%, #ffd9a6 100%);
      border:1px solid #ffe4c7;display:grid;place-items:center;font-size:46px
    }
    .title{font-weight:800}
    .desc{color:#61708c;font-size:13px}
    .game .btn{width:100%; margin-top:auto}

    /* Modal ÁéªÁíÉÈ£é */
    .modal-bg{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(2,6,23,.42);z-index:100}
    .modal{
      width:min(96vw,760px);
      background:linear-gradient(180deg,rgba(255,255,255,.96),rgba(255,255,255,.92));
      border-radius:20px;border:1px solid rgba(15,23,42,.08);box-shadow:var(--shadow)
    }
    .modal header{padding:14px 18px;border-bottom:1px solid rgba(15,23,42,.06);font-weight:800}
    .modal .body{padding:16px}
    .modal footer{display:flex;justify-content:flex-end;gap:10px;padding:12px 18px;border-top:1px solid rgba(15,23,42,.06)}
    .form{display:grid;gap:10px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    input{
      width:100%;height:46px;border-radius:12px;border:1px solid #e8eef6;padding:0 12px;font-size:15px;background:#fff;
      transition:border-color .15s ease, box-shadow .15s ease
    }
    input:focus{outline:none;border-color:#cbd5e1; box-shadow:0 0 0 3px rgba(37,99,235,.12)}
    .muted{color:#64748b}
    .kv{display:flex;justify-content:space-between;gap:12px;padding:10px;border:1px dashed #e8eef6;border-radius:12px;background:#fcfdff}
    .kv .k{color:#7a8aa6} .kv .v{font-weight:700}

    /* VIP ÂæΩÁ´† */
    .vip-badge{
      display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border:1px solid #ffe0b6;background:#fff7ec;border-radius:999px;
      color:#b45309;font-weight:700;font-size:12px; box-shadow:inset 0 1px 0 #fff
    }

    /* Ë°®Ê†º‰ºòÂåñÔºöÊñëÈ©¨Á∫π + ÂúÜËßíË°®Ë∫´ */
    table{width:100%;border-collapse:separate;border-spacing:0 0}
    thead th{padding:12px;border-bottom:1px solid #eef2f7;background:#fafbfd;text-align:left;font-weight:700}
    tbody td{padding:12px;border-bottom:1px solid #eef2f7}
    tbody tr:nth-child(odd){background:#fff}
    tbody tr:nth-child(even){background:#fcfdff}
    .tag{display:inline-block;padding:4px 10px;border-radius:999px;font-size:12px;border:1px solid var(--line)}
    .tag.pending{background:#fff7ed;color:#b45309;border-color:#fed7aa}
    .tag.approved{background:#ecfdf5;color:#065f46;border-color:#bbf7d0}
    .tag.rejected{background:#fef2f2;color:#991b1b;border-color:#fecaca}

    /* Â∞èÊèêÁ§∫Êù° */
    .tipbar{
      margin-top:10px;padding:10px 12px;border:1px dashed #e8eef6;border-radius:12px;background:#fcfdff;color:#64748b;font-size:13px
    }
  </style>
</head>
<body>
  <!-- È°∂ÈÉ® Hero ÂÆ£‰º†Âå∫ÔºàÂèØÂà†Ôºâ -->
  <div class="hero">
    <div class="hero-inner">
      <div>
        <div class="vip-badge">üéâ Welcome</div>
        <h1>Ganeshcasino Game Lobby</h1>
        <p>Play India-style classics with synchronized rounds and secure wallet.</p>
        <div class="cta">
          <a class="btn primary" href="./mini-wheel.html">Start Mini Wheel</a>
          <a class="btn ghost" href="https://t.me/customerservice7777777" target="_blank">üí¨ Customer Service</a>
        </div>
      </div>
      <div class="tipbar">üí° Tip: Deposit, Withdraw, My Records and Change Password are in the user panel below after login.</div>
    </div>
  </div>

  <!-- È°∂ÈÉ®ÂØºËà™Ôºà‰øùÊåÅÂéü‰∫§‰∫íÔºâ -->
  <div class="nav">
    <div class="nav-inner">
      <div class="brand">
        <div class="logo">üé≤</div>
        <div>Ganeshcasino Game</div>
      </div>
      <div class="actions">
        <a id="cs-link" class="btn ghost" href="https://t.me/customerservice7777777" target="_blank">üí¨ Customer Service</a>
        <button id="open-login" class="btn">Login / Signup</button>
        <button id="logout-btn" class="btn ghost" style="display:none">Logout</button>
      </div>
    </div>
  </div>

  <div class="wrap">
    <!-- Áî®Êà∑Âç° -->
    <div class="card">
      <div class="inner user">
        <div>
          <div class="hello">Logged in as</div>
          <div id="user-email" style="font-weight:800;color:#0b1220">‚Äî</div>
          <div class="quick">
            <button id="open-deposit" class="btn primary">Deposit</button>
            <button id="open-withdraw" class="btn">Withdraw</button>
            <button id="open-history" class="btn">My Records</button>
            <button id="open-chpass" class="btn ghost">Change Password</button>
          </div>
        </div>
        <div class="balance">
          <span class="shine">‚Çπ<span id="balance">0</span></span>
          <span id="vip-badge" class="vip-badge" title="VIP Level">VIP 0</span>
        </div>
      </div>
    </div>

    <!-- Ê∏∏ÊàèÂå∫ -->
    <div class="card" style="margin-top:18px">
      <div class="inner">
        <div style="font-weight:800;margin-bottom:12px">üéÆ Select a Game</div>

        <div class="games">
          <div class="game">
            <div class="thumb">üé°</div>
            <div class="title">Mini Wheel</div>
            <div class="desc">2-minute rounds (IST). Bet Small/Big or 3‚Äì18.</div>
            <a class="btn primary" href="./mini-wheel.html">Play</a>
          </div>

          <div class="game">
            <div class="thumb">üé≤</div>
            <div class="title">Lucky Dice</div>
            <div class="desc">Bet on Big/Small or exact number. Results every minute (IST).</div>
            <a class="btn primary" href="./dice.html">Play</a>
          </div>

          <div class="game">
            <div class="thumb">üÉè</div>
            <div class="title">Andar Bahar</div>
            <div class="desc">Bet on Andar or Bahar. Result every minute (IST).</div>
            <a class="btn primary" href="./ab.html">Play</a>
          </div>

          <div class="game">
            <div class="thumb">üßß</div>
            <div class="title">Coming Soon</div>
            <div class="desc">More India-style games are on the way.</div>
            <button class="btn" disabled>Stay tuned</button>
          </div>

          <div class="game">
            <div class="thumb">üíé</div>
            <div class="title">Coming Soon</div>
            <div class="desc">Unlock new experiences for your players.</div>
            <button class="btn" disabled>Stay tuned</button>
          </div>

          <div class="game">
            <div class="thumb">üéÅ</div>
            <div class="title">Events & Offers</div>
            <div class="desc">Festival bonuses & cashback promos.</div>
            <button class="btn" disabled>Coming soon</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ÁôªÂΩï Modal -->
  <div id="login-modal" class="modal-bg">
    <div class="modal">
      <header>Login / Signup</header>
      <div class="body">
        <div class="form">
          <input id="login-email" type="email" placeholder="Email" />
          <input id="login-pass" type="password" placeholder="Password" />
          <div class="muted">New user? Click ‚ÄúSignup‚Äù then login.</div>
        </div>
      </div>
      <footer>
        <button id="login-cancel" class="btn">Cancel</button>
        <button id="signup-btn" class="btn">Signup</button>
        <button id="login-btn" class="btn primary">Login</button>
      </footer>
    </div>
  </div>

  <!-- Â≠òÊ¨æ Modal -->
  <div id="dep-modal" class="modal-bg">
    <div class="modal">
      <header>Deposit</header>
      <div class="body">
        <div class="form">
          <div class="muted">Please transfer to the account below, then submit UTR and amount.</div>
          <div id="dep-bank" class="form">
            <div class="kv"><div class="k">Name</div><div class="v">‚Äî</div></div>
            <div class="kv"><div class="k">AC</div><div class="v">‚Äî</div></div>
            <div class="kv"><div class="k">IFSC</div><div class="v">‚Äî</div></div>
            <div class="kv"><div class="k">UPI</div><div class="v">‚Äî</div></div>
            <div class="kv"><div class="k">Crypto</div><div class="v">‚Äî</div></div>
          </div>
          <input id="dep-utr" type="text" placeholder="UTR / Reference Number" />
          <input id="dep-amount" type="number" min="1" placeholder="Amount ‚Çπ" />
        </div>
      </div>
      <footer>
        <button id="dep-cancel" class="btn">Cancel</button>
        <button id="dep-submit" class="btn primary">Submit</button>
      </footer>
    </div>
  </div>

  <!-- ÊèêÊ¨æ Modal -->
  <div id="wd-modal" class="modal-bg">
    <div class="modal">
      <header>Withdraw</header>
      <div class="body">
        <div class="form">
          <div class="kv" id="rollover-kv"><div class="k">Rollover Needed</div><div class="v" id="rollover-val">0.00</div></div>

          <div class="row">
            <input id="w-name" placeholder="Your Name" />
            <input id="w-ac" placeholder="AC Number" />
          </div>
          <div class="row">
            <input id="w-ifsc" placeholder="IFSC Code" />
            <input id="w-upi" placeholder="UPI ID (optional)" />
          </div>
          <div class="row">
            <input id="wd-amount" type="number" min="1" placeholder="Amount ‚Çπ" />
            <button id="wd-save" class="btn">Save Profile</button>
          </div>
          <div class="muted">Save your bank profile first if you modified it.</div>
        </div>
      </div>
      <footer>
        <button id="wd-cancel" class="btn">Cancel</button>
        <button id="wd-submit" class="btn primary">Submit Withdrawal</button>
      </footer>
    </div>
  </div>

  <!-- My Records Modal -->
  <div id="history-modal" class="modal-bg">
    <div class="modal">
      <header>My Records (Last 3 Days)</header>
      <div class="body">
        <div class="muted" style="margin-bottom:10px">Showing recent 3 days</div>

        <div style="display:grid;grid-template-columns:1fr;gap:16px">
          <div>
            <div style="font-weight:700;margin:6px 0 8px 0">Deposits</div>
            <div class="card" style="border-radius:14px">
              <div class="inner" style="padding:0">
                <table>
                  <thead>
                    <tr><th>Time</th><th>UTR</th><th>Amount (‚Çπ)</th><th>Status</th></tr>
                  </thead>
                  <tbody id="deposits-tbody"><tr><td colspan="4" class="muted" style="padding:14px">‚Äî</td></tr></tbody>
                </table>
              </div>
            </div>
          </div>
          <div>
            <div style="font-weight:700;margin:6px 0 8px 0">Withdrawals</div>
            <div class="card" style="border-radius:14px">
              <div class="inner" style="padding:0">
                <table>
                  <thead>
                    <tr><th>Time</th><th>Amount (‚Çπ)</th><th>Status</th></tr>
                  </thead>
                  <tbody id="withdrawals-tbody"><tr><td colspan="3" class="muted" style="padding:14px">‚Äî</td></tr></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

      </div>
      <footer>
        <button id="history-close" class="btn">Close</button>
      </footer>
    </div>
  </div>

  <!-- ‰øÆÊîπÂØÜÁ†Å Modal -->
  <div id="chpass-modal" class="modal-bg">
    <div class="modal">
      <header>Change Password</header>
      <div class="body">
        <div class="form">
          <input id="old-pass" type="password" placeholder="Current Password" />
          <input id="new-pass" type="password" placeholder="New Password (min 6 chars)" />
          <input id="new-pass2" type="password" placeholder="Confirm New Password" />
          <div class="muted">We will verify your current password before updating.</div>
        </div>
      </div>
      <footer>
        <button id="chpass-cancel" class="btn">Cancel</button>
        <button id="chpass-submit" class="btn primary">Update Password</button>
      </footer>
    </div>
  </div>

  <script type="module">
    import { supabase } from './supabase-config.js';
    const $ = (id)=>document.getElementById(id);
    const show = (el,on=true)=> el.style.display = on ? 'flex' : 'none';
    const toast = (m)=>alert(m);
    const fmt2 = (n)=> Number(n ?? 0).toFixed(2);
    const fmtTime = (iso)=>{ try{ const d=new Date(iso); return d.toLocaleString(undefined,{year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'});}catch{return iso||'‚Äî';}};

    // È°∂ÈÉ®ÊåâÈíÆ
    const openLogin = $('open-login');
    const logoutBtn = $('logout-btn');
    const userEmail = $('user-email');
    const balanceEl = $('balance');
    const vipBadge  = $('vip-badge');

    // ÁôªÂΩï
    const loginModal = $('login-modal'), loginCancel = $('login-cancel'),
          signupBtn = $('signup-btn'), loginBtn = $('login-btn'),
          loginEmail = $('login-email'), loginPass = $('login-pass');

    // Â≠òÊ¨æ
    const depModal = $('dep-modal'), depCancel = $('dep-cancel'), depSubmit = $('dep-submit'),
          depUtr = $('dep-utr'), depAmount = $('dep-amount'), depBank = $('dep-bank');

    // ÊèêÊ¨æ
    const wdModal = $('wd-modal'), wdCancel = $('wd-cancel'), wdSubmit = $('wd-submit'),
          wName = $('w-name'), wAc = $('w-ac'), wIfsc = $('w-ifsc'), wUpi = $('w-upi'),
          wdAmount = $('wd-amount'), wdSave = $('wd-save'), rolloverVal = $('rollover-val');

    // ËÆ∞ÂΩï
    const historyModal = $('history-modal'), historyOpen = $('open-history'), historyClose = $('history-close');
    const depositsTbody = $('deposits-tbody'), withdrawalsTbody = $('withdrawals-tbody');

    // ÊîπÂØÜ
    const openChpass = $('open-chpass'), chpassModal = $('chpass-modal'),
          chpassCancel = $('chpass-cancel'), chpassSubmit = $('chpass-submit'),
          oldPass = $('old-pass'), newPass = $('new-pass'), newPass2 = $('new-pass2');

    $('open-deposit').onclick = async()=>{ await loadBankInfoIntoDeposit(); show(depModal,true); };
    $('open-withdraw').onclick = async()=>{ await loadWithdrawProfileIntoModal(); show(wdModal,true); };
    openLogin.onclick = ()=> show(loginModal,true);
    loginCancel.onclick = ()=> show(loginModal,false);
    depCancel.onclick = ()=> show(depModal,false);
    wdCancel.onclick = ()=> show(wdModal,false);

    historyOpen.onclick = async ()=>{ await loadRecentRecords(); show(historyModal, true); };
    historyClose.onclick = ()=> show(historyModal, false);

    openChpass.onclick = ()=> show(chpassModal, true);
    chpassCancel.onclick = ()=> show(chpassModal, false);

    let currentUser = null;
    function setAuthUI(loggedIn){
      $('open-login').style.display = loggedIn ? 'none' : '';
      logoutBtn.style.display = loggedIn ? '' : 'none';
    }

    // Ê≥®ÂÜå/ÁôªÂΩï/ÈÄÄÂá∫
    signupBtn.onclick = async ()=>{
      const email = loginEmail.value.trim(), pass = loginPass.value;
      if(!email || !pass) return toast('Enter email & password');
      const { error } = await supabase.auth.signUp({ email, password: pass });
      if (error) return toast(error.message);
      toast('‚úÖ Signup success. Now login.');
    };
    loginBtn.onclick = async ()=>{
      const email = loginEmail.value.trim(), pass = loginPass.value;
      if(!email || !pass) return toast('Enter email & password');
      const { data, error } = await supabase.auth.signInWithPassword({ email, password: pass });
      if (error) return toast('Login failed: ' + error.message);
      currentUser = data.user;
      show(loginModal,false);
      await afterLogin();
    };
    logoutBtn.onclick = async ()=>{
      await supabase.auth.signOut();
      currentUser = null; userEmail.textContent = '‚Äî'; balanceEl.textContent = '0'; vipBadge.textContent='VIP 0'; setAuthUI(false);
      depositsTbody.innerHTML = `<tr><td colspan="4" class="muted" style="padding:14px">‚Äî</td></tr>`;
      withdrawalsTbody.innerHTML = `<tr><td colspan="3" class="muted" style="padding:14px">‚Äî</td></tr>`;
    };

    async function afterLogin(){
      setAuthUI(true);
      userEmail.textContent = currentUser.email || '‚Äî';
      await supabase.from('users').upsert([{ id: currentUser.id, email: currentUser.email }]);
      await refreshUserSummary();
    }
    async function refreshUserSummary(){
      const { data } = await supabase.from('users')
        .select('balance, vip_level')
        .eq('id', currentUser.id).single();
      balanceEl.textContent = data?.balance ?? 0;
      vipBadge.textContent = `VIP ${Number(data?.vip_level ?? 0)}`;
    }

    async function loadBankInfoIntoDeposit(){
      const { data } = await supabase.from('bank_info').select('*').eq('id', 1).maybeSingle();
      const items = [
        ['Name', data?.name], ['AC', data?.ac], ['IFSC', data?.ifsc],
        ['UPI', data?.upi], ['Crypto', data?.crypto_address]
      ];
      depBank.innerHTML = items.map(([k,v])=>`
        <div class="kv"><div class="k">${k}</div><div class="v">${v || '‚Äî'}</div></div>
      `).join('');
    }

    async function loadWithdrawProfileIntoModal(){
      const { data } = await supabase.from('users')
        .select('name,ac,ifsc,upi,turnover_remaining')
        .eq('id', currentUser.id).single();
      wName.value = data?.name || '';
      wAc.value   = data?.ac || '';
      wIfsc.value = data?.ifsc || '';
      wUpi.value  = data?.upi || '';
      wdAmount.value = '';
      rolloverVal.textContent = fmt2(data?.turnover_remaining);
    }

    depSubmit.onclick = async ()=>{
      if (!currentUser) return toast('Please login first');
      const utr = depUtr.value.trim();
      const amount = Number(depAmount.value);
      if (!utr || !amount || amount <= 0) return toast('Enter UTR & amount');
      const { error } = await supabase.from('recharge_requests').insert([{
        user_id: currentUser.id, email: currentUser.email, utr, amount, status: 'pending'
      }]);
      if (error) return toast('Submit failed: ' + error.message);
      show(depModal,false);
      toast('‚úÖ Recharge request submitted.');
      if (historyModal.style.display === 'flex') await loadRecentRecords();
    };

    wdSave.onclick = async ()=>{
      if (!currentUser) return toast('Please login first');
      const payload = { name:wName.value.trim(), ac:wAc.value.trim(), ifsc:wIfsc.value.trim(), upi:wUpi.value.trim() };
      if (!payload.name || !payload.ac || !payload.ifsc) return toast('Fill Name / AC / IFSC');
      const { error } = await supabase.from('users').update(payload).eq('id', currentUser.id);
      if (error) return toast('Save failed: ' + error.message);
      toast('‚úÖ Profile saved.');
    };

    wdSubmit.onclick = async ()=>{
      if (!currentUser) return toast('Please login first');
      const amount = Number(wdAmount.value);
      if (!amount || amount <= 0) return toast('Enter amount');

      if (!wName.value.trim() || !wAc.value.trim() || !wIfsc.value.trim()) {
        return toast('Please complete withdrawal profile (Name / AC / IFSC).');
      }

      const { data: u } = await supabase.from('users')
        .select('turnover_remaining').eq('id', currentUser.id).single();
      const need = Number(u?.turnover_remaining || 0);
      if (need > 0) {
        return toast(`Rollover not met: ‚Çπ${fmt2(need)} remaining`);
      }

      const { error } = await supabase.rpc('request_withdraw', {
        _user_id: currentUser.id,
        _email: currentUser.email,
        _amount: amount
      });
      if (error) {
        if (String(error.message).includes('TURNOVER_NOT_MET')) {
          return toast('Rollover not met. Please continue betting.');
        }
        return toast('Submit failed: ' + error.message);
      }

      show(wdModal,false);
      toast('‚úÖ Withdraw request submitted.');
      if (historyModal.style.display === 'flex') await loadRecentRecords();
    };

    async function loadRecentRecords(){
      if(!currentUser) return;
      const since = new Date(Date.now() - 3*24*60*60*1000).toISOString();

      const { data: dep, error: depErr } = await supabase
        .from('recharge_requests')
        .select('created_at, utr, amount, status')
        .eq('user_id', currentUser.id)
        .gte('created_at', since)
        .order('created_at', { ascending:false })
        .limit(100);
      if (depErr) {
        depositsTbody.innerHTML = `<tr><td colspan="4" class="muted" style="padding:14px">Load failed: ${depErr.message}</td></tr>`;
      } else if (!dep || dep.length===0){
        depositsTbody.innerHTML = `<tr><td colspan="4" class="muted" style="padding:14px">No records in last 3 days</td></tr>`;
      } else {
        depositsTbody.innerHTML = dep.map(r=>`
          <tr>
            <td>${fmtTime(r.created_at)}</td>
            <td>${r.utr ?? '‚Äî'}</td>
            <td>${fmt2(r.amount)}</td>
            <td><span class="tag ${String(r.status).toLowerCase()}">${r.status}</span></td>
          </tr>`).join('');
      }

      const { data: wd, error: wdErr } = await supabase
        .from('withdraw_requests')
        .select('created_at, amount, status')
        .eq('user_id', currentUser.id)
        .gte('created_at', since)
        .order('created_at', { ascending:false })
        .limit(100);
      if (wdErr) {
        withdrawalsTbody.innerHTML = `<tr><td colspan="3" class="muted" style="padding:14px">Load failed: ${wdErr.message}</td></tr>`;
      } else if (!wd || wd.length===0){
        withdrawalsTbody.innerHTML = `<tr><td colspan="3" class="muted" style="padding:14px">No records in last 3 days</td></tr>`;
      } else {
        withdrawalsTbody.innerHTML = wd.map(r=>`
          <tr>
            <td>${fmtTime(r.created_at)}</td>
            <td>${fmt2(r.amount)}</td>
            <td><span class="tag ${String(r.status).toLowerCase()}">${r.status}</span></td>
          </tr>`).join('');
      }
    }

    chpassSubmit.onclick = async ()=>{
      try{
        if (!currentUser) return toast('Please login first');
        const email = currentUser.email;
        const oldP = oldPass.value, np = newPass.value, np2 = newPass2.value;
        if (!oldP || !np || !np2) return toast('Fill all fields');
        if (np.length < 6) return toast('New password must be at least 6 characters');
        if (np !== np2) return toast('New passwords do not match');

        const { error: reauthErr } = await supabase.auth.signInWithPassword({ email, password: oldP });
        if (reauthErr) return toast('Current password is incorrect');

        const { error: updErr } = await supabase.auth.updateUser({ password: np });
        if (updErr) return toast('Update failed: ' + updErr.message);

        oldPass.value = newPass.value = newPass2.value = '';
        show(chpassModal, false);
        toast('‚úÖ Password updated');
      }catch(e){
        toast('Update failed: ' + (e?.message || e));
      }
    };

    (async ()=>{
      const { data:{ user } } = await supabase.auth.getUser();
      if (user){ currentUser=user; await afterLogin(); } else { setAuthUI(false); }
    })();
  </script>
</body>
</html>
