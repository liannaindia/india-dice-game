<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Ganeshcasino ¬∑ Lobby</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />

  <!-- Supabase configÔºà‰øùÊåÅ‰∏çÂèòÔºâ -->
  <script type="module" src="./supabase-config.js"></script>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">

  <!-- PWA manifest -->
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#0b1220">

  <!-- iOS PWA -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Ganeshcasino">
  <link rel="apple-touch-icon" href="/icons/apple-icon-180.png">

  <!-- Service Worker -->
  <script>
    if ('serviceWorker' in navigator) {
      addEventListener('load', () => navigator.serviceWorker.register('/service-worker.js'));
    }
  </script>

  <style>
    /* ================= Brand System (Dark + Neon) ================= */
    :root{
      --bg-0:#070b16; --bg-1:#0b1220; --bg-2:#0c1628;
      --glass:#0f1627cc;               /* glass card */
      --text:#e6edf7; --muted:#8ea0bf; --line:#26324a;
      --gold:#f4d26b; --gold-2:#ffd984; --gold-3:#f3b44b;
      --primary:#7c5cff; --primary-2:#5d2df6;
      --accent:#00e5ff; --accent-2:#00bcd4;
      --danger:#ff5d6c; --success:#22c55e;
      --radius:18px; --shadow:0 20px 60px rgba(0,0,0,.35);
      --safe-b: env(safe-area-inset-bottom, 0px);
      --safe-t: env(safe-area-inset-top, 0px);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:'Poppins',system-ui,Segoe UI,Roboto,Arial; color:var(--text);
      background:
        radial-gradient(1000px 420px at 80% -20%, #1a2455 0%, transparent 60%),
        radial-gradient(900px 420px at 10% -10%, #0a1e3a 0%, transparent 60%),
        linear-gradient(180deg, var(--bg-0), var(--bg-1) 30%, var(--bg-2) 100%);
      overflow-x:hidden;
    }
    /* ÊòüÁÇπ/Êï£ÊôØ */
    body::before{
      content:""; position:fixed; inset:-20% -10%; z-index:-1; opacity:.65; pointer-events:none;
      background:
        radial-gradient(3px 3px at 12% 14%, #ffffff22 50%, transparent 60%) repeat,
        radial-gradient(6px 6px at 60% 18%, #ffffff18 50%, transparent 60%) repeat,
        radial-gradient(2px 2px at 80% 30%, #ffffff12 50%, transparent 60%) repeat;
      background-size:120px 120px, 180px 180px, 140px 140px;
      filter:saturate(120%) blur(.2px);
    }

    /* ================= Top Nav ================= */
    .nav{
      position:sticky; top:0; z-index:50;
      backdrop-filter:saturate(170%) blur(12px);
      background:linear-gradient(180deg,#0d1323cc,#0d132399);
      border-bottom:1px solid #162036;
      padding-top:var(--safe-t);
    }
    .nav-inner{
      max-width:1200px; margin:0 auto; padding:10px 14px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .brand{display:flex; align-items:center; gap:10px; font-weight:800; letter-spacing:.3px}
    .logo{
      width:40px;height:40px;border-radius:12px; position:relative; display:grid; place-items:center;
      background:radial-gradient(circle at 30% 30%, #fff 0, #ffe6a6 40%, #f0b84e 70%, #7a4e0a 100%);
      box-shadow:inset 0 1px 0 #fff9, 0 12px 26px rgba(0,0,0,.35);
      border:1px solid #e6b95a55; overflow:hidden;
    }
    .logo::after{
      content:""; position:absolute; inset:-40% -40%;
      background:conic-gradient(from 0deg, #ffd36a22, #ff5ea855, #6f75ff44, #27e7ff55, #ffd36a22);
      mix-blend-mode:screen; animation:spin 7s linear infinite;
    }
    @keyframes spin{to{transform:rotate(360deg)}}
    .brand-name{font-size:clamp(14px, 2.8vw, 18px)}
    .actions{display:flex;gap:8px;flex-wrap:nowrap}
    .btn{
      display:inline-flex;align-items:center;justify-content:center;gap:8px;height:42px;padding:0 14px;
      border-radius:12px;border:1px solid #26324a;background:#111a2f;color:var(--text);
      cursor:pointer;font-weight:700;font-size:14px; transition:all .18s ease;
    }
    .btn:hover{transform:translateY(-1px)}
    .btn.primary{
      border:0;color:#0b1220;background:linear-gradient(180deg, var(--gold), var(--gold-3));
      box-shadow:0 10px 24px #ffcc5588;
    }
    .btn.ghost{background:#0f1627;border-color:#22304a}
    a.btn{text-decoration:none;color:inherit}

    /* ================= Hero ================= */
    .hero{max-width:1200px;margin:10px auto 0;padding:0 14px}
    .hero-banner{
      position:relative;border-radius:22px;overflow:hidden;
      border:1px solid #2a3754; box-shadow:var(--shadow);
      background:
        radial-gradient(1200px 420px at 0% 0%, #1a2550 0%, transparent 60%),
        radial-gradient(900px 380px at 100% 0%, #0e2c4c 0%, transparent 60%),
        linear-gradient(120deg,#0f1830,#0b1427 40%, #0b1324);
      display:grid; grid-template-columns:1.05fr .95fr; gap:0; align-items:center;
    }
    @media(max-width:860px){ .hero-banner{grid-template-columns:1fr} }
    .hero-copy{padding:18px 18px 16px 18px}
    .hero-title{
      font-weight:900; line-height:1.2; letter-spacing:.2px;
      font-size:clamp(20px, 5vw, 34px);
      background:linear-gradient(180deg,#fff,#dbe7ff);
      -webkit-background-clip:text; background-clip:text; color:transparent;
      text-shadow:0 0 0 #fff0, 0 24px 60px #0008;
    }
    .hero-sub{color:var(--muted); margin-top:6px; font-size:clamp(12px, 3.6vw, 15px)}
    .hero-cta{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px}
    .pill{
      padding:8px 12px;border-radius:999px;border:1px solid #374564;background:#121c33cc;
      color:#c9d6f2;font-weight:700;font-size:12px;display:inline-flex;align-items:center;gap:8px
    }

    .hero-art{position:relative; min-height:220px; padding:10px}
    .glow{
      position:absolute; inset:-40% -20%; pointer-events:none; z-index:0;
      background:radial-gradient(60% 60% at 60% 30%, #6d75ff33, transparent 60%),
                 radial-gradient(60% 60% at 30% 60%, #00e5ff22, transparent 60%);
      filter:blur(28px);
    }
    .ganesh-wrap{position:relative; z-index:1; display:grid; place-items:center; filter:drop-shadow(0 16px 32px #0009)}
    .ganesh{width:min(360px, 86%); height:auto; opacity:.96; stroke:#ffc86d}
    .coins{position:absolute; inset:0; pointer-events:none; z-index:2}
    .coin{
      position:absolute; width:14px; height:14px; border-radius:50%;
      background:radial-gradient(circle at 35% 35%, #fff6c2 0, #ffe07a 40%, #d8a937 72%, #8a640f 100%);
      box-shadow:0 2px 6px rgba(0,0,0,.35); opacity:.9; animation:fall 7.2s linear infinite;
    }
    @keyframes fall{0%{transform:translateY(-40px) translateX(0) rotate(0)} 100%{transform:translateY(280px) translateX(40px) rotate(520deg)}}
    .coin.c1{left:12%; top:-6px;  animation-delay:.2s}
    .coin.c2{left:28%; top:-16px; animation-delay:1.1s}
    .coin.c3{left:70%; top:-14px; animation-delay:.8s}
    .coin.c4{left:86%; top:2px;   animation-delay:2.2s}

    /* ================= Containers / Cards ================= */
    .wrap{max-width:1200px;margin:0 auto;padding:14px}
    .card{
      background:linear-gradient(180deg,#0c1427ed,#0b1324ef);
      border:1px solid #2a3754;border-radius:var(--radius);box-shadow:var(--shadow);position:relative; overflow:hidden;
    }
    .card::after{
      content:""; position:absolute; inset:0; pointer-events:none; border-radius:inherit;
      background:linear-gradient(120deg, transparent 10%, #ffd36a33 50%, transparent 90%);
      mask:linear-gradient(#000,#000) padding-box, linear-gradient(#000,#000);
      -webkit-mask-composite: xor; mask-composite: exclude;
    }
    .inner{padding:16px}

    /* ================= User block ================= */
    .user{display:grid;grid-template-columns:1fr auto;gap:14px;align-items:center}
    @media(max-width:560px){ .user{grid-template-columns:1fr} }
    .hello{font-size:12px;color:var(--muted)}
    .balance-row{display:flex;align-items:center;gap:10px;justify-content:flex-end}
    .balance-tag{
      display:inline-flex;align-items:center;gap:6px;
      background:linear-gradient(180deg,#071021,#0c1428); border:1px solid #2a3754;
      padding:10px 12px;border-radius:12px; font-weight:800; color:#b7f0c7;
      box-shadow:inset 0 -1px 0 #0006, 0 8px 24px #0006;
    }
    .vip-badge{
      display:inline-flex;align-items:center;gap:6px;padding:8px 10px;border-radius:999px;
      background:linear-gradient(180deg,#ffd36a,#f3b44b); color:#2d1e00;font-weight:900;
      box-shadow:0 6px 16px #ffca5f55; border:0;
    }
    .quick{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}

    /* ================= Game Grid ================= */
    .games{display:grid;gap:14px;grid-template-columns:1fr}
    @media(min-width:560px){ .games{grid-template-columns:repeat(2,1fr)} }
    @media(min-width:980px){ .games{grid-template-columns:repeat(3,1fr)} }

    .game{
      display:flex;flex-direction:column;gap:10px;padding:12px;border-radius:16px;
      background:linear-gradient(180deg,#0f182f,#0d152a); border:1px solid #283759;
      transition:transform .18s ease, box-shadow .18s ease; position:relative; overflow:hidden; min-height:172px;
    }
    .game:hover{ transform:translateY(-2px); box-shadow:0 18px 42px rgba(0,0,0,.35); }
    .game::before{
      content:""; position:absolute; right:-16px; top:-16px; width:140px; height:140px; opacity:.16; border-radius:50%;
      background:
        radial-gradient(circle at 50% 70%, #7c5cff 0 18%, transparent 18.5% 100%),
        radial-gradient(circle at 18% 56%, #00e5ff 0 18%, transparent 18.5% 100%),
        radial-gradient(circle at 82% 56%, #ffd36a 0 18%, transparent 18.5% 100%);
      filter:saturate(1.15);
    }
    .thumb{height:98px;border-radius:12px;position:relative;overflow:hidden;border:1px solid #2a3754;display:grid;place-items:center}
    .thumb::after{content:""; position:absolute; inset:0; background:linear-gradient(180deg,#ffffff05,#ffffff00); pointer-events:none}
    .thumb.wingo{background:radial-gradient(120% 120% at 0% 0%, #182a48 0, #0e1c33 60%, #0b1424 100%)}
    .thumb.wheel{background:radial-gradient(120% 120% at 0% 0%, #202a5a 0, #101c37 60%, #0b1424 100%)}
    .thumb.dice{ background:radial-gradient(120% 120% at 0% 0%, #2a2155 0, #131b35 60%, #0b1424 100%) }
    .thumb.ab  { background:radial-gradient(120% 120% at 0% 0%, #3c1b24 0, #1a1633 60%, #0b1424 100%) }

    /* svg/emoji Ë£ÖÈ•∞ */
    .chip3d{
      width:84px;height:84px;border-radius:50%;
      background:
        radial-gradient(circle at 50% 55%, #fff 0 12px, transparent 12px),
        conic-gradient(from 0deg, #00e5ff 0 20%, transparent 20% 40%, #ffd36a 40% 60%, transparent 60% 80%, #7c5cff 80% 100%),
        radial-gradient(circle at 50% 50%, #051022 0, #0b172d 55%, #18294a 70%, #090f1d 100%);
      box-shadow:inset 0 0 0 6px #09152d, inset 0 0 30px #0006, 0 16px 28px #0008;
      transform:rotate(20deg);
    }
    .dice3d{
      width:74px;height:74px;border-radius:12px;background:#fff;
      box-shadow:0 16px 26px #0005; transform:rotate(15deg);
      background-image:
        radial-gradient(circle at 50% 50%, #000 0 7px, transparent 7.2px),
        radial-gradient(circle at 22% 22%, #000 0 7px, transparent 7.2px),
        radial-gradient(circle at 78% 78%, #000 0 7px, transparent 7.2px);
      background-repeat:no-repeat; background-position:center, 22% 22%, 78% 78%;
    }
    .wheel3d{
      width:90px;height:90px;border-radius:50%;
      border:10px solid #0b1424; box-shadow:inset 0 0 0 10px #ffd36a, inset 0 0 0 20px #ff7b2e, inset 0 0 0 30px #7c5cff, 0 16px 26px #0006;
    }
    .ab3d{
      width:94px;height:66px;border-radius:10px; background:linear-gradient(45deg,#e23e54,#8c1730);
      box-shadow:0 16px 26px #0006; border:6px solid #ffd36a;
    }

    .title{font-weight:800; font-size:16px}
    .desc{color:#a9b7d4;font-size:13px}
    .game .btn{width:100%; margin-top:auto; height:42px}

    /* ================= Modals (glass) ================= */
    .modal-bg{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:#020a1bb3;backdrop-filter:blur(8px);z-index:100}
    .modal{
      width:100vw; max-width:760px; margin:0; background:linear-gradient(180deg,#0d1427,#0b1324);
      border-radius:22px;border:1px solid #2a3754;box-shadow:var(--shadow); max-height:92vh; display:flex;flex-direction:column; overflow:hidden;
    }
    .modal header{padding:14px 16px;border-bottom:1px solid #22304a;font-weight:800;background:#0e172ccc}
    .modal .body{padding:16px; overflow:auto}
    .modal footer{display:flex;gap:10px;padding:12px 16px;border-top:1px solid #22304a; justify-content:flex-end; padding-bottom:calc(12px + var(--safe-b))}
    input{
      width:100%;height:46px;border-radius:12px;border:1px solid #253453;background:#0d162b;color:#d8e4ff;padding:0 12px;font-size:15px;
    }
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid #203355;font-size:14px}
    th{background:#0e172c;text-align:left}

    .tag{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid #203355}
    .tag.pending{background:#2b1b00;color:#ffb74d;border-color:#5a3b00}
    .tag.approved{background:#062b1a;color:#6be1a3;border-color:#144e36}
    .tag.rejected{background:#3b0a12;color:#ff97a1;border-color:#6b0e1b}

    /* Deposit panes */
    .channel-switch{display:flex;gap:8px;margin-bottom:12px; overflow:auto; padding-bottom:2px}
    .channel-btn{
      padding:10px 14px;border:1px solid #253453;border-radius:12px;background:#0d162b;color:#d8e4ff;cursor:pointer;font-weight:700; flex:0 0 auto;
    }
    .channel-btn.active{background:#101b35; box-shadow:0 10px 22px #0005; border-color:#394c77}
    .dep-pane{display:none}
    .dep-pane.active{display:block}
    .kv{display:flex;justify-content:space-between;gap:12px;padding:10px;border:1px dashed #2a3a60;border-radius:12px;background:#0c1427}
    .kv .k{color:#9bb0d8} .kv .v{font-weight:800}

    /* Floating buttons */
    #installAppBtn{
      position:fixed; right:14px; bottom:calc(16px + var(--safe-b)); z-index:9999;
      padding:12px 14px; border:0; border-radius:12px;
      background:linear-gradient(180deg,#00e5ff,#00c3e2); color:#03202a; font-weight:900;
      box-shadow:0 10px 30px #00e5ff66; font-size:14px;
    }

    /* Diya (good luck) */
    .diya{
      position:fixed; left:14px; bottom:calc(16px + var(--safe-b)); width:54px; height:54px; z-index:20;
      border-radius:16px; background:radial-gradient(circle at 50% 60%, #ffdf9a, #ffb94f);
      border:1px solid #fbd27a; box-shadow:0 12px 28px rgba(255,140,0,.25); display:grid; place-items:center;
    }
    .flame{
      width:16px; height:24px; border-radius:50% 50% 50% 50%/60% 60% 40% 40%;
      background:radial-gradient(circle at 50% 20%, #fff 0, #ffe082 40%, #ff8f00 70%, transparent 72%);
      animation:flicker 1.6s ease-in-out infinite; filter:drop-shadow(0 0 12px rgba(255,159,0,.6));
    }
    @keyframes flicker{0%,100%{transform:translateY(0) scale(1)} 50%{transform:translateY(-1px) scale(1.04)}}
  </style>
</head>
<body>

  <!-- Install PWA -->
  <button id="installAppBtn" aria-label="Install Ganeshcasino">Install Ganeshcasino</button>
  <script>
    const btn = document.getElementById('installAppBtn');
    let deferredPrompt = null;
    window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); deferredPrompt = e; });
    btn.addEventListener('click', async () => {
      const ua = navigator.userAgent.toLowerCase();
      const isIOS = /iphone|ipad|ipod/.test(ua);
      const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
      if (deferredPrompt) {
        btn.disabled = true;
        try { deferredPrompt.prompt(); await deferredPrompt.userChoice; }
        finally { deferredPrompt = null; btn.disabled = false; }
        return;
      }
      if (isIOS && isSafari) {
        alert('On iPhone:\n1) Open this site in Safari\n2) Tap the Share button (‚¨ÜÔ∏è)\n3) Choose "Add to Home Screen"');
      } else if (isIOS) {
        alert('To install on iPhone, open this site in Safari, then use "Add to Home Screen".');
      } else {
        alert('Use your browser menu ‚Üí "Add to Home screen" or "Install app".');
      }
    });
  </script>

  <!-- NAV -->
  <div class="nav">
    <div class="nav-inner">
      <div class="brand">
        <div class="logo">ü™î</div>
        <div class="brand-name">Ganeshcasino</div>
      </div>
      <div class="actions">
        <a id="cs-link" class="btn ghost" href="https://t.me/customerservice7777777" target="_blank">üí¨ Customer Service</a>
        <button id="open-login" class="btn primary">Login / Signup</button>
        <button id="logout-btn" class="btn ghost" style="display:none">Logout</button>
      </div>
    </div>
  </div>

  <!-- HERO -->
  <section class="hero">
    <div class="hero-banner">
      <div class="hero-copy">
        <div class="hero-title">Play Smart. Win Bright.</div>
        <div class="hero-sub">Premium Indian-style games with lightning results and instant balance updates.</div>
        <div class="hero-cta">
          <span class="pill">‚úÖ Fast settlement</span>
          <span class="pill">üîí Secure wallet</span>
          <span class="pill">üïí 24/7 support</span>
        </div>
      </div>
      <div class="hero-art" aria-hidden="true">
        <div class="glow"></div>
        <div class="ganesh-wrap">
          <svg class="ganesh" viewBox="0 0 512 512" fill="none" stroke="#ffc86d" stroke-width="10" stroke-linecap="round" stroke-linejoin="round">
            <path d="M256 60c-40 0-72 32-72 72 0 24 12 46 30 59-21 8-46 25-46 61 0 43 34 78 88 78s88-35 88-78c0-36-25-53-46-61 18-13 30-35 30-59 0-40-32-72-72-72z"/>
            <path d="M168 195c-45 16-72 52-72 98 0 62 54 112 160 112s160-50 160-112c0-46-27-82-72-98"/>
            <path d="M168 195c10-16 34-36 56-40"/>
            <path d="M344 195c-10-16-34-36-56-40"/>
            <path d="M210 294c18 18 74 18 92 0"/>
            <path d="M140 372c22 16 64 34 116 34s94-18 116-34"/>
            <path d="M256 60V36M212 68l-8-20M300 68l8-20"/>
          </svg>
          <div class="coins">
            <div class="coin c1"></div><div class="coin c2"></div><div class="coin c3"></div><div class="coin c4"></div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- CONTENT -->
  <div class="wrap">
    <!-- User Card -->
    <div class="card">
      <div class="inner user">
        <div>
          <div class="hello">Logged in as</div>
          <div id="user-email" style="font-weight:800">‚Äî</div>
          <div class="quick">
            <button id="open-deposit" class="btn primary">Deposit</button>
            <button id="open-withdraw" class="btn">Withdraw</button>
            <button id="open-history" class="btn">My Records</button>
            <button id="open-chpass" class="btn ghost">Change Password</button>
          </div>
        </div>
        <div class="balance-row">
          <span class="balance-tag">‚Çπ<span id="balance">0</span></span>
          <span id="vip-badge" class="vip-badge" title="VIP Level">VIP 0</span>
        </div>
      </div>
    </div>

    <!-- Games -->
    <div class="card" style="margin-top:14px">
      <div class="inner">
        <div style="font-weight:800;margin-bottom:8px">üéÆ Select a Game</div>

        <!-- WinGo Á™ÅÂá∫Âç°Áâá -->
        <div class="game" style="border-color:#3e2f6b;background:linear-gradient(180deg,#111538,#0e122f)">
          <div class="thumb wingo"><div class="chip3d"></div></div>
          <div class="title">WinGo ¬∑ 2 minutes</div>
          <div class="desc">Pick Green/Red/Violet, Big/Small, or 0‚Äì9. Draw every 2 minutes (IST).</div>
          <a class="btn primary" href="./color2m.html">Play</a>
        </div>

        <div class="games" style="margin-top:14px">
          <div class="game">
            <div class="thumb wheel"><div class="wheel3d"></div></div>
            <div class="title">Mini Wheel</div>
            <div class="desc">2-minute rounds (IST). Bet Small/Big or 3‚Äì18.</div>
            <a class="btn primary" href="./mini-wheel.html">Play</a>
          </div>

          <div class="game">
            <div class="thumb dice"><div class="dice3d"></div></div>
            <div class="title">Lucky Dice</div>
            <div class="desc">Bet on Big/Small or exact number. Results every minute (IST).</div>
            <a class="btn primary" href="./dice.html">Play</a>
          </div>

          <div class="game">
            <div class="thumb ab"><div class="ab3d"></div></div>
            <div class="title">Andar Bahar</div>
            <div class="desc">Bet on Andar or Bahar. Result every minute (IST).</div>
            <a class="btn primary" href="./ab.html">Play</a>
          </div>

          <div class="game">
            <div class="thumb"><div class="chip3d" style="filter:hue-rotate(120deg)"></div></div>
            <div class="title">Coming Soon</div>
            <div class="desc">More India-style games are on the way.</div>
            <button class="btn" disabled>Stay tuned</button>
          </div>

          <div class="game">
            <div class="thumb"><div class="chip3d" style="filter:hue-rotate(220deg)"></div></div>
            <div class="title">Coming Soon</div>
            <div class="desc">Unlock new experiences for your players.</div>
            <button class="btn" disabled>Stay tuned</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Diya -->
  <div class="diya" title="Good luck"><div class="flame"></div></div>

  <!-- ===== Modals (IDs ‰øùÊåÅ‰∏çÂèò) ===== -->

  <!-- Login Modal -->
  <div id="login-modal" class="modal-bg">
    <div class="modal">
      <header>Login / Signup</header>
      <div class="body">
        <div class="form">
          <input id="login-email" type="email" placeholder="Email" />
          <input id="login-pass" type="password" placeholder="Password" />
          <div class="muted">New user? Click ‚ÄúSignup‚Äù then login.</div>
        </div>
      </div>
      <footer>
        <button id="login-cancel" class="btn">Cancel</button>
        <button id="signup-btn" class="btn">Signup</button>
        <button id="login-btn" class="btn primary">Login</button>
      </footer>
    </div>
  </div>

  <!-- Deposit Modal -->
  <div id="dep-modal" class="modal-bg">
    <div class="modal">
      <header>Deposit</header>
      <div class="body">
        <div class="channel-switch">
          <button id="btn-inr"  class="channel-btn active">INR ¬∑ UPI / Bank</button>
          <button id="btn-usdt" class="channel-btn">USDT ¬∑ TRC20 ¬∑ 1USDT=100rs</button>
        </div>

        <div id="pane-inr" class="dep-pane active">
          <div class="muted" style="margin-bottom:8px">Transfer to the account below, then submit UTR and amount.</div>
          <div id="dep-bank" class="form" style="margin-bottom:8px">
            <div class="kv"><div class="k">Name</div><div class="v">‚Äî</div></div>
            <div class="kv"><div class="k">AC</div><div class="v">‚Äî</div></div>
            <div class="kv"><div class="k">IFSC</div><div class="v">‚Äî</div></div>
            <div class="kv"><div class="k">UPI</div><div class="v">‚Äî</div></div>
          </div>
          <div class="form">
            <input id="dep-utr" type="text" placeholder="UTR / Reference Number" />
            <input id="dep-amount" type="number" min="1" placeholder="Amount ‚Çπ" />
          </div>
        </div>

        <div id="pane-usdt" class="dep-pane">
          <div class="form">
            <div class="muted" style="margin-bottom:6px">USDT (TRC20) Deposit Address ¬∑ 1USDT=100rs</div>
            <div class="kv"><div class="k">Address</div><div class="v" style="max-width:60%;overflow:hidden;text-overflow:ellipsis;white-space:nowrap"><input id="usdt-address" type="text" readonly placeholder="Loading address‚Ä¶" /></div></div>
            <div class="channel-switch" style="margin:8px 0 0 0">
              <button id="copy-usdt" class="btn">Copy Address</button>
            </div>
            <input id="usdt-txid" type="text" placeholder="TXID / Transaction Hash" />
            <input id="usdt-amount" type="number" min="0.01" step="0.01" placeholder="Amount (USDT)" />
          </div>
        </div>
      </div>
      <footer>
        <button id="dep-cancel" class="btn">Cancel</button>
        <button id="dep-submit" class="btn primary">Submit</button>
      </footer>
    </div>
  </div>

  <!-- Withdraw Modal -->
  <div id="wd-modal" class="modal-bg">
    <div class="modal">
      <header>Withdraw</header>
      <div class="body">
        <div class="form">
          <div class="kv" id="rollover-kv"><div class="k">Rollover Needed</div><div class="v" id="rollover-val">0.00</div></div>
          <div class="row" style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
            <input id="w-name" placeholder="Your Name" />
            <input id="w-ac" placeholder="AC Number" />
          </div>
          <div class="row" style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
            <input id="w-ifsc" placeholder="IFSC Code" />
            <input id="w-upi" placeholder="UPI ID (optional)" />
          </div>
          <div class="row" style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
            <input id="wd-amount" type="number" min="1" placeholder="Amount ‚Çπ" />
            <button id="wd-save" class="btn">Save Profile</button>
          </div>
          <div class="muted">Save your bank profile first if you modified it.</div>
        </div>
      </div>
      <footer>
        <button id="wd-cancel" class="btn">Cancel</button>
        <button id="wd-submit" class="btn primary">Submit Withdrawal</button>
      </footer>
    </div>
  </div>

  <!-- History Modal -->
  <div id="history-modal" class="modal-bg">
    <div class="modal">
      <header>My Records (Last 3 Days)</header>
      <div class="body">
        <div class="muted" style="margin-bottom:10px">Showing recent 3 days</div>
        <div style="margin-top:12px;display:grid;grid-template-columns:1fr;gap:16px">
          <div>
            <div style="font-weight:700;margin:6px 0 8px 0">Deposits</div>
            <div class="card" style="border-radius:12px">
              <div class="inner" style="padding:0">
                <table>
                  <thead><tr><th>Time</th><th>UTR</th><th>Amount (‚Çπ)</th><th>Status</th></tr></thead>
                  <tbody id="deposits-tbody"><tr><td colspan="4" class="muted" style="padding:14px">‚Äî</td></tr></tbody>
                </table>
              </div>
            </div>
          </div>
          <div>
            <div style="font-weight:700;margin:6px 0 8px 0">Withdrawals</div>
            <div class="card" style="border-radius:12px">
              <div class="inner" style="padding:0">
                <table>
                  <thead><tr><th>Time</th><th>Amount (‚Çπ)</th><th>Status</th></tr></thead>
                  <tbody id="withdrawals-tbody"><tr><td colspan="3" class="muted" style="padding:14px">‚Äî</td></tr></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

      </div>
      <footer><button id="history-close" class="btn">Close</button></footer>
    </div>
  </div>

  <!-- Change Password Modal -->
  <div id="chpass-modal" class="modal-bg">
    <div class="modal">
      <header>Change Password</header>
      <div class="body">
        <div class="form">
          <input id="old-pass" type="password" placeholder="Current Password" />
          <input id="new-pass" type="password" placeholder="New Password (min 6 chars)" />
          <input id="new-pass2" type="password" placeholder="Confirm New Password" />
          <div class="muted">We will verify your current password before updating.</div>
        </div>
      </div>
      <footer>
        <button id="chpass-cancel" class="btn">Cancel</button>
        <button id="chpass-submit" class="btn primary">Update Password</button>
      </footer>
    </div>
  </div>

  <!-- ===== ÈÄªËæëÔºö‰øùÊåÅ‰Ω†ÁöÑÂéüÁîü JS Ë°å‰∏∫‰∏çÂèòÔºàÂè™ÁßªÊ§ç UIÔºâ ===== -->
  <script type="module">
    import { supabase } from './supabase-config.js';

    const $ = (id)=>document.getElementById(id);
    const show = (el,on=true)=> el.style.display = on ? 'flex' : 'none';
    const toast = (m)=>alert(m);
    const fmt2 = (n)=> Number(n ?? 0).toFixed(2);
    const fmtTime = (iso)=> {
      try{
        const d = new Date(iso);
        return d.toLocaleString(undefined,{ year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit' });
      }catch{ return iso || '‚Äî'; }
    };

    const openLogin = $('open-login');
    const logoutBtn = $('logout-btn');
    const userEmail = $('user-email');
    const balanceEl = $('balance');
    const vipBadge  = $('vip-badge');

    const loginModal = $('login-modal'), loginCancel = $('login-cancel'),
          signupBtn = $('signup-btn'), loginBtn = $('login-btn'),
          loginEmail = $('login-email'), loginPass = $('login-pass');

    const depModal = $('dep-modal'), depCancel = $('dep-cancel'), depSubmit = $('dep-submit'),
          depUtr = $('dep-utr'), depAmount = $('dep-amount');

    const wdModal = $('wd-modal'), wdCancel = $('wd-cancel'), wdSubmit = $('wd-submit'),
          wName = $('w-name'), wAc = $('w-ac'), wIfsc = $('w-ifsc'), wUpi = $('w-upi'),
          wdAmount = $('wd-amount'), wdSave = $('wd-save'), rolloverVal = $('rollover-val');

    const historyModal = $('history-modal');
    const historyOpen = $('open-history');
    const historyClose = $('history-close');
    const depositsTbody = $('deposits-tbody');
    const withdrawalsTbody = $('withdrawals-tbody');

    const openChpass = $('open-chpass');
    const chpassModal = $('chpass-modal');
    const chpassCancel = $('chpass-cancel');
    const chpassSubmit = $('chpass-submit');
    const oldPass = $('old-pass'), newPass = $('new-pass'), newPass2 = $('new-pass2');

    const btnINR   = $('btn-inr');
    const btnUSDT  = $('btn-usdt');
    const paneINR  = $('pane-inr');
    const paneUSDT = $('pane-usdt');
    const usdtAddr = $('usdt-address');
    const usdtCopy = $('copy-usdt');
    const usdtTxid = $('usdt-txid');
    const usdtAmount = $('usdt-amount');
    let depChannel = 'inr';

    $('open-deposit').onclick = async ()=>{
      depChannel = 'inr';
      btnINR.classList.add('active'); btnUSDT.classList.remove('active');
      paneINR.classList.add('active'); paneUSDT.classList.remove('active');

      await loadBankInfoIntoDeposit();

      try{
        const { data } = await supabase.from('bank_info').select('crypto_address').eq('id',1).maybeSingle();
        usdtAddr.value = data?.crypto_address || '';
        if(!usdtAddr.value) usdtAddr.placeholder = 'No TRC20 address configured';
      }catch{ usdtAddr.value = ''; }

      usdtTxid.value = '';
      usdtAmount.value = '';

      show(depModal,true);
    };

    $('open-withdraw').onclick = async()=>{ await loadWithdrawProfileIntoModal(); show(wdModal,true); };
    openLogin.onclick = ()=> show(loginModal,true);
    loginCancel.onclick = ()=> show(loginModal,false);
    depCancel.onclick = ()=> show(depModal,false);
    wdCancel.onclick = ()=> show(wdModal,false);

    historyOpen.onclick = async ()=>{ await loadRecentRecords(); show(historyModal, true); };
    historyClose.onclick = ()=> show(historyModal, false);

    openChpass.onclick = ()=> show(chpassModal, true);
    chpassCancel.onclick = ()=> show(chpassModal, false);

    btnINR.onclick = ()=>{ depChannel='inr'; btnINR.classList.add('active'); btnUSDT.classList.remove('active'); paneINR.classList.add('active'); paneUSDT.classList.remove('active'); };
    btnUSDT.onclick = ()=>{ depChannel='usdt'; btnUSDT.classList.add('active'); btnINR.classList.remove('active'); paneUSDT.classList.add('active'); paneINR.classList.remove('active'); };

    usdtCopy.onclick = async ()=>{ try{ if(usdtAddr.value){ await navigator.clipboard.writeText(usdtAddr.value); toast('Address copied'); } }catch{ toast('Copy failed'); } };

    let currentUser = null;
    function setAuthUI(loggedIn){
      $('open-login').style.display = loggedIn ? 'none' : '';
      logoutBtn.style.display = loggedIn ? '' : 'none';
    }

    signupBtn.onclick = async ()=>{
      const email = loginEmail.value.trim(), pass = loginPass.value;
      if(!email || !pass) return toast('Enter email & password');
      const { error } = await supabase.auth.signUp({ email, password: pass });
      if (error) return toast(error.message);
      toast('‚úÖ Signup success. Now login.');
    };
    loginBtn.onclick = async ()=>{
      const email = loginEmail.value.trim(), pass = loginPass.value;
      if(!email || !pass) return toast('Enter email & password');
      const { data, error } = await supabase.auth.signInWithPassword({ email, password: pass });
      if (error) return toast('Login failed: ' + error.message);
      currentUser = data.user;
      show(loginModal,false);
      await afterLogin();
    };
    logoutBtn.onclick = async ()=>{
      await supabase.auth.signOut();
      currentUser = null; userEmail.textContent = '‚Äî'; balanceEl.textContent = '0'; vipBadge.textContent='VIP 0'; setAuthUI(false);
      depositsTbody.innerHTML = `<tr><td colspan="4" class="muted" style="padding:14px">‚Äî</td></tr>`;
      withdrawalsTbody.innerHTML = `<tr><td colspan="3" class="muted" style="padding:14px">‚Äî</td></tr>`;
    };

    async function afterLogin(){
      setAuthUI(true);
      userEmail.textContent = currentUser.email || '‚Äî';
      await supabase.from('users').upsert([{ id: currentUser.id, email: currentUser.email }]);
      await refreshUserSummary();
    }
    async function refreshUserSummary(){
      const { data } = await supabase.from('users').select('balance, vip_level').eq('id', currentUser.id).single();
      balanceEl.textContent = data?.balance ?? 0;
      vipBadge.textContent = `VIP ${Number(data?.vip_level ?? 0)}`;
    }

    async function loadBankInfoIntoDeposit(){
      const { data } = await supabase.from('bank_info').select('*').eq('id', 1).maybeSingle();
      const items = [
        ['Name', data?.name], ['AC', data?.ac], ['IFSC', data?.ifsc],
        ['UPI', data?.upi], ['Crypto', data?.crypto_address]
      ];
      document.getElementById('dep-bank').innerHTML = items.map(([k,v])=>`
        <div class="kv"><div class="k">${k}</div><div class="v">${v || '‚Äî'}</div></div>
      `).join('');
    }

    async function loadWithdrawProfileIntoModal(){
      const { data } = await supabase.from('users')
        .select('name,ac,ifsc,upi,turnover_remaining')
        .eq('id', currentUser.id).single();
      $('w-name').value = data?.name || '';
      $('w-ac').value   = data?.ac || '';
      $('w-ifsc').value = data?.ifsc || '';
      $('w-upi').value  = data?.upi || '';
      $('wd-amount').value = '';
      $('rollover-val').textContent = Number(data?.turnover_remaining||0).toFixed(2);
    }

    depSubmit.onclick = async ()=>{
      if (!currentUser) return toast('Please login first');
      try{
        let utrStr = ''; let amtNum = 0;
        if (depChannel === 'inr') {
          const utr = $('dep-utr').value.trim();
          const amountInr = Number($('dep-amount').value);
          if(!utr || !amountInr || amountInr <= 0) return toast('Enter UTR & amount');
          utrStr = `[INR] ${utr}`; amtNum = amountInr;
        } else {
          const addr = String(($('usdt-address')?.value)||'').trim();
          const txid = String(($('usdt-txid')?.value)||'').trim();
          const amt  = Number(($('usdt-amount')?.value));
          if(!addr) return toast('No TRC20 address configured');
          if(!txid) return toast('Enter transaction hash (TXID)');
          if(!amt || amt <= 0) return toast('Enter USDT amount');
          utrStr = `[USDT-TRC20] ${txid}`; amtNum = amt;
        }
        const { error } = await supabase.from('recharge_requests').insert([{
          user_id: currentUser.id, email: currentUser.email, utr: utrStr, amount: amtNum, status: 'pending'
        }]);
        if (error) return toast('Submit failed: ' + error.message);
        $('dep-utr').value=''; $('dep-amount').value='';
        if ($('usdt-txid')) $('usdt-txid').value='';
        if ($('usdt-amount')) $('usdt-amount').value='';
        show(depModal,false);
        toast('‚úÖ Recharge request submitted.');
        if (historyModal.style.display === 'flex') await loadRecentRecords();
      }catch(e){ toast('Submit failed: ' + (e?.message || e)); }
    };

    $('wd-save').onclick = async ()=>{
      if (!currentUser) return toast('Please login first');
      const payload = { name:$('w-name').value.trim(), ac:$('w-ac').value.trim(), ifsc:$('w-ifsc').value.trim(), upi:$('w-upi').value.trim() };
      if (!payload.name || !payload.ac || !payload.ifsc) return toast('Fill Name / AC / IFSC');
      const { error } = await supabase.from('users').update(payload).eq('id', currentUser.id);
      if (error) return toast('Save failed: ' + error.message);
      toast('‚úÖ Profile saved.');
    };

    wdSubmit.onclick = async ()=>{
      if (!currentUser) return toast('Please login first');
      const amount = Number($('wd-amount').value);
      if (!amount || amount <= 0) return toast('Enter amount');
      if (!$('w-name').value.trim() || !$('w-ac').value.trim() || !$('w-ifsc').value.trim()) {
        return toast('Please complete withdrawal profile (Name / AC / IFSC).');
      }
      const { data: u } = await supabase.from('users').select('turnover_remaining').eq('id', currentUser.id).single();
      const need = Number(u?.turnover_remaining || 0);
      if (need > 0) return toast(`Rollover not met: ‚Çπ${fmt2(need)} remaining`);
      const { error } = await supabase.rpc('request_withdraw', {
        _user_id: currentUser.id, _email: currentUser.email, _amount: amount
      });
      if (error) {
        if (String(error.message).includes('TURNOVER_NOT_MET')) return toast('Rollover not met. Please continue betting.');
        return toast('Submit failed: ' + error.message);
      }
      show(wdModal,false);
      toast('‚úÖ Withdraw request submitted.');
      if (historyModal.style.display === 'flex') await loadRecentRecords();
    };

    async function loadRecentRecords(){
      if(!currentUser){ return; }
      const since = new Date(Date.now() - 3*24*60*60*1000).toISOString();
      const { data: dep, error: depErr } = await supabase
        .from('recharge_requests').select('created_at, utr, amount, status')
        .eq('user_id', currentUser.id).gte('created_at', since)
        .order('created_at', { ascending: false }).limit(100);
      if (depErr) {
        depositsTbody.innerHTML = `<tr><td colspan="4" class="muted" style="padding:14px">Load failed: ${depErr.message}</td></tr>`;
      } else if (!dep?.length){
        depositsTbody.innerHTML = `<tr><td colspan="4" class="muted" style="padding:14px">No records in last 3 days</td></tr>`;
      } else {
        depositsTbody.innerHTML = dep.map(r => `
          <tr>
            <td>${fmtTime(r.created_at)}</td>
            <td>${r.utr ?? '‚Äî'}</td>
            <td>${fmt2(r.amount)}</td>
            <td><span class="tag ${String(r.status).toLowerCase()}">${r.status}</span></td>
          </tr>
        `).join('');
      }
      const { data: wd, error: wdErr } = await supabase
        .from('withdraw_requests').select('created_at, amount, status')
        .eq('user_id', currentUser.id).gte('created_at', since)
        .order('created_at', { ascending: false }).limit(100);
      if (wdErr) {
        withdrawalsTbody.innerHTML = `<tr><td colspan="3" class="muted" style="padding:14px">Load failed: ${wdErr.message}</td></tr>`;
      } else if (!wd?.length){
        withdrawalsTbody.innerHTML = `<tr><td colspan="3" class="muted" style="padding:14px">No records in last 3 days</td></tr>`;
      } else {
        withdrawalsTbody.innerHTML = wd.map(r => `
          <tr>
            <td>${fmtTime(r.created_at)}</td>
            <td>${fmt2(r.amount)}</td>
            <td><span class="tag ${String(r.status).toLowerCase()}">${r.status}</span></td>
          </tr>
        `).join('');
      }
    }

    chpassSubmit.onclick = async ()=>{
      try{
        if (!currentUser) return toast('Please login first');
        const email = currentUser.email;
        const oldP = $('old-pass').value, np = $('new-pass').value, np2 = $('new-pass2').value;
        if (!oldP || !np || !np2) return toast('Fill all fields');
        if (np.length < 6) return toast('New password must be at least 6 characters');
        if (np !== np2) return toast('New passwords do not match');
        const { error: reauthErr } = await supabase.auth.signInWithPassword({ email, password: oldP });
        if (reauthErr) return toast('Current password is incorrect');
        const { error: updErr } = await supabase.auth.updateUser({ password: np });
        if (updErr) return toast('Update failed: ' + updErr.message);
        $('old-pass').value = $('new-pass').value = $('new-pass2').value = '';
        show(chpassModal, false);
        toast('‚úÖ Password updated');
      }catch(e){ toast('Update failed: ' + (e?.message || e)); }
    };

    // boot
    (async ()=>{
      const { data:{ user } } = await supabase.auth.getUser();
      if (user){ currentUser=user; await afterLogin(); } else { setAuthUI(false); }
    })();
  </script>
</body>
</html>
