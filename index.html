<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>India Game Lobby</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <script type="module" src="./supabase-config.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#f6f9fc; --card:#fff; --text:#0f172a; --muted:#64748b;
      --line:#e2e8f0; --primary:#ff6f00; --primary-press:#e65f00;
      --green:#16a34a; --blue:#2563eb; --radius:16px; --shadow:0 10px 30px rgba(2,6,23,.08);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:'Poppins',system-ui,Segoe UI,Roboto,Arial; color:var(--text);
      background:
        radial-gradient(900px 450px at 100% -10%, #ffe7c6 0%, transparent 60%),
        radial-gradient(900px 450px at -10% 0%, #e0f2ff 0%, transparent 55%),
        #f6f9fc;
    }

    .nav{position:sticky; top:0; z-index:50; backdrop-filter:saturate(160%) blur(12px);
      background:rgba(246,249,252,.85); border-bottom:1px solid var(--line);}
    .nav-inner{max-width:1080px; margin:0 auto; padding:12px 16px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;}
    .brand{display:flex; align-items:center; gap:10px; font-weight:800;}
    .logo{width:36px;height:36px;border-radius:12px;display:grid;place-items:center;
      border:1px solid #ffd7aa; background:linear-gradient(135deg,#ffe2bd,#fff); box-shadow:inset 0 1px 0 #fff}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;height:42px;padding:0 14px;
      border-radius:12px;border:1px solid var(--line);background:#fff;cursor:pointer;font-weight:700}
    .btn.primary{background:var(--primary);color:#fff;border:0}
    .btn.primary:active{background:var(--primary-press)}
    .btn.ghost{background:#fff}
    a.btn{text-decoration:none;color:inherit}

    .wrap{max-width:1080px;margin:0 auto;padding:16px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow)}
    .inner{padding:16px}

    .user{display:grid;grid-template-columns:1fr auto;gap:12px;align-items:center}
    .hello{font-size:13px;color:var(--muted)}
    .balance{font-weight:800;color:var(--green);font-size:22px;display:flex;align-items:center;gap:10px}
    .quick{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .games{display:grid;gap:14px;grid-template-columns:1fr}
    @media(min-width:700px){ .games{grid-template-columns:repeat(3,1fr)} }
    .game{display:flex;flex-direction:column;gap:10px;padding:14px;border-radius:14px;
      background:linear-gradient(180deg,#ffffff,#fffef9);border:1px solid var(--line);
      transition:transform .15s ease, box-shadow .15s ease;}
    .game:hover{ transform:translateY(-2px); box-shadow:0 12px 26px rgba(0,0,0,.06); }
    .thumb{height:120px;border-radius:12px;background:linear-gradient(135deg,#ffedd5,#fff);
      border:1px solid #ffe4c7;display:grid;place-items:center;font-size:46px}
    .title{font-weight:800}
    .desc{color:var(--muted);font-size:13px}
    .game .btn{width:100%; margin-top:auto}

    .modal-bg{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(2,6,23,.3);z-index:100}
    .modal{width:min(96vw,560px);background:#fff;border-radius:18px;border:1px solid var(--line);box-shadow:var(--shadow)}
    .modal header{padding:14px 16px;border-bottom:1px solid var(--line);font-weight:800}
    .modal .body{padding:16px}
    .modal footer{display:flex;justify-content:flex-end;gap:10px;padding:12px 16px;border-top:1px solid var(--line)}
    .form{display:grid;gap:10px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    input{width:100%;height:44px;border-radius:12px;border:1px solid var(--line);padding:0 12px;font-size:15px;background:#fff}
    .muted{color:var(--muted)}
    .kv{display:flex;justify-content:space-between;gap:12px;padding:10px;border:1px dashed var(--line);border-radius:12px}
    .kv .k{color:var(--muted)} .kv .v{font-weight:700}

    /* VIP ÂæΩÁ´† */
    .vip-badge{
      display:inline-flex;align-items:center;gap:6px;
      padding:4px 10px;border:1px solid #ffe0b6;background:#fff7ec;border-radius:999px;
      color:#b45309;font-weight:700;font-size:12px
    }
  </style>
</head>
<body>
  <div class="nav">
    <div class="nav-inner">
      <div class="brand">
        <div class="logo">üé≤</div>
        <div>Ganeshcasino Game</div>
      </div>
      <div class="actions">
        <a id="cs-link" class="btn ghost" href="https://t.me/customerservice7777777" target="_blank">üí¨ Customer Service</a>
        <button id="open-login" class="btn">Login / Signup</button>
        <button id="logout-btn" class="btn ghost" style="display:none">Logout</button>
      </div>
    </div>
  </div>

  <div class="wrap">
    <!-- Áî®Êà∑Âç° -->
    <div class="card">
      <div class="inner user">
        <div>
          <div class="hello">Logged in as</div>
          <div id="user-email" style="font-weight:800">‚Äî</div>
          <div class="quick">
            <button id="open-deposit" class="btn primary">Deposit</button>
            <button id="open-withdraw" class="btn">Withdraw</button>
          </div>
        </div>
        <div class="balance">
          ‚Çπ<span id="balance">0</span>
          <!-- VIP ÂæΩÁ´† -->
          <span id="vip-badge" class="vip-badge" title="VIP Level">VIP 0</span>
        </div>
      </div>
    </div>

    <!-- Ê∏∏ÊàèÂå∫ -->
    <div class="card">
      <div class="inner">
        <div style="font-weight:800;margin-bottom:10px">üéÆ Select a Game</div>
        <div class="games">
          <div class="game">
            <div class="thumb">üé≤</div>
            <div class="title">Lucky Dice</div>
            <div class="desc">Bet on Big/Small or exact number. Results every minute (IST).</div>
            <a class="btn primary" href="./dice.html">Play</a>
          </div>
          <div class="game">
            <div class="thumb">üßß</div>
            <div class="title">Coming Soon</div>
            <div class="desc">More India-style games are on the way.</div>
            <button class="btn" disabled>Stay tuned</button>
          </div>
          <div class="game">
            <div class="thumb">üíé</div>
            <div class="title">Coming Soon</div>
            <div class="desc">Unlock new experiences for your players.</div>
            <button class="btn" disabled>Stay tuned</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ÁôªÂΩï Modal -->
  <div id="login-modal" class="modal-bg">
    <div class="modal">
      <header>Login / Signup</header>
      <div class="body">
        <div class="form">
          <input id="login-email" type="email" placeholder="Email" />
          <input id="login-pass" type="password" placeholder="Password" />
          <div class="muted">New user? Click ‚ÄúSignup‚Äù then login.</div>
        </div>
      </div>
      <footer>
        <button id="login-cancel" class="btn">Cancel</button>
        <button id="signup-btn" class="btn">Signup</button>
        <button id="login-btn" class="btn primary">Login</button>
      </footer>
    </div>
  </div>

  <!-- Â≠òÊ¨æ Modal -->
  <div id="dep-modal" class="modal-bg">
    <div class="modal">
      <header>Deposit</header>
      <div class="body">
        <div class="form">
          <div class="muted">Please transfer to the account below, then submit UTR and amount.</div>
          <div id="dep-bank" class="form">
            <div class="kv"><div class="k">Name</div><div class="v">‚Äî</div></div>
            <div class="kv"><div class="k">AC</div><div class="v">‚Äî</div></div>
            <div class="kv"><div class="k">IFSC</div><div class="v">‚Äî</div></div>
            <div class="kv"><div class="k">UPI</div><div class="v">‚Äî</div></div>
            <div class="kv"><div class="k">Crypto</div><div class="v">‚Äî</div></div>
          </div>
          <input id="dep-utr" type="text" placeholder="UTR / Reference Number" />
          <input id="dep-amount" type="number" min="1" placeholder="Amount ‚Çπ" />
        </div>
      </div>
      <footer>
        <button id="dep-cancel" class="btn">Cancel</button>
        <button id="dep-submit" class="btn primary">Submit</button>
      </footer>
    </div>
  </div>

  <!-- ÊèêÊ¨æ ModalÔºàÂê´ÊâìÁ†ÅÈáèÊòæÁ§∫Ôºâ -->
  <div id="wd-modal" class="modal-bg">
    <div class="modal">
      <header>Withdraw</header>
      <div class="body">
        <div class="form">
          <div class="kv" id="rollover-kv"><div class="k">Rollover Needed</div><div class="v" id="rollover-val">0.00</div></div>

          <div class="row">
            <input id="w-name" placeholder="Your Name" />
            <input id="w-ac" placeholder="AC Number" />
          </div>
          <div class="row">
            <input id="w-ifsc" placeholder="IFSC Code" />
            <input id="w-upi" placeholder="UPI ID (optional)" />
          </div>
          <div class="row">
            <input id="wd-amount" type="number" min="1" placeholder="Amount ‚Çπ" />
            <button id="wd-save" class="btn">Save Profile</button>
          </div>
          <div class="muted">Save your bank profile first if you modified it.</div>
        </div>
      </div>
      <footer>
        <button id="wd-cancel" class="btn">Cancel</button>
        <button id="wd-submit" class="btn primary">Submit Withdrawal</button>
      </footer>
    </div>
  </div>

  <script type="module">
    import { supabase } from './supabase-config.js';

    const $ = (id)=>document.getElementById(id);
    const show = (el,on=true)=> el.style.display = on ? 'flex' : 'none';
    const toast = (m)=>alert(m);
    const fmt2 = (n)=> Number(n ?? 0).toFixed(2);

    const openLogin = $('open-login');
    const logoutBtn = $('logout-btn');
    const userEmail = $('user-email');
    const balanceEl = $('balance');
    const vipBadge  = $('vip-badge');

    const loginModal = $('login-modal'), loginCancel = $('login-cancel'),
          signupBtn = $('signup-btn'), loginBtn = $('login-btn'),
          loginEmail = $('login-email'), loginPass = $('login-pass');

    const depModal = $('dep-modal'), depCancel = $('dep-cancel'), depSubmit = $('dep-submit'),
          depUtr = $('dep-utr'), depAmount = $('dep-amount'), depBank = $('dep-bank');

    const wdModal = $('wd-modal'), wdCancel = $('wd-cancel'), wdSubmit = $('wd-submit'),
          wName = $('w-name'), wAc = $('w-ac'), wIfsc = $('w-ifsc'), wUpi = $('w-upi'),
          wdAmount = $('wd-amount'), wdSave = $('wd-save'), rolloverVal = $('rollover-val');

    $('open-deposit').onclick = async()=>{ await loadBankInfoIntoDeposit(); show(depModal,true); };
    $('open-withdraw').onclick = async()=>{ await loadWithdrawProfileIntoModal(); show(wdModal,true); };
    openLogin.onclick = ()=> show(loginModal,true);
    loginCancel.onclick = ()=> show(loginModal,false);
    depCancel.onclick = ()=> show(depModal,false);
    wdCancel.onclick = ()=> show(wdModal,false);

    let currentUser = null;
    function setAuthUI(loggedIn){
      $('open-login').style.display = loggedIn ? 'none' : '';
      logoutBtn.style.display = loggedIn ? '' : 'none';
    }

    // ÁôªÂΩï/Ê≥®ÂÜå
    signupBtn.onclick = async ()=>{
      const email = loginEmail.value.trim(), pass = loginPass.value;
      if(!email || !pass) return toast('Enter email & password');
      const { error } = await supabase.auth.signUp({ email, password: pass });
      if (error) return toast(error.message);
      toast('‚úÖ Signup success. Now login.');
    };
    loginBtn.onclick = async ()=>{
      const email = loginEmail.value.trim(), pass = loginPass.value;
      if(!email || !pass) return toast('Enter email & password');
      const { data, error } = await supabase.auth.signInWithPassword({ email, password: pass });
      if (error) return toast('Login failed: ' + error.message);
      currentUser = data.user;
      show(loginModal,false);
      await afterLogin();
    };
    logoutBtn.onclick = async ()=>{
      await supabase.auth.signOut();
      currentUser = null; userEmail.textContent = '‚Äî'; balanceEl.textContent = '0'; vipBadge.textContent='VIP 0'; setAuthUI(false);
    };

    async function afterLogin(){
      setAuthUI(true);
      userEmail.textContent = currentUser.email || '‚Äî';
      await supabase.from('users').upsert([{ id: currentUser.id, email: currentUser.email }]);
      await refreshUserSummary();
    }
    async function refreshUserSummary(){
      const { data } = await supabase.from('users')
        .select('balance, vip_level')
        .eq('id', currentUser.id).single();
      balanceEl.textContent = data?.balance ?? 0;
      vipBadge.textContent = `VIP ${Number(data?.vip_level ?? 0)}`;
    }

    async function loadBankInfoIntoDeposit(){
      const { data } = await supabase.from('bank_info').select('*').eq('id', 1).maybeSingle();
      const items = [
        ['Name', data?.name], ['AC', data?.ac], ['IFSC', data?.ifsc],
        ['UPI', data?.upi], ['Crypto', data?.crypto_address]
      ];
      depBank.innerHTML = items.map(([k,v])=>`
        <div class="kv"><div class="k">${k}</div><div class="v">${v || '‚Äî'}</div></div>
      `).join('');
    }

    async function loadWithdrawProfileIntoModal(){
      const { data } = await supabase.from('users')
        .select('name,ac,ifsc,upi,turnover_remaining')
        .eq('id', currentUser.id).single();
      wName.value = data?.name || '';
      wAc.value   = data?.ac || '';
      wIfsc.value = data?.ifsc || '';
      wUpi.value  = data?.upi || '';
      wdAmount.value = '';
      rolloverVal.textContent = fmt2(data?.turnover_remaining);
    }

    depSubmit.onclick = async ()=>{
      if (!currentUser) return toast('Please login first');
      const utr = depUtr.value.trim();
      const amount = Number(depAmount.value);
      if (!utr || !amount || amount <= 0) return toast('Enter UTR & amount');
      const { error } = await supabase.from('recharge_requests').insert([{
        user_id: currentUser.id, email: currentUser.email, utr, amount, status: 'pending'
      }]);
      if (error) return toast('Submit failed: ' + error.message);
      show(depModal,false);
      toast('‚úÖ Recharge request submitted.');
    };

    wdSave.onclick = async ()=>{
      if (!currentUser) return toast('Please login first');
      const payload = { name:wName.value.trim(), ac:wAc.value.trim(), ifsc:wIfsc.value.trim(), upi:wUpi.value.trim() };
      if (!payload.name || !payload.ac || !payload.ifsc) return toast('Fill Name / AC / IFSC');
      const { error } = await supabase.from('users').update(payload).eq('id', currentUser.id);
      if (error) return toast('Save failed: ' + error.message);
      toast('‚úÖ Profile saved.');
    };

    wdSubmit.onclick = async ()=>{
      if (!currentUser) return toast('Please login first');
      const amount = Number(wdAmount.value);
      if (!amount || amount <= 0) return toast('Enter amount');

      if (!wName.value.trim() || !wAc.value.trim() || !wIfsc.value.trim()) {
        return toast('Please complete withdrawal profile (Name / AC / IFSC).');
      }

      const { data: u } = await supabase.from('users')
        .select('turnover_remaining').eq('id', currentUser.id).single();
      const need = Number(u?.turnover_remaining || 0);
      if (need > 0) {
        return toast(`Rollover not met: ‚Çπ${fmt2(need)} remaining`);
      }

      const { error } = await supabase.rpc('request_withdraw', {
        _user_id: currentUser.id,
        _email: currentUser.email,
        _amount: amount
      });
      if (error) {
        if (String(error.message).includes('TURNOVER_NOT_MET')) {
          return toast('Rollover not met. Please continue betting.');
        }
        return toast('Submit failed: ' + error.message);
      }

      show(wdModal,false);
      toast('‚úÖ Withdraw request submitted.');
    };

    (async ()=>{
      const { data:{ user } } = await supabase.auth.getUser();
      if (user){ currentUser=user; await afterLogin(); } else { setAuthUI(false); }
    })();
  </script>
</body>
</html>
