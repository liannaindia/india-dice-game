<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>India Game Lobby</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <script type="module" src="./supabase-config.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#f6f9fc; --card:#fff; --text:#0f172a; --muted:#64748b;
      --line:#e2e8f0; --primary:#ff6f00; --primary-press:#e65f00;
      --green:#16a34a; --blue:#2563eb; --radius:16px; --shadow:0 10px 30px rgba(2,6,23,.08);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; font-family:'Poppins',system-ui,Segoe UI,Roboto,Arial; color:var(--text); background:
      radial-gradient(1000px 500px at 100% -10%, #ffe7c6 0%, transparent 60%),
      radial-gradient(900px 500px at -10% 0%, #e0f2ff 0%, transparent 55%),
      var(--bg);
    }

    /* È°∂Ê†è */
    .nav{
      position:sticky; top:0; z-index:50;
      backdrop-filter:saturate(160%) blur(12px);
      background:rgba(246,249,252,.85);
      border-bottom:1px solid var(--line);
    }
    .nav-inner{
      max-width:1080px; margin:0 auto; padding:12px 16px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .brand{display:flex; align-items:center; gap:10px; font-weight:800; letter-spacing:.2px}
    .logo{width:36px;height:36px;border-radius:12px;display:grid;place-items:center;
      border:1px solid #ffd7aa; background:linear-gradient(135deg,#ffe2bd,#fff); box-shadow:inset 0 1px 0 #fff}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;height:42px;padding:0 14px;
      border-radius:12px;border:1px solid var(--line);background:#fff;cursor:pointer;font-weight:700}
    .btn.primary{background:var(--primary);color:#fff;border:0}
    .btn.primary:active{background:var(--primary-press)}
    .btn.ghost{background:#fff}

    /* Â∏ÉÂ±Ä */
    .wrap{max-width:1080px;margin:0 auto;padding:16px}
    .grid{display:grid;gap:16px}
    @media(min-width:900px){ .grid{ grid-template-columns: 2fr 1fr; } }

    /* Âç°Áâá */
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow)}
    .card .inner{padding:16px}

    /* Áî®Êà∑Âç° */
    .user{
      display:grid;grid-template-columns:1fr auto;gap:12px;align-items:center
    }
    .user .hello{font-size:13px;color:var(--muted)}
    .balance{font-weight:800;color:var(--green);font-size:22px}
    .quick{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}

    /* Ê∏∏ÊàèÂå∫ */
    .games{display:grid;gap:14px;grid-template-columns:1fr}
    @media(min-width:700px){ .games{grid-template-columns:repeat(3,1fr)} }
    .game{
      display:flex;flex-direction:column;gap:10px;padding:14px;border-radius:14px;
      background:linear-gradient(180deg,#ffffff,#fffef9);border:1px solid var(--line);
      transition:transform .15s ease, box-shadow .15s ease;
    }
    .game:hover{ transform:translateY(-2px); box-shadow:0 12px 26px rgba(0,0,0,.06); }
    .thumb{height:120px;border-radius:12px;background:linear-gradient(135deg,#ffedd5,#fff);
      border:1px solid #ffe4c7;display:grid;place-items:center;font-size:46px}
    .title{font-weight:800}
    .desc{color:var(--muted);font-size:13px}
    .game .btn{width:100%; margin-top:auto}

    /* Èì∂Ë°å‰ø°ÊÅØ‰æßÊ†è */
    .banklist{display:grid;gap:8px}
    .kv{display:flex;justify-content:space-between;gap:12px;padding:10px;border:1px dashed var(--line);border-radius:12px}
    .kv .k{color:var(--muted)}
    .kv .v{font-weight:700}

    /* Ê®°ÊÄÅÊ°Ü */
    .modal-bg{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(2,6,23,.3);z-index:100}
    .modal{width:min(96vw,520px);background:#fff;border-radius:18px;border:1px solid var(--line);box-shadow:var(--shadow)}
    .modal header{padding:14px 16px;border-bottom:1px solid var(--line);font-weight:800}
    .modal .body{padding:16px}
    .modal footer{display:flex;justify-content:flex-end;gap:10px;padding:12px 16px;border-top:1px solid var(--line)}
    .form{display:grid;gap:10px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    input{width:100%;height:44px;border-radius:12px;border:1px solid var(--line);padding:0 12px;font-size:15px;background:#fff}
    .muted{color:var(--muted)}

    /* ÂÆ¢ÊúçÊåâÈíÆ */
    #customer-service-btn{
      position:fixed;right:16px;bottom:16px;z-index:110;background:var(--blue);color:#fff;
      font-weight:700;border-radius:999px;padding:12px 16px;box-shadow:0 10px 20px rgba(37,99,235,.25)
    }
    #customer-service-btn:hover{filter:brightness(.96)}
  </style>
</head>
<body>
  <!-- È°∂Ê†è -->
  <div class="nav">
    <div class="nav-inner">
      <div class="brand">
        <div class="logo">üé≤</div>
        <div>India Game Lobby</div>
      </div>
      <div class="actions">
        <button id="open-login" class="btn">Login / Signup</button>
        <button id="logout-btn" class="btn ghost" style="display:none">Logout</button>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="grid">
      <!-- Â∑¶‰æßÔºöÁî®Êà∑Âç° + Ê∏∏ÊàèÂå∫ -->
      <div class="left">
        <div class="card">
          <div class="inner user">
            <div>
              <div class="hello">Logged in as</div>
              <div id="user-email" style="font-weight:800">‚Äî</div>
              <div class="quick">
                <button id="open-deposit" class="btn primary">Deposit</button>
                <button id="open-withdraw" class="btn">Withdraw</button>
              </div>
            </div>
            <div class="balance">‚Çπ<span id="balance">0</span></div>
          </div>
        </div>

        <div class="card">
          <div class="inner">
            <div style="font-weight:800;margin-bottom:10px">üéÆ Select a Game</div>
            <div class="games">
              <div class="game">
                <div class="thumb">üé≤</div>
                <div class="title">Lucky Dice</div>
                <div class="desc">Bet on Big/Small or exact number. Results every minute (IST).</div>
                <a class="btn primary" href="./dice.html">Play</a>
              </div>
              <div class="game">
                <div class="thumb">üßß</div>
                <div class="title">Coming Soon</div>
                <div class="desc">New India-style games are on the way.</div>
                <button class="btn" disabled>Stay tuned</button>
              </div>
              <div class="game">
                <div class="thumb">üíé</div>
                <div class="title">Coming Soon</div>
                <div class="desc">Unlock more experiences for players.</div>
                <button class="btn" disabled>Stay tuned</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Âè≥‰æßÔºöÈì∂Ë°å‰ø°ÊÅØ / ÊèêÁé∞ËµÑÊñô -->
      <div class="right">
        <div class="card">
          <div class="inner">
            <div style="font-weight:800;margin-bottom:10px">üè¶ Bank / UPI Info</div>
            <div id="bank-box" class="banklist">
              <div class="muted">Loading‚Ä¶</div>
            </div>
            <div class="muted" style="margin-top:8px">* Transfer first, then submit UTR in Deposit.</div>
          </div>
        </div>

        <div class="card">
          <div class="inner">
            <div style="font-weight:800;margin-bottom:10px">üßæ Withdrawal Profile</div>
            <div id="withdraw-profile" class="banklist">
              <div class="muted">Loading‚Ä¶</div>
            </div>
          </div>
        </div>
      </div>
    </div> <!-- /grid -->
  </div> <!-- /wrap -->

  <!-- ÂÆ¢ÊúçÊåâÈíÆÔºöÊç¢Êàê‰Ω†ÁöÑÈìæÊé• -->
  <a id="customer-service-btn" href="https://wa.me/919876543210" target="_blank">üí¨ Customer Service</a>

  <!-- ÁôªÂΩï/Ê≥®ÂÜå Modal -->
  <div id="login-modal" class="modal-bg">
    <div class="modal">
      <header>Login / Signup</header>
      <div class="body">
        <div class="form">
          <input id="login-email" type="email" placeholder="Email" />
          <input id="login-pass" type="password" placeholder="Password" />
          <div class="muted">New user? Click ‚ÄúSignup‚Äù then login.</div>
        </div>
      </div>
      <footer>
        <button id="login-cancel" class="btn">Cancel</button>
        <button id="signup-btn" class="btn">Signup</button>
        <button id="login-btn" class="btn primary">Login</button>
      </footer>
    </div>
  </div>

  <!-- ÂÖÖÂÄº ModalÔºàÊèê‰∫§Âà∞ recharge_requestsÔºâ -->
  <div id="dep-modal" class="modal-bg">
    <div class="modal">
      <header>Deposit</header>
      <div class="body">
        <div class="form">
          <div class="muted">Please transfer to the bank/UPI above, then submit UTR:</div>
          <input id="dep-utr" type="text" placeholder="UTR / Reference Number" />
          <input id="dep-amount" type="number" min="1" placeholder="Amount ‚Çπ" />
        </div>
      </div>
      <footer>
        <button id="dep-cancel" class="btn">Cancel</button>
        <button id="dep-submit" class="btn primary">Submit</button>
      </footer>
    </div>
  </div>

  <!-- ÊèêÁé∞ ModalÔºàÊèê‰∫§Âà∞ withdraw_requestsÔºâ -->
  <div id="wd-modal" class="modal-bg">
    <div class="modal">
      <header>Withdraw</header>
      <div class="body">
        <div class="form">
          <div class="muted">Make sure your withdrawal profile is complete.</div>
          <input id="wd-amount" type="number" min="1" placeholder="Amount ‚Çπ" />
        </div>
      </div>
      <footer>
        <button id="wd-cancel" class="btn">Cancel</button>
        <button id="wd-submit" class="btn primary">Submit</button>
      </footer>
    </div>
  </div>

  <script type="module">
    import { supabase } from './supabase-config.js';

    // ÁÆÄÊòìÈÄâÊã©Âô® & ÂºπÁ™óÊéßÂà∂
    const $ = (id)=>document.getElementById(id);
    const show = (el,on=true)=> el.style.display = on ? 'flex' : 'none';
    const toast = (m)=>alert(m);

    // È°∂Ê†èÊåâÈíÆ
    const openLogin = $('open-login');
    const logoutBtn = $('logout-btn');

    // Áî®Êà∑‰ø°ÊÅØ
    const userEmail = $('user-email');
    const balanceEl = $('balance');

    // ‰æßÊ†è
    const bankBox = $('bank-box');
    const withdrawProfile = $('withdraw-profile');

    // ÁôªÂΩïÂºπÁ™ó
    const loginModal = $('login-modal');
    const loginCancel = $('login-cancel');
    const signupBtn = $('signup-btn');
    const loginBtn = $('login-btn');
    const loginEmail = $('login-email');
    const loginPass = $('login-pass');

    // ÂÖÖÂÄºÂºπÁ™ó
    const depModal = $('dep-modal');
    const depCancel = $('dep-cancel');
    const depSubmit = $('dep-submit');
    const depUtr = $('dep-utr');
    const depAmount = $('dep-amount');

    // ÊèêÁé∞ÂºπÁ™ó
    const wdModal = $('wd-modal');
    const wdCancel = $('wd-cancel');
    const wdSubmit = $('wd-submit');
    const wdAmount = $('wd-amount');

    // Âø´Êç∑ÊåâÈíÆ
    $('open-deposit').onclick = ()=> show(depModal,true);
    $('open-withdraw').onclick = ()=> show(wdModal,true);
    openLogin.onclick = ()=> show(loginModal,true);
    loginCancel.onclick = ()=> show(loginModal,false);
    depCancel.onclick = ()=> show(depModal,false);
    wdCancel.onclick = ()=> show(wdModal,false);

    let currentUser = null;
    function setAuthUI(loggedIn){
      openLogin.style.display = loggedIn ? 'none' : '';
      logoutBtn.style.display = loggedIn ? '' : 'none';
    }

    // ÁôªÂΩï/Ê≥®ÂÜå
    signupBtn.onclick = async ()=>{
      const email = loginEmail.value.trim();
      const pass = loginPass.value;
      if(!email || !pass) return toast('Enter email & password');
      const { error } = await supabase.auth.signUp({ email, password: pass });
      if (error) return toast(error.message);
      toast('‚úÖ Signup success. Now login.');
    };
    loginBtn.onclick = async ()=>{
      const email = loginEmail.value.trim();
      const pass = loginPass.value;
      if(!email || !pass) return toast('Enter email & password');
      const { data, error } = await supabase.auth.signInWithPassword({ email, password: pass });
      if (error) return toast('Login failed: ' + error.message);
      currentUser = data.user;
      show(loginModal,false);
      await afterLogin();
    };
    logoutBtn.onclick = async ()=>{
      await supabase.auth.signOut();
      currentUser = null;
      userEmail.textContent = '‚Äî';
      balanceEl.textContent = '0';
      setAuthUI(false);
    };

    // ÁôªÂΩïÂêéÂàùÂßãÂåñ
    async function afterLogin(){
      setAuthUI(true);
      userEmail.textContent = currentUser.email || '‚Äî';
      // Á°Æ‰øù users Ë°®ÊúâËØ•Áî®Êà∑
      await supabase.from('users').upsert([{ id: currentUser.id, email: currentUser.email }]);
      await refreshBalance();
      await loadBankInfo();
      await loadWithdrawProfile();
    }
    async function refreshBalance(){
      const { data } = await supabase.from('users').select('balance').eq('id', currentUser.id).single();
      balanceEl.textContent = data?.balance ?? 0;
    }

    // ‰æßÊ†èÊï∞ÊçÆ
    async function loadBankInfo(){
      const { data, error } = await supabase.from('bank_info').select('*').eq('id', 1).maybeSingle();
      if (error || !data){
        bankBox.innerHTML = '<div class="muted">No bank info yet.</div>'; return;
      }
      const items = [
        ['Name', data.name], ['AC', data.ac], ['IFSC', data.ifsc],
        ['UPI', data.upi], ['Crypto', data.crypto_address]
      ];
      bankBox.innerHTML = items.map(([k,v])=>`
        <div class="kv"><div class="k">${k}</div><div class="v">${v || '‚Äî'}</div></div>
      `).join('');
    }
    async function loadWithdrawProfile(){
      const { data, error } = await supabase.from('users').select('name,ac,ifsc,upi').eq('id', currentUser.id).single();
      if (error) { withdrawProfile.innerHTML = '<div class="muted">Load failed.</div>'; return; }
      if (!data?.name){
        withdrawProfile.innerHTML = `
          <div class="form">
            <div class="row">
              <input id="w-name" placeholder="Your Name" />
              <input id="w-ac" placeholder="AC Number" />
            </div>
            <div class="row">
              <input id="w-ifsc" placeholder="IFSC Code" />
              <input id="w-upi" placeholder="UPI ID" />
            </div>
            <button id="save-wd" class="btn">Save</button>
          </div>`;
        $('save-wd').onclick = async ()=>{
          const name=$('w-name').value, ac=$('w-ac').value, ifsc=$('w-ifsc').value, upi=$('w-upi').value;
          const { error: e } = await supabase.from('users').update({ name, ac, ifsc, upi }).eq('id', currentUser.id);
          if (e) return toast('Save failed: '+e.message);
          toast('Saved'); loadWithdrawProfile();
        };
      }else{
        withdrawProfile.innerHTML = `
          <div class="banklist">
            <div class="kv"><div class="k">Name</div><div class="v">${data.name}</div></div>
            <div class="kv"><div class="k">AC</div><div class="v">${data.ac}</div></div>
            <div class="kv"><div class="k">IFSC</div><div class="v">${data.ifsc}</div></div>
            <div class="kv"><div class="k">UPI</div><div class="v">${data.upi || '‚Äî'}</div></div>
          </div>`;
      }
    }

    // ÂÖÖÂÄºÊèê‰∫§ -> recharge_requests
    depSubmit.onclick = async ()=>{
      if (!currentUser) return toast('Please login first');
      const utr = depUtr.value.trim();
      const amount = Number(depAmount.value);
      if (!utr || !amount) return toast('Enter UTR & amount');
      const { error } = await supabase.from('recharge_requests').insert([{
        user_id: currentUser.id, email: currentUser.email, utr, amount
      }]);
      if (error) return toast('Submit failed: ' + error.message);
      show(depModal,false);
      toast('‚úÖ Recharge request submitted.');
    };

    // ÊèêÁé∞Êèê‰∫§ -> withdraw_requests
    wdSubmit.onclick = async ()=>{
      if (!currentUser) return toast('Please login first');
      const amount = Number(wdAmount.value);
      if (!amount) return toast('Enter amount');
      const { error } = await supabase.from('withdraw_requests').insert([{
        user_id: currentUser.id, email: currentUser.email, amount
      }]);
      if (error) return toast('Submit failed: ' + error.message);
      show(wdModal,false);
      toast('‚úÖ Withdraw request submitted.');
    };

    // ÊÅ¢Â§çÁôªÂΩï
    (async ()=>{
      const { data:{ user } } = await supabase.auth.getUser();
      if (user){ currentUser=user; await afterLogin(); } else { setAuthUI(false); }
    })();
  </script>
</body>
</html>
