<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>India Game Lobby</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <script type="module" src="./supabase-config.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">
  
  <!-- PWA manifest -->
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#0b1220">

  <!-- iOSÔºöÊ∑ªÂä†Âà∞‰∏ªÂ±èÂπïÂêéÂÖ®Â±èÊòæÁ§∫‰∏éÂêçÁß∞ -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Ganeshcasino">
  <link rel="apple-touch-icon" href="/icons/apple-icon-180.png">

  <!-- Ê≥®ÂÜå Service WorkerÔºàÊ†πË∑ØÂæÑÔºâ -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/service-worker.js');
      });
    }
  </script>

  <style>
    :root{
      --bg:#f6f9fc; --card:#fff; --text:#0f172a; --muted:#64748b;
      --line:#e2e8f0; --primary:#ff6f00; --primary-press:#e65f00;
      --green:#16a34a; --blue:#2563eb; --radius:16px; --shadow:0 10px 30px rgba(2,6,23,.08);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:'Poppins',system-ui,Segoe UI,Roboto,Arial; color:var(--text);
      background:
        radial-gradient(900px 450px at 100% -10%, #ffe7c6 0%, transparent 60%),
        radial-gradient(900px 450px at -10% 0%, #e0f2ff 0%, transparent 55%),
        #f6f9fc;
    }

    .nav{position:sticky; top:0; z-index:50; backdrop-filter:saturate(160%) blur(12px);
      background:rgba(246,249,252,.85); border-bottom:1px solid var(--line);}
    .nav-inner{max-width:1080px; margin:0 auto; padding:12px 16px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;}
    .brand{display:flex; align-items:center; gap:10px; font-weight:800;}
    .logo{width:36px;height:36px;border-radius:12px;display:grid;place-items:center;
      border:1px solid #ffd7aa; background:linear-gradient(135deg,#ffe2bd,#fff); box-shadow:inset 0 1px 0 #fff}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;height:42px;padding:0 14px;
      border-radius:12px;border:1px solid var(--line);background:#fff;cursor:pointer;font-weight:700}
    .btn.primary{background:var(--primary);color:#fff;border:0}
    .btn.primary:active{background:var(--primary-press)}
    .btn.ghost{background:#fff}
    a.btn{text-decoration:none;color:inherit}

    .wrap{max-width:1080px;margin:0 auto;padding:16px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow)}
    .inner{padding:16px}

    .user{display:grid;grid-template-columns:1fr auto;gap:12px;align-items:center}
    .hello{font-size:13px;color:var(--muted)}
    .balance{font-weight:800;color:var(--green);font-size:22px;display:flex;align-items:center;gap:10px}
    .quick{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .games{display:grid;gap:14px;grid-template-columns:1fr}
    @media(min-width:700px){ .games{grid-template-columns:repeat(3,1fr)} }
    .game{display:flex;flex-direction:column;gap:10px;padding:14px;border-radius:14px;
      background:linear-gradient(180deg,#ffffff,#fffef9);border:1px solid var(--line);
      transition:transform .15s ease, box-shadow .15s ease;}
    .game:hover{ transform:translateY(-2px); box-shadow:0 12px 26px rgba(0,0,0,.06); }
    .thumb{height:120px;border-radius:12px;background:linear-gradient(135deg,#ffedd5,#fff);
      border:1px solid #ffe4c7;display:grid;place-items:center;font-size:46px}
    .title{font-weight:800}
    .desc{color:var(--muted);font-size:13px}
    .game .btn{width:100%; margin-top:auto}

    .modal-bg{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(2,6,23,.3);z-index:100}
    .modal{width:min(96vw,720px);background:#fff;border-radius:18px;border:1px solid var(--line);box-shadow:var(--shadow)}
    .modal header{padding:14px 16px;border-bottom:1px solid var(--line);font-weight:800}
    .modal .body{padding:16px}
    .modal footer{display:flex;justify-content:flex-end;gap:10px;padding:12px 16px;border-top:1px solid var(--line)}
    .form{display:grid;gap:10px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    input{width:100%;height:44px;border-radius:12px;border:1px solid var(--line);padding:0 12px;font-size:15px;background:#fff}
    .muted{color:var(--muted)}
    .kv{display:flex;justify-content:space-between;gap:12px;padding:10px;border:1px dashed var(--line);border-radius:12px}
    .kv .k{color:var(--muted)} .kv .v{font-weight:700}

    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid var(--line);font-size:14px}
    th{background:#fafafa;text-align:left}
    .tag{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid var(--line)}
    .tag.pending{background:#fff7ed;color:#b45309;border-color:#fed7aa}
    .tag.approved{background:#ecfdf5;color:#065f46;border-color:#bbf7d0}
    .tag.rejected{background:#fef2f2;color:#991b1b;border-color:#fecaca}

    /* VIP ÂæΩÁ´† */
    .vip-badge{
      display:inline-flex;align-items:center;gap:6px;
      padding:4px 10px;border:1px solid #ffe0b6;background:#fff7ec;border-radius:999px;
      color:#b45309;font-weight:700;font-size:12px
    }

    /* ==== Added for Deposit Channels (No Tabs) ==== */
    .channel-switch{display:flex;gap:8px;margin-bottom:12px}
    .channel-btn{
      padding:10px 14px;border:1px solid var(--line);border-radius:12px;background:#fafafa;
      cursor:pointer;font-weight:700
    }
    .channel-btn.active{background:#fff;border-color:#ffddbc;box-shadow:0 2px 10px rgba(0,0,0,.04)}
    .dep-pane{display:none}
    .dep-pane.active{display:block}
    .addr-row{display:flex;gap:8px}
    .addr-row input{flex:1}
    .qr-hint{font-size:12px;color:var(--muted)}
  </style>
</head>
<body>
<!-- Install App button (always visible) -->
<style>
  #installAppBtn{
    position:fixed; right:16px; bottom:16px; z-index:9999;
    padding:12px 16px; border:0; border-radius:12px;
    background:#22d3ee; color:#0b1220; font-weight:900;
    box-shadow:0 8px 24px #22d3ee55;
  }
</style>

<button id="installAppBtn" aria-label="Install Ganeshcasino">Install Ganeshcasino</button>

<script>
  // If you've already registered the service worker in <head>, you can remove this block.
  // if ('serviceWorker' in navigator) {
  //   window.addEventListener('load', () => navigator.serviceWorker.register('/service-worker.js'));
  // }

  const btn = document.getElementById('installAppBtn');
  let deferredPrompt = null;

  // Keep the button visible at all times (do NOT hide in standalone or after install)
  // Capture the install prompt on Android/Desktop for later use
  window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
  });

  // Do NOT hide the button on 'appinstalled' ‚Äî keep it visible
  // window.addEventListener('appinstalled', () => { /* keep button visible */ });

  btn.addEventListener('click', async () => {
    const ua = navigator.userAgent.toLowerCase();
    const isIOS = /iphone|ipad|ipod/.test(ua);
    const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);

    // If we have a stored prompt (Android/Desktop), show it
    if (deferredPrompt) {
      btn.disabled = true;
      try {
        deferredPrompt.prompt();
        await deferredPrompt.userChoice; // { outcome: 'accepted' | 'dismissed' }
      } finally {
        deferredPrompt = null;
        btn.disabled = false;
      }
      return;
    }

    // Otherwise show platform-specific guidance (button remains visible)
    if (isIOS && isSafari) {
      alert('On iPhone:\n1) Open this site in Safari\n2) Tap the Share button (‚¨ÜÔ∏è)\n3) Choose "Add to Home Screen"');
    } else if (isIOS && !isSafari) {
      alert('To install on iPhone, open this site in Safari, then use "Add to Home Screen".');
    } else {
      alert('If no install panel appears, use your browser menu and choose "Add to Home screen" or "Install app". If you already installed, open it from your home screen.');
    }
  });
</script>


  <div class="nav">
    <div class="nav-inner">
      <div class="brand">
        <div class="logo">üé≤</div>
        <div>Ganeshcasino Game</div>
      </div>
      <div class="actions">
        <a id="cs-link" class="btn ghost" href="https://t.me/customerservice7777777" target="_blank">üí¨ Customer Service</a>
        <button id="open-login" class="btn">Login / Signup</button>
        <button id="logout-btn" class="btn ghost" style="display:none">Logout</button>
      </div>
    </div>
  </div>

  <div class="wrap">
    <!-- Áî®Êà∑Âç° -->
    <div class="card">
      <div class="inner user">
        <div>
          <div class="hello">Logged in as</div>
          <div id="user-email" style="font-weight:800">‚Äî</div>
          <div class="quick">
            <button id="open-deposit" class="btn primary">Deposit</button>
            <button id="open-withdraw" class="btn">Withdraw</button>
            <!-- Êñ∞Â¢ûÔºöMy Records ÊåâÈíÆÔºàÊîæÂú® Change Password ÂâçÈù¢Ôºâ -->
            <button id="open-history" class="btn">My Records</button>
            <button id="open-chpass" class="btn ghost">Change Password</button>
          </div>
        </div>
        <div class="balance">
          ‚Çπ<span id="balance">0</span>
          <!-- VIP ÂæΩÁ´† -->
          <span id="vip-badge" class="vip-badge" title="VIP Level">VIP 0</span>
        </div>
      </div>
    </div>

    <!-- Ê∏∏ÊàèÂå∫ -->
    <div class="card" style="margin-top:14px">
      <div class="inner">
        <div style="font-weight:800;margin-bottom:10px">üéÆ Select a Game</div>
        <div class="game">
          <div class="thumb">üé°</div>
          <div class="title">Mini Wheel</div>
          <div class="desc">2-minute rounds (IST). Bet Small/Big or 3‚Äì18.</div>
          <a class="btn primary" href="./mini-wheel.html">Play</a>
        </div>

        <div class="games">
          <div class="game">
            <div class="thumb">üé≤</div>
            <div class="title">Lucky Dice</div>
            <div class="desc">Bet on Big/Small or exact number. Results every minute (IST).</div>
            <a class="btn primary" href="./dice.html">Play</a>
          </div>

          <div class="game">
            <div class="thumb">üÉè</div>
            <div class="title">Andar Bahar</div>
            <div class="desc">Bet on Andar or Bahar. Result every minute (IST).</div>
            <a class="btn primary" href="./ab.html">Play</a>
          </div>

          <div class="game">
            <div class="thumb">üßß</div>
            <div class="title">Coming Soon</div>
            <div class="desc">More India-style games are on the way.</div>
            <button class="btn" disabled>Stay tuned</button>
          </div>
          <div class="game">
            <div class="thumb">üíé</div>
            <div class="title">Coming Soon</div>
            <div class="desc">Unlock new experiences for your players.</div>
            <button class="btn" disabled>Stay tuned</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ÁôªÂΩï Modal -->
  <div id="login-modal" class="modal-bg">
    <div class="modal">
      <header>Login / Signup</header>
      <div class="body">
        <div class="form">
          <input id="login-email" type="email" placeholder="Email" />
          <input id="login-pass" type="password" placeholder="Password" />
          <div class="muted">New user? Click ‚ÄúSignup‚Äù then login.</div>
        </div>
      </div>
      <footer>
        <button id="login-cancel" class="btn">Cancel</button>
        <button id="signup-btn" class="btn">Signup</button>
        <button id="login-btn" class="btn primary">Login</button>
      </footer>
    </div>
  </div>

  <!-- Â≠òÊ¨æ ModalÔºàINR / USDT ‰∏§È°µÔºåÁÇπÂáªÊåâÈíÆÂàáÊç¢Ôºâ -->
  <div id="dep-modal" class="modal-bg">
    <div class="modal">
      <header>Deposit</header>
      <div class="body">
        <!-- ÂàáÊç¢ÊåâÈíÆÔºà‰∏ç‰ΩøÁî®TabÔºâ -->
        <div class="channel-switch">
          <button id="btn-inr"  class="channel-btn active">INR ¬∑ UPI / Bank</button>
          <button id="btn-usdt" class="channel-btn">USDT ¬∑ Crypto¬∑1USDT=100rs</button>
        </div>

        <!-- INR È°µÈù¢ÔºàÂéüÈÄªËæëÔºöUTR + ‚ÇπÈáëÈ¢ùÔºâ -->
        <div id="pane-inr" class="dep-pane active">
          <div class="muted" style="margin-bottom:8px">
            Please transfer to the account below, then submit UTR and amount.
          </div>
          <div id="dep-bank" class="form" style="margin-bottom:8px">
            <div class="kv"><div class="k">Name</div><div class="v">‚Äî</div></div>
            <div class="kv"><div class="k">AC</div><div class="v">‚Äî</div></div>
            <div class="kv"><div class="k">IFSC</div><div class="v">‚Äî</div></div>
            <div class="kv"><div class="k">UPI</div><div class="v">‚Äî</div></div>
        
          </div>
          <div class="form">
            <input id="dep-utr" type="text" placeholder="UTR / Reference Number" />
            <input id="dep-amount" type="number" min="1" placeholder="Amount ‚Çπ" />
          </div>
        </div>

        <!-- USDT È°µÈù¢ÔºàÂõ∫ÂÆö TRC20ÔºöÂú∞ÂùÄ + TXID + USDT Êï∞ÈáèÔºâ -->
        <div id="pane-usdt" class="dep-pane">
          <div class="form">
            <div class="muted" style="margin-bottom:6px">USDT (TRC20) Deposit Address-1USDT=100rs</div>
            <div class="addr-row">
              <input id="usdt-address" type="text" readonly placeholder="Loading address‚Ä¶" />
              <button id="copy-usdt" class="btn">Copy</button>
            </div>
            <div class="qr-hint">* Network is fixed to TRC20. Deposits on other chains will be lost.1USDT=100rs</div>

            <input id="usdt-txid" type="text" placeholder="TXID / Transaction Hash" />
            <input id="usdt-amount" type="number" min="0.01" step="0.01" placeholder="Amount (USDT)" />
          </div>
        </div>
      </div>
      <footer>
        <button id="dep-cancel" class="btn">Cancel</button>
        <button id="dep-submit" class="btn primary">Submit</button>
      </footer>
    </div>
  </div>

  <!-- ÊèêÊ¨æ ModalÔºàÂê´ÊâìÁ†ÅÈáèÊòæÁ§∫Ôºâ -->
  <div id="wd-modal" class="modal-bg">
    <div class="modal">
      <header>Withdraw</header>
      <div class="body">
        <div class="form">
          <div class="kv" id="rollover-kv"><div class="k">Rollover Needed</div><div class="v" id="rollover-val">0.00</div></div>

          <div class="row">
            <input id="w-name" placeholder="Your Name" />
            <input id="w-ac" placeholder="AC Number" />
          </div>
          <div class="row">
            <input id="w-ifsc" placeholder="IFSC Code" />
            <input id="w-upi" placeholder="UPI ID (optional)" />
          </div>
          <div class="row">
            <input id="wd-amount" type="number" min="1" placeholder="Amount ‚Çπ" />
            <button id="wd-save" class="btn">Save Profile</button>
          </div>
          <div class="muted">Save your bank profile first if you modified it.</div>
        </div>
      </div>
      <footer>
        <button id="wd-cancel" class="btn">Cancel</button>
        <button id="wd-submit" class="btn primary">Submit Withdrawal</button>
      </footer>
    </div>
  </div>

  <!-- Êñ∞Â¢ûÔºöMy Records Modal -->
  <div id="history-modal" class="modal-bg">
    <div class="modal">
      <header>My Records (Last 3 Days)</header>
      <div class="body">
        <div class="muted" style="margin-bottom:10px">Showing recent 3 days</div>

        <div style="margin-top:12px;display:grid;grid-template-columns:1fr;gap:16px">
          <!-- Â≠òÊ¨æËÆ∞ÂΩï -->
          <div>
            <div style="font-weight:700;margin:6px 0 8px 0">Deposits</div>
            <div class="card" style="border-radius:12px">
              <div class="inner" style="padding:0">
                <table>
                  <thead>
                    <tr>
                      <th>Time</th>
                      <th>UTR</th>
                      <th>Amount (‚Çπ)</th>
                      <th>Status</th>
                    </tr>
                  </thead>
                  <tbody id="deposits-tbody">
                    <tr><td colspan="4" class="muted" style="padding:14px">‚Äî</td></tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- ÊèêÊ¨æËÆ∞ÂΩï -->
          <div>
            <div style="font-weight:700;margin:6px 0 8px 0">Withdrawals</div>
            <div class="card" style="border-radius:12px">
              <div class="inner" style="padding:0">
                <table>
                  <thead>
                    <tr>
                      <th>Time</th>
                      <th>Amount (‚Çπ)</th>
                      <th>Status</th>
                    </tr>
                  </thead>
                  <tbody id="withdrawals-tbody">
                    <tr><td colspan="3" class="muted" style="padding:14px">‚Äî</td></tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

      </div>
      <footer>
        <button id="history-close" class="btn">Close</button>
      </footer>
    </div>
  </div>

  <!-- Êñ∞Â¢ûÔºö‰øÆÊîπÂØÜÁ†Å Modal -->
  <div id="chpass-modal" class="modal-bg">
    <div class="modal">
      <header>Change Password</header>
      <div class="body">
        <div class="form">
          <input id="old-pass" type="password" placeholder="Current Password" />
          <input id="new-pass" type="password" placeholder="New Password (min 6 chars)" />
          <input id="new-pass2" type="password" placeholder="Confirm New Password" />
          <div class="muted">We will verify your current password before updating.</div>
        </div>
      </div>
      <footer>
        <button id="chpass-cancel" class="btn">Cancel</button>
        <button id="chpass-submit" class="btn primary">Update Password</button>
      </footer>
    </div>
  </div>

  <script type="module">
    import { supabase } from './supabase-config.js';

    const $ = (id)=>document.getElementById(id);
    const show = (el,on=true)=> el.style.display = on ? 'flex' : 'none';
    const toast = (m)=>alert(m);
    const fmt2 = (n)=> Number(n ?? 0).toFixed(2);
    const fmtTime = (iso)=> {
      try{
        const d = new Date(iso);
        return d.toLocaleString(undefined,{ year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit' });
      }catch{ return iso || '‚Äî'; }
    };

    const openLogin = $('open-login');
    const logoutBtn = $('logout-btn');
    const userEmail = $('user-email');
    const balanceEl = $('balance');
    const vipBadge  = $('vip-badge');

    const loginModal = $('login-modal'), loginCancel = $('login-cancel'),
          signupBtn = $('signup-btn'), loginBtn = $('login-btn'),
          loginEmail = $('login-email'), loginPass = $('login-pass');

    const depModal = $('dep-modal'), depCancel = $('dep-cancel'), depSubmit = $('dep-submit'),
          depUtr = $('dep-utr'), depAmount = $('dep-amount'), depBank = $('dep-bank');

    const wdModal = $('wd-modal'), wdCancel = $('wd-cancel'), wdSubmit = $('wd-submit'),
          wName = $('w-name'), wAc = $('w-ac'), wIfsc = $('w-ifsc'), wUpi = $('w-upi'),
          wdAmount = $('wd-amount'), wdSave = $('wd-save'), rolloverVal = $('rollover-val');

    // My Records ÂºπÁ™óÂÖÉÁ¥†
    const historyModal = $('history-modal');
    const historyOpen = $('open-history');
    const historyClose = $('history-close');
    const depositsTbody = $('deposits-tbody');
    const withdrawalsTbody = $('withdrawals-tbody');

    // ‰øÆÊîπÂØÜÁ†Å
    const openChpass = $('open-chpass');
    const chpassModal = $('chpass-modal');
    const chpassCancel = $('chpass-cancel');
    const chpassSubmit = $('chpass-submit');
    const oldPass = $('old-pass'), newPass = $('new-pass'), newPass2 = $('new-pass2');

    // ==== Deposit channel switching (No Tabs) ====
    const btnINR   = $('btn-inr');
    const btnUSDT  = $('btn-usdt');
    const paneINR  = $('pane-inr');
    const paneUSDT = $('pane-usdt');
    const usdtAddr = $('usdt-address');
    const usdtCopy = $('copy-usdt');
    const usdtTxid = $('usdt-txid');
    const usdtAmount = $('usdt-amount');
    let depChannel = 'inr'; // 'inr' | 'usdt'

    $('open-deposit').onclick = async ()=>{
      // ÈªòËÆ§ÊòæÁ§∫ INR È°µÈù¢
      depChannel = 'inr';
      btnINR.classList.add('active'); btnUSDT.classList.remove('active');
      paneINR.classList.add('active'); paneUSDT.classList.remove('active');

      await loadBankInfoIntoDeposit(); // Â°´ÂÖÖ Name/AC/IFSC/UPI/USDT

      // ËØªÂèñ bank_info.crypto_address ‰Ωú‰∏∫ TRC20 Âú∞ÂùÄ
      try{
        const { data } = await supabase.from('bank_info').select('crypto_address').eq('id',1).maybeSingle();
        usdtAddr.value = data?.crypto_address || '';
        if(!usdtAddr.value) usdtAddr.placeholder = 'No TRC20 address configured';
      }catch{ usdtAddr.value = ''; }

      // Ê∏ÖÁ©∫ USDT È°µÈù¢ËæìÂÖ•
      usdtTxid.value = '';
      usdtAmount.value = '';

      show(depModal,true);
    };

    $('open-withdraw').onclick = async()=>{ await loadWithdrawProfileIntoModal(); show(wdModal,true); };
    openLogin.onclick = ()=> show(loginModal,true);
    loginCancel.onclick = ()=> show(loginModal,false);
    depCancel.onclick = ()=> show(depModal,false);
    wdCancel.onclick = ()=> show(wdModal,false);

    // My Records ÊâìÂºÄ/ÂÖ≥Èó≠
    historyOpen.onclick = async ()=>{ await loadRecentRecords(); show(historyModal, true); };
    historyClose.onclick = ()=> show(historyModal, false);

    // ÊâìÂºÄ/ÂÖ≥Èó≠‰øÆÊîπÂØÜÁ†Å
    openChpass.onclick = ()=> show(chpassModal, true);
    chpassCancel.onclick = ()=> show(chpassModal, false);

    // ÂàáÊç¢ÊåâÈíÆË°å‰∏∫
    btnINR.onclick = ()=>{
      depChannel = 'inr';
      btnINR.classList.add('active'); btnUSDT.classList.remove('active');
      paneINR.classList.add('active'); paneUSDT.classList.remove('active');
    };
    btnUSDT.onclick = ()=>{
      depChannel = 'usdt';
      btnUSDT.classList.add('active'); btnINR.classList.remove('active');
      paneUSDT.classList.add('active'); paneINR.classList.remove('active');
    };

    // Â§çÂà∂ USDT Âú∞ÂùÄ
    usdtCopy.onclick = async ()=>{
      try{
        if(usdtAddr.value){ await navigator.clipboard.writeText(usdtAddr.value); toast('Address copied'); }
      }catch{ toast('Copy failed'); }
    };

    let currentUser = null;
    function setAuthUI(loggedIn){
      $('open-login').style.display = loggedIn ? 'none' : '';
      logoutBtn.style.display = loggedIn ? '' : 'none';
    }

    // ÁôªÂΩï/Ê≥®ÂÜå
    signupBtn.onclick = async ()=>{
      const email = loginEmail.value.trim(), pass = loginPass.value;
      if(!email || !pass) return toast('Enter email & password');
      const { error } = await supabase.auth.signUp({ email, password: pass });
      if (error) return toast(error.message);
      toast('‚úÖ Signup success. Now login.');
    };
    loginBtn.onclick = async ()=>{
      const email = loginEmail.value.trim(), pass = loginPass.value;
      if(!email || !pass) return toast('Enter email & password');
      const { data, error } = await supabase.auth.signInWithPassword({ email, password: pass });
      if (error) return toast('Login failed: ' + error.message);
      currentUser = data.user;
      show(loginModal,false);
      await afterLogin();
    };
    logoutBtn.onclick = async ()=>{
      await supabase.auth.signOut();
      currentUser = null; userEmail.textContent = '‚Äî'; balanceEl.textContent = '0'; vipBadge.textContent='VIP 0'; setAuthUI(false);
      // Ê∏ÖÁ©∫ËÆ∞ÂΩïË°®
      depositsTbody.innerHTML = `<tr><td colspan="4" class="muted" style="padding:14px">‚Äî</td></tr>`;
      withdrawalsTbody.innerHTML = `<tr><td colspan="3" class="muted" style="padding:14px">‚Äî</td></tr>`;
    };

    async function afterLogin(){
      setAuthUI(true);
      userEmail.textContent = currentUser.email || '‚Äî';
      await supabase.from('users').upsert([{ id: currentUser.id, email: currentUser.email }]);
      await refreshUserSummary();
    }
    async function refreshUserSummary(){
      const { data } = await supabase.from('users')
        .select('balance, vip_level')
        .eq('id', currentUser.id).single();
      balanceEl.textContent = data?.balance ?? 0;
      vipBadge.textContent = `VIP ${Number(data?.vip_level ?? 0)}`;
    }

    async function loadBankInfoIntoDeposit(){
      const { data } = await supabase.from('bank_info').select('*').eq('id', 1).maybeSingle();
      const items = [
        ['Name', data?.name], ['AC', data?.ac], ['IFSC', data?.ifsc],
        ['UPI', data?.upi], ['Crypto', data?.crypto_address]
      ];
      document.getElementById('dep-bank').innerHTML = items.map(([k,v])=>`
        <div class="kv"><div class="k">${k}</div><div class="v">${v || '‚Äî'}</div></div>
      `).join('');
    }

    async function loadWithdrawProfileIntoModal(){
      const { data } = await supabase.from('users')
        .select('name,ac,ifsc,upi,turnover_remaining')
        .eq('id', currentUser.id).single();
      $('w-name').value = data?.name || '';
      $('w-ac').value   = data?.ac || '';
      $('w-ifsc').value = data?.ifsc || '';
      $('w-upi').value  = data?.upi || '';
      $('wd-amount').value = '';
      $('rollover-val').textContent = fmt2(data?.turnover_remaining);
    }

    // Êèê‰∫§ÔºöÊ†πÊçÆÈÄöÈÅìÂàÜÂà´Ê†°È™å‰∏éÂÜôÂÖ•ÔºàÂÖºÂÆπ‰Ω†Áé∞ÊúâË°®ÁªìÊûÑÔºâ
    depSubmit.onclick = async ()=>{
      if (!currentUser) return toast('Please login first');

      try{
        let utrStr = '';
        let amtNum = 0;

        if (depChannel === 'inr') {
          const utr = $('dep-utr').value.trim();
          const amountInr = Number($('dep-amount').value);
          if(!utr || !amountInr || amountInr <= 0) return toast('Enter UTR & amount');
          utrStr = `[INR] ${utr}`;
          amtNum = amountInr;
        } else {
          // Âõ∫ÂÆö TRC20
          const addr = String(usdtAddr.value||'').trim();
          const txid = String(usdtTxid.value||'').trim();
          const amt  = Number(usdtAmount.value);
          if(!addr) return toast('No TRC20 address configured');
          if(!txid) return toast('Enter transaction hash (TXID)');
          if(!amt || amt <= 0) return toast('Enter USDT amount');

          utrStr = `[USDT-TRC20] ${txid}`;
          amtNum = amt; // Áõ¥Êé•Â≠ò USDT Êï∞Èáè
        }

        const { error } = await supabase.from('recharge_requests').insert([{
          user_id: currentUser.id,
          email: currentUser.email,
          utr: utrStr,
          amount: amtNum,
          status: 'pending'
        }]);
        if (error) return toast('Submit failed: ' + error.message);

        // ÊàêÂäüÂêéÊ∏ÖÁ©∫Âπ∂ÂÖ≥Èó≠
        $('dep-utr').value=''; $('dep-amount').value='';
        usdtTxid.value=''; usdtAmount.value='';
        show(depModal,false);
        toast('‚úÖ Recharge request submitted.');

        if (historyModal.style.display === 'flex') await loadRecentRecords();
      }catch(e){
        toast('Submit failed: ' + (e?.message || e));
      }
    };

    $('wd-save').onclick = async ()=>{
      if (!currentUser) return toast('Please login first');
      const payload = { name:$('w-name').value.trim(), ac:$('w-ac').value.trim(), ifsc:$('w-ifsc').value.trim(), upi:$('w-upi').value.trim() };
      if (!payload.name || !payload.ac || !payload.ifsc) return toast('Fill Name / AC / IFSC');
      const { error } = await supabase.from('users').update(payload).eq('id', currentUser.id);
      if (error) return toast('Save failed: ' + error.message);
      toast('‚úÖ Profile saved.');
    };

    wdSubmit.onclick = async ()=>{
      if (!currentUser) return toast('Please login first');
      const amount = Number($('wd-amount').value);
      if (!amount || amount <= 0) return toast('Enter amount');

      if (!$('w-name').value.trim() || !$('w-ac').value.trim() || !$('w-ifsc').value.trim()) {
        return toast('Please complete withdrawal profile (Name / AC / IFSC).');
      }

      const { data: u } = await supabase.from('users')
        .select('turnover_remaining').eq('id', currentUser.id).single();
      const need = Number(u?.turnover_remaining || 0);
      if (need > 0) {
        return toast(`Rollover not met: ‚Çπ${fmt2(need)} remaining`);
      }

      const { error } = await supabase.rpc('request_withdraw', {
        _user_id: currentUser.id,
        _email: currentUser.email,
        _amount: amount
      });
      if (error) {
        if (String(error.message).includes('TURNOVER_NOT_MET')) {
          return toast('Rollover not met. Please continue betting.');
        }
        return toast('Submit failed: ' + error.message);
      }

      show(wdModal,false);
      toast('‚úÖ Withdraw request submitted.');
      if (historyModal.style.display === 'flex') await loadRecentRecords();
    };

    // Âä†ËΩΩÊúÄËøë 3 Â§©Â≠òÊèêËÆ∞ÂΩïÔºà‰æõÂºπÁ™ó‰ΩøÁî®Ôºâ
    async function loadRecentRecords(){
      if(!currentUser){ return; }
      const since = new Date(Date.now() - 3*24*60*60*1000).toISOString();

      // Â≠òÊ¨æËÆ∞ÂΩïÔºörecharge_requests
      const { data: dep, error: depErr } = await supabase
        .from('recharge_requests')
        .select('created_at, utr, amount, status')
        .eq('user_id', currentUser.id)
        .gte('created_at', since)
        .order('created_at', { ascending: false })
        .limit(100);
      if (depErr) {
        depositsTbody.innerHTML = `<tr><td colspan="4" class="muted" style="padding:14px">Load failed: ${depErr.message}</td></tr>`;
      } else if (!dep || dep.length === 0){
        depositsTbody.innerHTML = `<tr><td colspan="4" class="muted" style="padding:14px">No records in last 3 days</td></tr>`;
      } else {
        depositsTbody.innerHTML = dep.map(r => `
          <tr>
            <td>${fmtTime(r.created_at)}</td>
            <td>${r.utr ?? '‚Äî'}</td>
            <td>${fmt2(r.amount)}</td>
            <td><span class="tag ${String(r.status).toLowerCase()}">${r.status}</span></td>
          </tr>
        `).join('');
      }

      // ÊèêÊ¨æËÆ∞ÂΩïÔºöwithdraw_requests
      const { data: wd, error: wdErr } = await supabase
        .from('withdraw_requests')
        .select('created_at, amount, status')
        .eq('user_id', currentUser.id)
        .gte('created_at', since)
        .order('created_at', { ascending: false })
        .limit(100);
      if (wdErr) {
        withdrawalsTbody.innerHTML = `<tr><td colspan="3" class="muted" style="padding:14px">Load failed: ${wdErr.message}</td></tr>`;
      } else if (!wd || wd.length === 0){
        withdrawalsTbody.innerHTML = `<tr><td colspan="3" class="muted" style="padding:14px">No records in last 3 days</td></tr>`;
      } else {
        withdrawalsTbody.innerHTML = wd.map(r => `
          <tr>
            <td>${fmtTime(r.created_at)}</td>
            <td>${fmt2(r.amount)}</td>
            <td><span class="tag ${String(r.status).toLowerCase()}">${r.status}</span></td>
          </tr>
        `).join('');
      }
    }

    // ‰øÆÊîπÂØÜÁ†Å
    chpassSubmit.onclick = async ()=>{
      try{
        if (!currentUser) return toast('Please login first');
        const email = currentUser.email;
        const oldP = $('old-pass').value, np = $('new-pass').value, np2 = $('new-pass2').value;
        if (!oldP || !np || !np2) return toast('Fill all fields');
        if (np.length < 6) return toast('New password must be at least 6 characters');
        if (np !== np2) return toast('New passwords do not match');

        const { error: reauthErr } = await supabase.auth.signInWithPassword({ email, password: oldP });
        if (reauthErr) return toast('Current password is incorrect');

        const { error: updErr } = await supabase.auth.updateUser({ password: np });
        if (updErr) return toast('Update failed: ' + updErr.message);

        $('old-pass').value = $('new-pass').value = $('new-pass2').value = '';
        show(chpassModal, false);
        toast('‚úÖ Password updated');
      }catch(e){
        toast('Update failed: ' + (e?.message || e));
      }
    };

    (async ()=>{
      const { data:{ user } } = await supabase.auth.getUser();
      if (user){ currentUser=user; await afterLogin(); } else { setAuthUI(false); }
    })();
  </script>
</body>
</html>
