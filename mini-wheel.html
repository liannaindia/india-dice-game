<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>Mini Wheel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <script type="module" src="./supabase-config.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg1:#fff7ec; --bg2:#e6f2ff; --card:#fff; --text:#222;
      --muted:#667085; --primary:#0d6efd; --primary-pressed:#0b5ed7;
      --success:#16a34a; --line:#e6eaf2;
      --radius:14px; --shadow:0 6px 18px rgba(0,0,0,.08);
      --wheel-size: 320px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:'Poppins',sans-serif;color:var(--text);
      background:linear-gradient(180deg,var(--bg1),var(--bg2));padding-bottom:94px;overflow-x:hidden}
    .container{max-width:860px;margin:0 auto;padding:16px 16px calc(16px + env(safe-area-inset-bottom))}
    h2{margin:6px 0 14px;text-align:center;color:#ff6f00}

    .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);
      padding:14px;margin-bottom:14px;border:1px solid var(--line)}
    .userbar{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
    .balance{font-weight:700;color:var(--success)}
    .btn{display:inline-flex;align-items:center;justify-content:center;padding:10px 14px;border-radius:12px;border:0;cursor:pointer;background:var(--primary);color:#fff;font-weight:700;min-height:42px}
    .btn:active{background:var(--primary-pressed)}
    .btn.secondary{background:#eef4ff;color:#1e3a8a}
    .btn.ghost{background:#fff;color:#111;border:1px solid var(--line)}
    .muted{color:var(--muted);font-size:12px}
    .result-box{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;text-align:center}
    .result-big{font-size:28px;font-weight:800}
    .betbar{position:fixed;left:0;right:0;bottom:0;padding:10px 12px calc(10px + env(safe-area-inset-bottom));
      background:rgba(255,255,255,.85);backdrop-filter: blur(10px);border-top:1px solid #e8edf6;display:flex;gap:10px;align-items:center}
    .betbar input{flex:1;height:46px;border-radius:12px;border:1px solid #e1e6f0;padding:0 12px;font-size:16px;background:#fff}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px 6px;border-bottom:1px solid #eee;font-size:14px;text-align:left}

    /* ===== Wheel ===== */
    .wheel-wrap{display:flex;align-items:center;justify-content:center;margin-top:8px}
    .wheel-box{position:relative;width:var(--wheel-size);height:var(--wheel-size);border-radius:50%;
      background:#f7f9fc;border:1px solid #e6eaf2;display:flex;align-items:center;justify-content:center}
    .wheel-shadow{position:absolute;inset:10px;border-radius:50%;box-shadow:inset 0 0 0 8px #fff, 0 10px 24px rgba(0,0,0,.08)}
    .wheel-svg{width:calc(var(--wheel-size) - 28px);height:calc(var(--wheel-size) - 28px)}
    .wheel-rot{} /* JS é©±åŠ¨æ—‹è½¬ */
    .pointer{
      position:absolute; top:-6px; left:50%; transform:translateX(-50%);
      width:0;height:0; border-left:10px solid transparent;border-right:10px solid transparent;
      border-top:18px solid #0d6efd;
      filter:drop-shadow(0 3px 6px rgba(13,110,253,.35));
    }
    .win-banner{margin-top:10px;padding:10px;border-radius:12px;background:#ecfdf5;border:1px solid #a7f3d0;color:#047857;font-weight:700;display:none}
    .win-banner.show{display:block}

    /* ä¸‹æ³¨åŒº */
    .section-title{font-weight:700;margin:0 0 8px}
    .chip{padding:10px 12px;text-align:center;border-radius:12px;background:#f7f9fc;border:1px solid #e6eaf2;font-weight:700;cursor:pointer}
    .chip.active{background:#eaf2ff;border-color:#cfe0ff;color:#0b5ed7}
    .seg{display:flex;flex-wrap:wrap;gap:8px}
    .numgrid{display:grid;grid-template-columns:repeat(8, 1fr);gap:8px}
    .cell{padding:10px 0;border-radius:10px;border:1px solid #e6eaf2;background:#fff;text-align:center;font-weight:700;cursor:pointer}
    .cell.active{background:#eaf2ff;border-color:#cfe0ff;color:#0b5ed7}

    @media (max-width: 820px){
      :root{ --wheel-size: 280px; }
      .result-box{ grid-template-columns:1fr; gap:8px; }
      .container{ padding:12px 10px calc(120px + env(safe-area-inset-bottom)); }
      table{ min-width: 520px; }
      th, td{ font-size:12px; }
      .numgrid{grid-template-columns:repeat(8, 1fr)}
    }
    @media (max-width: 420px){
      :root{ --wheel-size: 250px; }
      .numgrid{grid-template-columns:repeat(4, 1fr)}
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>ğŸ¡ Mini Wheel</h2>

    <div class="card">
      <div class="userbar">
        <div>
          <div class="muted">Logged in as</div>
          <div id="user-email" style="font-weight:700">â€”</div>
        </div>
        <div class="balance">â‚¹<span id="balance">0</span></div>
        <div class="userbar-right">
          <button id="lobby-btn" class="btn ghost">Lobby</button>
          <button id="logout-btn" class="btn secondary">Logout</button>
        </div>
      </div>
      <div class="muted" style="margin-top:8px">* æ¯å±€ 2 åˆ†é’Ÿï¼ˆISTï¼‰ï¼Œæœ€å 10 ç§’é”ç›˜ã€‚å‰ç«¯åªç”¨æœåŠ¡å™¨çš„ wheel_stateã€‚</div>
    </div>

    <div class="card">
      <h3 class="section-title">ğŸ¯ ä¸‹æ³¨</h3>
      <div class="seg" id="range-seg">
        <div class="chip" data-range="small">Small 3â€“10 Ã—1.9</div>
        <div class="chip" data-range="big">Big 11â€“18 Ã—1.9</div>
      </div>
      <div style="margin-top:10px"></div>
      <div class="numgrid" id="num-grid"></div>

      <div class="seg" id="quick-amt" style="margin-top:10px">
        <div class="chip" data-v="100">â‚¹100</div>
        <div class="chip" data-v="200">â‚¹200</div>
        <div class="chip" data-v="500">â‚¹500</div>
        <div class="chip" data-v="1000">â‚¹1000</div>
      </div>
    </div>

    <div class="card">
      <div class="result-box">
        <div>
          <div class="muted">Round</div>
          <div id="round-number" style="font-weight:700">â€”</div>
        </div>
        <div>
          <div class="muted">Prev Result</div>
          <div id="prev-result" class="result-big">â€”</div>
        </div>
        <div>
          <div class="muted">Time Left</div>
          <div id="countdown" style="font-weight:700">â€”</div>
        </div>
      </div>

      <div class="wheel-wrap">
        <div class="wheel-box">
          <div class="wheel-shadow"></div>
          <div class="pointer"></div>
          <svg class="wheel-svg" viewBox="-150 -150 300 300" aria-hidden="true">
            <g id="wheelG" class="wheel-rot"></g>
            <circle cx="0" cy="0" r="18" fill="#fff" stroke="#e6eaf2"/>
          </svg>
        </div>
      </div>
      <div id="win-banner" class="win-banner"></div>
    </div>

    <div class="card">
      <h3 style="margin:0 0 8px">ğŸ§¾ æˆ‘æœ€è¿‘çš„ 10 ç¬”</h3>
      <div style="overflow:auto">
        <table>
          <thead><tr><th>Round</th><th>Bet</th><th>Amount</th><th>Result</th><th>Status</th><th>Payout</th></tr></thead>
          <tbody id="bets-tbody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="betbar">
    <input type="number" id="bet-amount" placeholder="Amount â‚¹" inputmode="decimal" />
    <button id="bet-btn" class="btn">Submit Bet</button>
  </div>

<script type="module">
import { supabase } from './supabase-config.js';

/* ===== æ•°å­—ä¸èµ”ç‡ï¼ˆ3..18ï¼‰ ===== */
const NUMBERS = Array.from({length:16}, (_,i)=>i+3);
const ODDS_MAP = new Map([
  [3,180],[18,180],[4,60],[17,60],[5,30],[16,30],
  [6,18],[15,18],[7,12],[14,12],[8,9],[13,9],
  [9,8],[12,8],[10,7],[11,7],
]);
const COLORS_BY_ODDS = new Map([
  [180,'#fff3b0'], [60,'#ffe5e5'], [30,'#eae8ff'],
  [18,'#fff5e5'], [12,'#eafaf2'], [9,'#e9f2ff'],
  [8,'#eef6ff'],  [7,'#f7f9fc']
]);
const TEXT_BY_ODDS = new Map([
  [180,'#8d6a00'], [60,'#b91c1c'], [30,'#5b46d6'],
  [18,'#c86400'], [12,'#117a40'], [9,'#0b5ed7'],
  [8,'#0b5ed7'],  [7,'#3b4a66']
]);

/* ===== DOM ===== */
let currentUser = null;
let selectedNumber = null;  // 3..18
let selectedRange  = null;  // 'small' | 'big'

const emailEl = document.getElementById('user-email');
const balanceEl = document.getElementById('balance');
const logoutBtn = document.getElementById('logout-btn');
const lobbyBtn  = document.getElementById('lobby-btn');
const betBtn = document.getElementById('bet-btn');
const betAmountEl = document.getElementById('bet-amount');

const roundEl = document.getElementById('round-number');
const prevEl  = document.getElementById('prev-result');
const countEl = document.getElementById('countdown');
const betsTbody = document.getElementById('bets-tbody');

const wheelG = document.getElementById('wheelG');
const winBanner = document.getElementById('win-banner');

/* ===== åªç”¨æœåŠ¡å™¨ wheel_state ===== */
let STATE = null;
let leftAtSyncSec = 0;      // åŒæ­¥ç¬é—´çš„ seconds_left
let syncLocalMs   = 0;      // æœ¬åœ°åŒæ­¥æ—¶é—´
let lastShownRound = null;  // å·²å±•ç¤ºè¿‡çš„ä¸Šä¸€æœŸï¼ˆé¿å…é‡å¤ï¼‰

/* ===== è½®ç›˜ç»˜åˆ¶ä¸åŠ¨ç”» ===== */
const N = NUMBERS.length;
const THETA = 2*Math.PI / N;
let currentRotation = 0; // deg
let rolling = false, rollingRAF = null, rollingForRound = null;

function polar(r, ang){ return [r*Math.cos(ang), r*Math.sin(ang)]; }
function buildWheelSVG(){
  wheelG.innerHTML = '';
  for(let i=0;i<N;i++){
    const num = NUMBERS[i];
    const odds = ODDS_MAP.get(num);
    const a1 = i*THETA - Math.PI/2;
    const a2 = (i+1)*THETA - Math.PI/2;
    const [x1,y1] = polar(135, a1);
    const [x2,y2] = polar(135, a2);

    const path = document.createElementNS('http://www.w3.org/2000/svg','path');
    path.setAttribute('d', `M 0 0 L ${x1.toFixed(3)} ${y1.toFixed(3)} A 135 135 0 0 1 ${x2.toFixed(3)} ${y2.toFixed(3)} Z`);
    path.setAttribute('fill', COLORS_BY_ODDS.get(odds) || '#eee');
    path.setAttribute('stroke', '#e6eaf2');
    path.setAttribute('stroke-width', '1');
    wheelG.appendChild(path);

    const mid = (a1+a2)/2;
    const [tx,ty] = polar(85, mid);
    const text = document.createElementNS('http://www.w3.org/2000/svg','text');
    text.setAttribute('x', tx.toFixed(1));
    text.setAttribute('y', ty.toFixed(1));
    text.setAttribute('fill', TEXT_BY_ODDS.get(odds) || '#333');
    text.setAttribute('font-size', '16');
    text.setAttribute('font-weight', '700');
    text.setAttribute('text-anchor', 'middle');
    text.setAttribute('dominant-baseline', 'middle');
    text.textContent = `${num}`;
    wheelG.appendChild(text);
  }
  wheelG.setAttribute('transform', `rotate(${currentRotation} 0 0)`);
}
function setWheelToIndex(idx){
  const segCenterDeg = (idx + 0.5) * (360 / N);
  currentRotation = ((-segCenterDeg % 360) + 360) % 360;
  wheelG.setAttribute('transform', `rotate(${currentRotation} 0 0)`);
}
function startRolling(roundId){
  if (rolling && rollingForRound === roundId) return;
  stopRolling();
  rolling = true; rollingForRound = roundId;
  let last = performance.now();
  const speed = 360 * 1.2; // deg/s
  const loop = (now)=>{
    if (!rolling) return;
    const dt = (now - last)/1000; last = now;
    currentRotation = (currentRotation + speed*dt) % 360;
    wheelG.setAttribute('transform', `rotate(${currentRotation} 0 0)`);
    rollingRAF = requestAnimationFrame(loop);
  };
  rollingRAF = requestAnimationFrame(loop);
}
function stopRolling(){
  rolling = false;
  if (rollingRAF) cancelAnimationFrame(rollingRAF);
  rollingRAF = null;
}
function settleToIndex(idx){
  stopRolling();
  winBanner.classList.remove('show');
  const segCenterDeg = (idx + 0.5) * (360 / N);
  let targetDeg = -segCenterDeg;
  while (targetDeg - currentRotation < 720) targetDeg += 360; // è‡³å°‘ä¸¤åœˆ
  const start = performance.now();
  const ease = t => 1 - Math.pow(1 - t, 3);
  const step = (now)=>{
    const t = Math.min(1, (now - start)/1500);
    const ang = currentRotation + (targetDeg - currentRotation) * ease(t);
    wheelG.setAttribute('transform', `rotate(${ang} 0 0)`);
    if (t < 1) requestAnimationFrame(step);
    else {
      currentRotation = ((targetDeg % 360)+360)%360;
      wheelG.setAttribute('transform', `rotate(${currentRotation} 0 0)`);
    }
  };
  requestAnimationFrame(step);
}

/* ===== æœåŠ¡å™¨çŠ¶æ€ ===== */
async function fetchState(){
  const { data, error } = await supabase.rpc('wheel_state');
  if (error || !data || !data[0]) return false;

  const s = data[0];
  STATE = s;

  // ä»¥æœåŠ¡å™¨ seconds_left ä¸ºé”šç‚¹ï¼Œåœ¨æœ¬åœ°å‡ç§’ï¼Œä¸å†è§£ææ—¶é—´å­—ç¬¦ä¸²
  leftAtSyncSec = Number.isFinite(s.seconds_left) ? s.seconds_left : 0;
  syncLocalMs = Date.now();

  // UI
  roundEl.textContent = s.current_round || 'â€”';
  if (s.last_result_number != null) {
    prevEl.textContent = `${s.last_result_number} (${s.last_result_multiplier}Ã—)`;
  }

  return true;
}
function leftNow(){
  const elapsed = Math.floor((Date.now() - syncLocalMs)/1000);
  return Math.max(0, leftAtSyncSec - elapsed);
}
function updateCountdown(){
  if (!STATE) { countEl.textContent = 'â€”'; return; }
  const left = leftNow();
  countEl.textContent = `${left}s`;
  if (STATE.locked || left <= 10) {
    betBtn.disabled = true; betBtn.textContent = 'Bet Closed';
  } else {
    betBtn.disabled = false; betBtn.textContent = 'Submit Bet';
  }
}
async function tick(){
  const ok = await fetchState();
  if (!ok) return;

  updateCountdown();

  const left = leftNow();
  if (left <= 5) startRolling(STATE.current_round);
  else stopRolling();

  if (STATE.last_round && lastShownRound !== STATE.last_round && STATE.last_result_index != null){
    settleToIndex(STATE.last_result_index);
    winBanner.textContent = `WIN â€” ${STATE.last_result_number} â€¢ ${STATE.last_result_multiplier}Ã—`;
    winBanner.classList.add('show');
    lastShownRound = STATE.last_round;
    await loadBalance();
    await loadMyBets();
  }
}
function startTicker(){
  setInterval(tick, 1500);      // åŒæ­¥æœåŠ¡å™¨çŠ¶æ€
  setInterval(updateCountdown, 250); // æœ¬åœ°æ˜¾ç¤ºå¹³æ»‘
}

/* ===== Auth & åˆå§‹åŒ– ===== */
logoutBtn.onclick = async ()=>{ await supabase.auth.signOut(); location.href='./index.html'; };
lobbyBtn.onclick = ()=> location.href='./index.html';

supabase.auth.getUser().then(async ({ data }) => {
  if (!data?.user) { alert('Please login first.'); location.href = './index.html'; return; }
  currentUser = data.user;
  emailEl.textContent = currentUser.email;

  await supabase.from('users').upsert([{ id: currentUser.id, email: currentUser.email }]);
  await loadBalance();
  buildBetUI();
  buildWheelSVG();

  await fetchState();
  updateCountdown();
  startTicker();

  await loadMyBets();
});

/* ===== ä¸‹æ³¨åŒº ===== */
function buildBetUI(){
  document.getElementById('quick-amt').querySelectorAll('.chip').forEach(q=>{
    q.onclick = ()=>{ betAmountEl.value = Number(q.dataset.v); };
  });

  const seg = document.getElementById('range-seg');
  seg.querySelectorAll('.chip').forEach(ch=>{
    ch.onclick = ()=>{
      selectedRange = ch.dataset.range; selectedNumber = null;
      seg.querySelectorAll('.chip').forEach(x=>x.classList.remove('active'));
      ch.classList.add('active');
      document.querySelectorAll('#num-grid .cell').forEach(x=>x.classList.remove('active'));
    };
  });

  const grid = document.getElementById('num-grid');
  grid.innerHTML = '';
  NUMBERS.forEach(n=>{
    const odds = ODDS_MAP.get(n);
    const cell = document.createElement('div');
    cell.className = 'cell';
    cell.innerHTML = `<div>${n}</div><div class="muted" style="font-size:12px">${odds}Ã—</div>`;
    cell.onclick = ()=>{
      selectedNumber = n; selectedRange = null;
      document.querySelectorAll('#range-seg .chip').forEach(x=>x.classList.remove('active'));
      grid.querySelectorAll('.cell').forEach(x=>x.classList.remove('active'));
      cell.classList.add('active');
    };
    grid.appendChild(cell);
  });
}

/* ===== ä½™é¢ & ä¸‹æ³¨è®°å½• ===== */
async function loadBalance(){
  const { data } = await supabase.from('users').select('balance').eq('id', currentUser.id).single();
  balanceEl.textContent = data?.balance ?? 0;
}
async function loadMyBets(){
  if (!currentUser) return;
  const { data, error } = await supabase.rpc('wheel_my_last_bets', {
    _user_id: currentUser.id,
    _limit: 10
  });
  if (error) {
    console.error('loadMyBets error:', error);
    betsTbody.innerHTML = `<tr><td colspan="6" class="muted">Load failed.</td></tr>`;
    return;
  }
  const rows = data || [];
  betsTbody.innerHTML = rows.length ? rows.map(b=>{
    const betLabel = b.bet_type === 'range'
      ? (b.pick === 0 ? 'Small 3â€“10 Ã—1.9' : 'Big 11â€“18 Ã—1.9')
      : (b.bet_type === 'number' ? `${b.pick} Ã—${ODDS_MAP.get(b.pick)}` : `${b.multiplier}Ã—`);
    const resLabel = (b.result_number!=null && b.result_multiplier!=null)
      ? `${b.result_number} (${b.result_multiplier}Ã—)` : 'â€”';
    const rn = String(b.round_number||'').slice(0,12);
    return `<tr>
      <td>${rn}</td>
      <td>${betLabel}</td>
      <td>â‚¹${Number(b.amount).toFixed(2)}</td>
      <td>${resLabel}</td>
      <td>${b.status}</td>
      <td>â‚¹${Number(b.payout||0).toFixed(2)}</td>
    </tr>`;
  }).join('') : `<tr><td colspan="6" class="muted">No recent bets.</td></tr>`;
}

/* ===== ä¸‹å•ï¼ˆæœåŠ¡å™¨é”ç›˜ä¸ºå‡†ï¼›å‚æ•°åä¿æŒä½ ç°æœ‰çš„ä¸‹åˆ’çº¿ç‰ˆæœ¬ï¼‰ ===== */
let placing = false;
betBtn.onclick = async () => {
  if (!currentUser) { alert('Please login first'); return; }
  if (placing) return;

  let _bet_type = null, _pick = null, _multiplier = null;
  if (selectedRange){
    _bet_type = 'range';
    _pick = (selectedRange === 'small') ? 0 : 1; // 0=small(3â€“10), 1=big(11â€“18)
    _multiplier = 1.9;
  } else if (selectedNumber != null){
    _bet_type = 'number';
    _pick = selectedNumber;
    _multiplier = ODDS_MAP.get(_pick);
    if (!_multiplier){ alert('Pick a valid number'); return; }
  } else {
    alert('Please choose Small/Big or a Number'); return;
  }

  const _amount = Number(betAmountEl.value);
  if (!Number.isFinite(_amount) || _amount <= 0) { alert('Enter amount'); return; }

  // ä¸‹å•å‰ï¼šå†æ‹‰ä¸€æ¬¡çŠ¶æ€ï¼Œå®Œå…¨æŒ‰æœåŠ¡å™¨ç§’æ•°ä¸ locked åˆ¤æ–­
  const ok = await fetchState();
  if (!ok) { alert('Server state unavailable'); return; }
  if (STATE?.locked || leftNow() <= 10) { alert('Bet closed'); return; }

  placing = true;
  const oldText = betBtn.innerText;
  betBtn.disabled = true;
  betBtn.innerText = 'Placing...';

  try {
    const { error } = await supabase.rpc('wheel_place_bet_ist', {
      _user_id: currentUser.id,
      _email: currentUser.email,
      _bet_type,      // 'number' | 'range'
      _pick,          // 3..18 æˆ– 0/1
      _amount,        // é‡‘é¢
      _multiplier     // èµ”ç‡
    });

    if (error) {
      const msg = String(error.message || '');
      if (msg.includes('INSUFFICIENT') || msg.toLowerCase().includes('insufficient')) alert('Insufficient balance');
      else if (msg.includes('CLOSED') || msg.toLowerCase().includes('locked')) alert('Bet closed');
      else alert('Bet failed: ' + msg);
      return;
    }

    betAmountEl.value = '';
    await loadBalance();
    await loadMyBets();
    alert('âœ… Bet placed!');
  } catch (e) {
    alert('Bet failed: ' + (e?.message || e));
  } finally {
    placing = false;
    betBtn.disabled = false;
    betBtn.innerText = oldText;
  }
};
</script>
</body>
</html>
